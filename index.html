<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="抬头看路，低头拉车！"/>













  <link rel="alternate" href="/default" title="WangBinZhou">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://blog.wangbinzhou.com/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3c05068834beb5df940fd3ca767f2305";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-106402527-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> WangBinZhou </title>
  <link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">WangBinZhou</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">WangBinZhou</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/10/27/Nginx/">Nginx</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-10-27
        </span>
        
          <div class="post-category">
            
              <a href="/categories/nginx/">nginx</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="Nginx介绍"><a href="#Nginx介绍" class="headerlink" title="Nginx介绍"></a>Nginx介绍</h4><p>Nginx（发音同engine x）是一个 Web服务器，也可以用作反向代理，负载平衡器和 HTTP缓存。该软件由 Igor Sysoev 创建，并于2004年首次公开发布。同名公司成立于2011年，以提供支持。Nginx 是免费的开源软件，根据类似 BSD许可证的条款发布。大部分 Web服务器通常使用 NGINX 作为负载均衡器。  </p>
<h5 id="Nginx的特性"><a href="#Nginx的特性" class="headerlink" title="Nginx的特性"></a>Nginx的特性</h5><ul>
<li>高可靠性  </li>
<li>支持热部署：不停机更新配置文件，升级版本，更换日志文件  </li>
<li>低内存消耗：10000个keep-alive连接模式下的非活动连接，仅需要2.5M内存  </li>
<li>event-driven, aio, mmap, sendfile  </li>
</ul>
<h5 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h5><ul>
<li>静态资源的web服务器  <ul>
<li>HTML, 图片, js, css, txt等静态资源</li>
</ul>
</li>
<li>http协议反向代理服务器  </li>
<li>pop3/IMAP4协议反向代理服务器  </li>
<li>结合FastCGI(LNMP)/uWSGI(Python)/SCGI等协议反向代理动态资源请求    </li>
<li>TCP/UDP协议的请求转发(反向代理)  </li>
</ul>
<h5 id="WEB服务的相关功能"><a href="#WEB服务的相关功能" class="headerlink" title="WEB服务的相关功能"></a>WEB服务的相关功能</h5><ul>
<li>虚拟机（Server）  </li>
<li>支持Keep-alive和管道连接  </li>
<li>访问日志（支持基于日志缓冲提高性能）  </li>
<li>Url Rewirte  </li>
<li>路径别名  </li>
<li>基于IP及用户的访问控制  </li>
<li>支持速率限制及并发数限制  </li>
<li>重新配置和在线升级而无须终端客户的工作进程  </li>
<li>Memcached 的GET接口  </li>
</ul>
<h5 id="Nginx的程序架构"><a href="#Nginx的程序架构" class="headerlink" title="Nginx的程序架构"></a>Nginx的程序架构</h5><p><img src="http://ovnpik36u.bkt.clouddn.com/201710/nginx/NginxFramework.png" alt="image"><br><strong>Nginx的程序架构</strong><br>Master/Worker结构  </p>
<ul>
<li>一个Maser进程负责加载和分析配置文件、管理worker进程、平滑升级  </li>
<li>一个或多个worker进程处理并响应用户请求  </li>
<li>缓存相关的进程：  <ul>
<li>cache loader:载入缓存对象  </li>
<li>cache manager：管理缓存对象  </li>
</ul>
</li>
</ul>
<h5 id="Nginx模块"><a href="#Nginx模块" class="headerlink" title="Nginx模块"></a>Nginx模块</h5><p>nginx高度模块化，但其模块早期不支持DSO机制； 1.9.11版本支持动态装载和卸载  </p>
<h6 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h6><ul>
<li>核心模块：Core module  </li>
<li>标准模块：  <ul>
<li>HTTP模块：ngx<em>http</em>*<ul>
<li>HTTP Core modules 默认功能  </li>
<li>HTTP Optional modules 需编译时指定  </li>
</ul>
</li>
<li>Mail模块：ngx<em>mail</em>*  </li>
<li>Stream模块：ngx<em>stream</em>*  </li>
</ul>
</li>
<li>第三方模块  </li>
</ul>
<h4 id="Nginx的安装"><a href="#Nginx的安装" class="headerlink" title="Nginx的安装"></a>Nginx的安装</h4><h5 id="官方"><a href="#官方" class="headerlink" title="官方"></a>官方</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://nginx.org/packages/centos/7/x86_64/RPMS</div></pre></td></tr></table></figure>
<h5 id="Fedora-EPEL"><a href="#Fedora-EPEL" class="headerlink" title="Fedora-EPEL"></a>Fedora-EPEL</h5><p>在CentOS的官方yum源里并没有提供Nginx软件包，所以我们需要配置<code>Fedora-EPEL</code>源<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://mirrors.aliyun.com/epel/7/x86_64/</div></pre></td></tr></table></figure></p>
<h5 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h5><p>编译前先安装依赖的开发包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install pcre-devel openssl-devel zlib-devel</div></pre></td></tr></table></figure></p>
<p>创建Nginx程序管理用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">useradd -r nginx</div></pre></td></tr></table></figure></p>
<p>编译安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_dav_module --with-http_stub_status_module --with-threads --with-file-aio</div><div class="line">make &amp;&amp; make instll</div></pre></td></tr></table></figure></p>
<h5 id="编译安装选项"><a href="#编译安装选项" class="headerlink" title="编译安装选项"></a>编译安装选项</h5><ul>
<li><p>指定安装路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--prefix=/etc/nginx</div></pre></td></tr></table></figure>
</li>
<li><p>指明Nginx程序文件的安装路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--sbin-path=/usr/sbin/nginx</div></pre></td></tr></table></figure>
</li>
<li><p>指明主配置文件安装路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--conf-path=/etc/nginx/nginx.conf</div></pre></td></tr></table></figure>
</li>
<li><p>指定错误日志文件安装位置  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--error-log-path=/var/<span class="built_in">log</span>/nginx/error.log</div></pre></td></tr></table></figure>
</li>
<li><p>访问日志文件安装位置  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--http-log-path=/var/<span class="built_in">log</span>/nginx/access.log</div></pre></td></tr></table></figure>
</li>
<li><p>指明pid文件安装位置  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--pid-path=/var/run/nginx.pid</div></pre></td></tr></table></figure>
</li>
<li><p>指定锁文件安装位置  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--lock-path=/var/run/nginx.lock</div></pre></td></tr></table></figure>
</li>
<li><p>客户端body部分的临时文件存放路径<br>如果服务器允许客户端使用put方法提交大数据时，临时存放的磁盘路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp</div></pre></td></tr></table></figure>
</li>
<li><p>作为代理服务器，服务器响应报文的临时文件存放路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp</div></pre></td></tr></table></figure>
</li>
<li><p>作为fastcgi代理服务器，服务器响应报文的临时文件存放路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp</div></pre></td></tr></table></figure>
</li>
<li><p>作为uwsgi代理服务器，服务器响应报文的临时文件存放路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--http-uwsigi-temp-path=/var/cache/nginx/uwsgi_temp</div></pre></td></tr></table></figure>
</li>
<li><p>作为scgi反代服务器，服务器响应报文的临时文件存放路径  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp</div></pre></td></tr></table></figure>
</li>
<li><p>指明以哪个身份运行worker进程，主控master进程一般由root运行  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--user=nginx</div><div class="line">--group=nginx</div></pre></td></tr></table></figure>
</li>
<li><p>把指定模块编译进来  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--with-http_ssl_module</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Nginx目录结构和命令"><a href="#Nginx目录结构和命令" class="headerlink" title="Nginx目录结构和命令"></a>Nginx目录结构和命令</h4><h5 id="Nginx的目录结构"><a href="#Nginx的目录结构" class="headerlink" title="Nginx的目录结构"></a>Nginx的目录结构</h5><p>以CentOS7.3上安装的Nginx-1.10.2为例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">[root@centos7 ~]<span class="comment">#rpm -ql nginx</span></div><div class="line">/etc/logrotate.d/nginx                          -</div><div class="line">/etc/nginx/fastcgi.conf                          |</div><div class="line">/etc/nginx/fastcgi.conf.default                  |</div><div class="line">/etc/nginx/fastcgi_params                        |</div><div class="line">/etc/nginx/fastcgi_params.default                |</div><div class="line">/etc/nginx/koi-utf                               |   </div><div class="line">/etc/nginx/koi-win                               ||</div><div class="line">/etc/nginx/mime.types                            ||&#125;&gt; 配置文件相关</div><div class="line">/etc/nginx/mime.types.default                    ||</div><div class="line">/etc/nginx/nginx.conf                            |</div><div class="line">/etc/nginx/nginx.conf.default                    |</div><div class="line">/etc/nginx/scgi_params                           |</div><div class="line">/etc/nginx/scgi_params.default                   |</div><div class="line">/etc/nginx/uwsgi_params                          |</div><div class="line">/etc/nginx/uwsgi_params.default                  |</div><div class="line">/etc/nginx/win-utf                              -</div><div class="line">/usr/bin/nginx-upgrade</div><div class="line">/usr/lib/systemd/system/nginx.service           Systemctl服务管理脚本</div><div class="line">/usr/lib64/nginx/modules</div><div class="line">/usr/sbin/nginx                                 Nginx主程序</div><div class="line">/usr/share/doc/nginx-1.10.2</div><div class="line">/usr/share/doc/nginx-1.10.2/CHANGES</div><div class="line">/usr/share/doc/nginx-1.10.2/README</div><div class="line">/usr/share/doc/nginx-1.10.2/README.dynamic</div><div class="line">/usr/share/doc/nginx-1.10.2/UPGRADE-NOTES-1.6-to-1.10</div><div class="line">/usr/share/licenses/nginx-1.10.2</div><div class="line">/usr/share/licenses/nginx-1.10.2/LICENSE</div><div class="line">/usr/share/man/man3/nginx.3pm.gz</div><div class="line">/usr/share/man/man8/nginx-upgrade.8.gz</div><div class="line">/usr/share/man/man8/nginx.8.gz</div><div class="line">/usr/share/nginx/html/404.html</div><div class="line">/usr/share/nginx/html/50x.html</div><div class="line">/usr/share/nginx/html/index.html</div><div class="line">/usr/share/nginx/html/nginx-logo.png</div><div class="line">/usr/share/nginx/html/poweredby.png</div><div class="line">/usr/share/vim/vimfiles/ftdetect/nginx.vim</div><div class="line">/usr/share/vim/vimfiles/indent/nginx.vim</div><div class="line">/usr/share/vim/vimfiles/syntax/nginx.vim</div><div class="line">/var/lib/nginx</div><div class="line">/var/lib/nginx/tmp</div><div class="line">/var/<span class="built_in">log</span>/nginx                                  日志目录</div></pre></td></tr></table></figure></p>
<h5 id="Nginx命令"><a href="#Nginx命令" class="headerlink" title="Nginx命令"></a>Nginx命令</h5><p><code>/usr/sbin/nginx</code>:默认为启动nginx<br>常用参数<br><code>-h</code>: 查看帮助选项<br><code>-t</code>: 测试nginx语法错误<br><code>-c filename</code>：指定配置文件（default:/etc/nginx/nginx.conf）<br><code>-s signal</code>: 发送信号给master进程，signal可为：<code>stop</code>, <code>quit</code>, <code>reopen</code>, <code>reload</code><br><code>-g directives</code>: 在命令行中指明全局指令  </p>
<h4 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h4><p>正常运行必备的配置：<a href="http://nginx.org/en/docs/ngx_core_module.html" target="_blank" rel="external">帮助文档</a>  </p>
<ul>
<li>user  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Syntax:     user  user  [group];</div><div class="line">Default:    user  nobody  nobody;</div><div class="line">Context:    main</div></pre></td></tr></table></figure>
</li>
</ul>
<p>指定worker进程的运行身份，如果不指定，默认和用户名同名  </p>
<ul>
<li>pid /PATH/TO/PID_FILE<br>  指定存储nginx主进程PID的文件路径  </li>
<li>include file | mask<br>  指明包含进来的其他配置文件片段  </li>
<li>load_module file<br>  模块加载配置文件：/usr/share/nginx/modules/*.conf<br>  指明要装载的动态模块路径：/usr/lib64/nginx/modules  </li>
</ul>
<h5 id="配置文件的组成部分"><a href="#配置文件的组成部分" class="headerlink" title="配置文件的组成部分"></a>配置文件的组成部分</h5><ul>
<li>主配置文件：nginx.conf  </li>
<li>子配置文件：include conf.d/*.conf  </li>
<li>fastcgi, uwsgi, scgi等协议相关的配置文件  </li>
<li>mime.types: 支持的mime类型  </li>
</ul>
<p>注意：</p>
<ul>
<li>[x] 指令必须以分行结尾  </li>
<li>[x] 支持使用配置变量  <ul>
<li>自建变量：由Nginx模块引入，可直接引用  </li>
<li>自定义变量：由用户使用set命令定义<br>  <code>set variable_name value;</code>  </li>
<li>引用变量：<code>$variable_name</code>  </li>
</ul>
</li>
</ul>
<h5 id="Nginx主配置文件结构"><a href="#Nginx主配置文件结构" class="headerlink" title="Nginx主配置文件结构"></a>Nginx主配置文件结构</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">main block：主配置段，即全局配置段，对http,mail都有效  </div><div class="line">    event &#123;  </div><div class="line">            ...  </div><div class="line">                &#125; 事件驱动相关的配置  </div><div class="line">http &#123;  </div><div class="line">        ...  </div><div class="line">            &#125; http/https 协议相关配置段  </div><div class="line">mail &#123;  </div><div class="line">        ...  </div><div class="line">        &#125; mail 协议相关配置段  </div><div class="line">stream &#123;  </div><div class="line">            ...  </div><div class="line">                &#125; stream 服务器相关配置段</div></pre></td></tr></table></figure>
<h6 id="Main全局配置段常见的配置指令分类"><a href="#Main全局配置段常见的配置指令分类" class="headerlink" title="Main全局配置段常见的配置指令分类"></a>Main全局配置段常见的配置指令分类</h6><ul>
<li>正常运行必备的配置  </li>
<li>优化性能相关的配置  </li>
<li>用于调试及定位问题相关的配置  </li>
<li>事件驱动相关的配置<br><a href="http://nginx.org/en/docs/" target="_blank" rel="external">配置帮助文档</a>  </li>
</ul>
<h6 id="http协议相关的配置结构"><a href="#http协议相关的配置结构" class="headerlink" title="http协议相关的配置结构"></a>http协议相关的配置结构</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">        ...</div><div class="line">        ... 各server的公共配置</div><div class="line">        server &#123; 每个server用于定义一个虚拟主机</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        server &#123;</div><div class="line">                ...</div><div class="line">                server_name 虚拟主机名</div><div class="line">                root 主目录</div><div class="line">                <span class="built_in">alias</span> 路径别名</div><div class="line">                location [OPERATOR] URL &#123; 指定URL的特性</div><div class="line">                ...</div><div class="line">                    <span class="keyword">if</span> CONDITION &#123;</div><div class="line">                    ...</div><div class="line">                        &#125;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h6 id="性能优化相关的配置："><a href="#性能优化相关的配置：" class="headerlink" title="性能优化相关的配置："></a>性能优化相关的配置：</h6><ul>
<li>worker_processes number | auto<br>worker进程的数量；通常应该为当前主机的cpu的物理核心数  </li>
<li><p>worker_cpu_affinity cpumask …<br>worker_cpu_affinity auto [cpumask] 提高缓存命中率  </p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CPU MASK： 00000001： 0号CPU</div><div class="line">00000010： 1号CPU</div><div class="line">10000000： 8号CPU</div><div class="line">worker_cpu_affinity 0001 0010 0100 1000;</div><div class="line">worker_cpu_affinity 0101 1010;</div></pre></td></tr></table></figure>
</li>
<li><p>worker_priority number<br>指定worker进程的nice值，设定worker进程优先级： [-20,20]  </p>
</li>
<li>worker_rlimit_nofile number<br>worker进程所能够打开的文件数量上限,如65535  </li>
</ul>
<h6 id="事件驱动相关的配置"><a href="#事件驱动相关的配置" class="headerlink" title="事件驱动相关的配置"></a>事件驱动相关的配置</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">events &#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>worker_connections number<br>每个worker进程所能够打开的最大并发连接数数量，如10240<br>总最大并发数： worker_processes * worker_connections  </li>
<li>use method<br>指明并发连接请求的处理方法,默认自动选择最优方法<br>use epoll;  </li>
<li>ccept_mutex on | off 互斥<br>处理新的连接请求的方法； on指由各个worker轮流处理新请求， Off指每个新请求的到达都会通知(唤醒)所有的worker进程，但只有一个进程可获得连接，造成“惊群”，影响性能，默认on</li>
</ul>
<h6 id="调试和定位问题"><a href="#调试和定位问题" class="headerlink" title="调试和定位问题"></a>调试和定位问题</h6><ul>
<li>daemon on|off<br>是否以守护进程方式运行nignx，默认是守护进程方式  </li>
<li>master_process on|off<br>是否以master/worker模型运行nginx；默认为on,off 将不启动worker  </li>
<li>error_log file [level]<br>错误日志文件及其级别；出于调试需要， 可设定为debug；但debug仅在编译时使用了“–with-debug”选项时才有效<br>方式： file /path/logfile;<br>stderr:发送到标准错误<br>syslog:server-address[,parameter=values]:发送到syslog<br>memory:size 内存<br>level:debug|info|notice|warn|error|crit|alter|emerg  </li>
</ul>
<h5 id="ngx-http-core-module"><a href="#ngx-http-core-module" class="headerlink" title="ngx_http_core_module"></a>ngx_http_core_module</h5><ol>
<li>与套接字相关的配置   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">server &#123; ... &#125;</div><div class="line">配置一个虚拟主机</div><div class="line">server &#123;</div><div class="line">listen address[:PORT]|PORT;</div><div class="line">server_name SERVER_NAME;</div><div class="line">root /PATH/TO/DOCUMENT_ROOT;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>listen PORT|address[:port]|unix:/PATH/TO/SOCKET_FILE<br> listen address[:port] [default_server] [ssl] [http2 | spdy]<br> [backlog=number] [rcvbuf=size] [sndbuf=size]<br> default_server 设定为默认虚拟主机<br> ssl 限制仅能够通过ssl连接提供服务<br> backlog=number 超过并发连接数后，新请求进入后援队列的长度<br> rcvbuf=size 接收缓冲区大小<br> sndbuf=size 发送缓冲区大小  </p>
<blockquote>
<p>注意：<br>(1) 基于port；<br>listen PORT; 指令监听在不同的端口<br>(2) 基于ip的虚拟主机<br>listen IP:PORT; IP 地址不同<br>(3) 基于hostname<br>server_name fqdn; 指令指向不同的主机名  </p>
</blockquote>
</li>
<li><p>server_name name …;  </p>
</li>
</ol>
<ul>
<li>虚拟主机的主机名称后可跟多个由空白字符分隔的字符串  </li>
<li><p>支持*通配任意长度的任意字符  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server_name *.magedu.com www.magedu.*</div></pre></td></tr></table></figure>
</li>
<li><p>支持~起始的字符做正则表达式模式匹配，性能原因慎用  </p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">server_name ~^www\d+\.magedu\.com$</div></pre></td></tr></table></figure>
<p>  <code>\d</code> 表示 <code>[0-9]</code>  </p>
</li>
<li>匹配优先级机制从高到低：<br>(1) 首先是字符串精确匹配 如： www.magedu.com<br>(2) 左侧<em>通配符 如： </em>.magedu.com<br>(3) 右侧<em>通配符 如： www.magedu.</em><br>(4) 正则表达式 如： ~^.*.magedu.com$<br>(5) default_server  </li>
</ul>
<ol>
<li><p>tcp_nodelay on | off;<br>在keepalived模式下的连接是否启用TCP_NODELAY选项<br>当为off时，延迟发送，合并多个请求后再发送<br>默认On时，不延迟发送<br>可用于： http, server, location   </p>
</li>
<li><p>sendfile on | off;<br>是否启用sendfile功能，在内核中封装报文直接发送<br>默认Off  </p>
</li>
<li><p>server_tokens on | off | build | string<br> 是否在响应报文的Server首部显示nginx版本<br> 定义路径相关的配置  </p>
</li>
<li><p>root<br>设置web资源的路径映射；用于指明请求的URL所对应的文档的目录路径，可用于http, server, location, if in location  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">...</div><div class="line">root /data/www/vhost1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 示例  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://www.magedu.com/images/logo.jpg</div><div class="line">    --&gt; /data/www/vhosts/images/logo.jpg</div></pre></td></tr></table></figure>
</li>
<li><p><code>location [ = | ~ | ~* | ^~ ] uri { ... }</code><br> location @name { … }<br>在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射； ngnix会根据用户请求的URI来检查定义的所有location，并找出一个最佳匹配，而后应用其配置<br> 示例：  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">server &#123;...</div><div class="line">        server_name www.magedu.com;</div><div class="line">        location /images/ &#123;</div><div class="line">        root /data/imgs/;</div><div class="line">            &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://www.magedu.com/images/logo.jpg</div><div class="line">--&gt; /data/imgs/images/logo.jpg</div></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li><p><code>=</code>：对URI做精确匹配；  </p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">location = / &#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  <a href="http://www.magedu.com/" target="_blank" rel="external">http://www.magedu.com/</a> 匹配<br>  <a href="http://www.magedu.com/index.html" target="_blank" rel="external">http://www.magedu.com/index.html</a> 不匹配  </p>
</li>
<li><code>^~</code>：对URI的最左边部分做匹配检查，不区分字符大小写  </li>
<li><code>~</code>：对URI做正则表达式模式匹配，区分字符大小写  </li>
<li><code>~*</code>：对URI做正则表达式模式匹配，不区分字符大小写  </li>
<li><code>不带符号</code>：匹配起始于此uri的所有的uri  </li>
<li>匹配优先级从高到低：<br>  =, ^~, ～/～*, 不带符号  </li>
</ul>
<ol>
<li>alias path;<br>路径别名，文档映射的另一种机制；仅能用于location上下文<br>示例：<br><a href="http://www.magedu.com/bbs/index.php" target="_blank" rel="external">http://www.magedu.com/bbs/index.php</a>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location /bbs/ &#123;</div><div class="line"><span class="built_in">alias</span> /web/forum/;</div><div class="line">&#125; --&gt; /web/forum/index.html</div><div class="line">location /bbs/ &#123;</div><div class="line">root /web/forum/;</div><div class="line">&#125; --&gt; /web/forum/bbs/index.html</div></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>注意： location中使用root指令和alias指令的意义不同<br>  (a) root，给定的路径对应于location中的/uri/左侧的/<br>  (b) alias，给定的路径对应于location中的/uri/右侧的/  </p>
</blockquote>
<ol>
<li><p>index file …;<br>指定默认网页资源，注意： ngx_http_index_module模块  </p>
</li>
<li><p>error_page code … [=[response]] uri;<br>模块： ngx_http_core_module<br>定义错误页， 以指定的响应状态码进行响应<br>可用位置： http, server, location, if in location  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">error_page 404 /404.html</div><div class="line">error_page 404 =200 /404.html</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><code>try_files file ... uri;</code><br><code>try_files file ... =code;</code><br>按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">location /images/ &#123; try_files <span class="variable">$uri</span> /images/default.gif; &#125;</div><div class="line">location / &#123; try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/index.html <span class="variable">$uri</span>.html =404; &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>定义客户端请求的相关配置</strong>  </p>
<ol>
<li><p>keepalive_timeout timeout [header_timeout];<br>设定保持连接超时时长， 0表示禁止长连接， 默认为75s  </p>
</li>
<li><p>keepalive_requests number;<br>在一次长连接上所允许请求的资源的最大数量,默认为100  </p>
</li>
<li><p>keepalive_disable none | browser …<br>对哪种浏览器禁用长连接  </p>
</li>
<li><p>send_timeout time;<br>向客户端发送响应报文的超时时长，此处是指两次写操作<br>之间的间隔时长，而非整个响应过程的传输时长  </p>
</li>
<li><p>client_body_buffer_size size;<br>用于接收每个客户端请求报文的body部分的缓冲区大小；默认为16k；超出此大小时，其将被暂存到磁盘上的由<br>client_body_temp_path指令所定义的位置  </p>
</li>
<li><p>client_body_temp_path path [level1 [level2[level3]]];<br>设定用于存储客户端请求报文的body部分的临时存储路径及子目录结构和数量<br>目录名为16进制的数字；  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">client_body_temp_path /var/tmp/client_body 1 2 2</div></pre></td></tr></table></figure>
</li>
</ol>
<p>1 1级目录占1位16进制，即2^4=16个目录 0-f<br>2 2级目录占2位16进制，即2^8=256个目录 00-ff<br>2 3级目录占2位16进制， 即2^8=256个目录 00-ff  </p>
<p><strong>对客户端进行限制的相关配置</strong>  </p>
<ol>
<li><p>limit_rate rate;<br>限制响应给客户端的传输速率，单位是bytes/second<br>默认值0表示无限制  </p>
</li>
<li><p>limit_except method … { … }，仅用于location<br>限制客户端使用除了指定的请求方法之外的其它方法<br>method:GET, HEAD, POST, PUT, DELETE MKCOL, COPY, MOVE, OPTIONS, PROPFIND,PROPPATCH, LOCK, UNLOCK, PATCH</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">limit_except GET &#123;</div><div class="line">allow 192.168.1.0/24;</div><div class="line">deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>除了GET和HEAD 之外其它方法仅允许192.168.1.0/24网段主机使用  </p>
<p><strong>文件操作优化的配置</strong>  </p>
<ol>
<li><p>aio on | off | threads[=pool];<br>是否启用aio功能  </p>
</li>
<li><p>directio size | off;<br>是否同步（直接）写磁盘，而非写缓存，在Linux主机启用<br>O_DIRECT标记， 则文件大于等于给定大小时使用，例如directio 4m  </p>
</li>
<li><p>open_file_cache off;<br>open_file_cache max=N [inactive=time];<br>nginx可以缓存以下三种信息：  </p>
</li>
</ol>
<ul>
<li>文件元数据：文件的描述符、文件大小和最近一次的修改时间  </li>
<li>打开的目录结构  </li>
<li>没有找到的或者没有权限访问的文件的相关信息<br><code>max=N</code>：可缓存的缓存项上限；达到上限后会使用LRU算法实现管理<br><code>inactive=time</code>：缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于open_file_cache_min_uses指令所指定的次数的缓存项即为非活动项， 将被删除  </li>
</ul>
<ol>
<li><p>open_file_cache_errors on | off;<br>是否缓存查找时发生错误的文件一类的信息,默认值为off  </p>
</li>
<li><p>open_file_cache_min_uses number;<br>open_file_cache指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项,默认值为1  </p>
</li>
<li><p>open_file_cache_valid time;<br>缓存项有效性的检查频率,默认值为60s  </p>
</li>
</ol>
<h5 id="ngx-http-access-module"><a href="#ngx-http-access-module" class="headerlink" title="ngx_http_access_module"></a>ngx_http_access_module</h5><p>实现基于IP的访问控制功能  </p>
<ul>
<li>allow address | CIDR | unix: | all;  </li>
<li>deny address | CIDR | unix: | all;<br>http, server, location, limit_except<br>自上而下检查，一旦匹配，将生效，条件严格的置前<br>示例：    <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">deny 192.168.1.1;</div><div class="line">allow 192.168.1.0/24;</div><div class="line">allow 10.1.1.0/16;</div><div class="line">allow 2001:0db8::/32;</div><div class="line">deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="ngx-http-auth-basic-module"><a href="#ngx-http-auth-basic-module" class="headerlink" title="ngx_http_auth_basic_module"></a>ngx_http_auth_basic_module</h5><p>实现基于用户的访问控制，使用basic机制进行用户认证  </p>
<ul>
<li>auth_basic string | off;  </li>
<li>auth_basic_user_file file;    <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location /admin/ &#123;</div><div class="line">auth_basic <span class="string">"Admin Area"</span>;</div><div class="line">auth_basic_user_file /etc/nginx/.ngxpasswd;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>用户口令：  </p>
<ul>
<li>明文文本：格式<code>name:password:comment</code>  </li>
<li>加密文本：由htpasswd命令实现<br>  httpd-tools所提供  </li>
</ul>
<h5 id="ngx-http-stub-status-module"><a href="#ngx-http-stub-status-module" class="headerlink" title="ngx_http_stub_status_module"></a>ngx_http_stub_status_module</h5><p>用于输出nginx的基本状态信息<br>输出信息示例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Active connections: 291</div><div class="line">server accepts handled requests</div><div class="line">16630948 16630948 31070465</div></pre></td></tr></table></figure></p>
<p>对应上面accepts,handled,requests三个值<br>Reading: 6 Writing: 179 Waiting: 106<br>Active connections:当前状态，活动状态的连接数<br>accepts：统计总值，已经接受的客户端请求的总数<br>handled：统计总值，已经处理完成的客户端请求的总数<br>requests：统计总值，客户端发来的总的请求数<br>Reading：当前状态，正在读取客户端请求报文首部的连接的连接数<br>Writing：当前状态，正在向客户端发送响应报文过程中的连接数<br>Waiting：当前状态，正在等待客户端发出请求的空闲连接数<br><code>stub_status;</code><br>示例：<br>    <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /status &#123;</div><div class="line">stub_status;</div><div class="line">allow 172.16.0.0/16;</div><div class="line">deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ngx-http-log-module"><a href="#ngx-http-log-module" class="headerlink" title="ngx_http_log_module"></a>ngx_http_log_module</h5><p>指定日志格式记录请求  </p>
<ul>
<li>log_format name string …;<br>  string可以使用nginx核心模块及其它模块内嵌的变量  </li>
<li><p>access_log path [format [buffer=size] [gzip[=level]]<br>  [flush=time] [if=condition]];  </p>
<pre><code>access_log off;  
访问日志文件路径，格式及相关的缓冲的配置  
    buffer=size   
    flush=time  
</code></pre><p>  示例：  </p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">log_format compression <span class="string">'$remote_addr-$remote_user [$time_local] '</span></div><div class="line"><span class="string">'"$request" $status $bytes_sent '</span></div><div class="line"><span class="string">'"$http_referer" "$http_user_agent" "$gzip_ratio"'</span>;</div><div class="line">access_log /spool/logs/nginx-access.log compression buffer=32k;</div></pre></td></tr></table></figure>
</li>
<li><p>open_log_file_cache max=N [inactive=time]<br>  [min_uses=N] [valid=time];<br>  open_log_file_cache off;<br>  缓存各日志文件相关的元数据信息<br>  max：缓存的最大文件描述符数量<br>  min_uses：在inactive指定的时长内访问大于等于此值方可被当作活动项<br>  inactive：非活动时长<br>  valid：验正缓存中各缓存项是否为活动项的时间间隔  </p>
</li>
</ul>
<h5 id="ngx-http-gzip-module"><a href="#ngx-http-gzip-module" class="headerlink" title="ngx_http_gzip_module"></a>ngx_http_gzip_module</h5><p>用gzip方法压缩响应数据，节约带宽  </p>
<ol>
<li><p>gzip on | off;<br>启用或禁用gzip压缩  </p>
</li>
<li><p>gzip_comp_level level;<br>压缩比由低到高： 1 到 9 ;默认： 1  </p>
</li>
<li><p>gzip_disable regex …;<br>匹配到客户端浏览器不执行压缩  </p>
</li>
<li><p>gzip_min_length length;<br>启用压缩功能的响应报文大小阈值  </p>
</li>
<li><p>gzip_http_version 1.0 | 1.1;<br>设定启用压缩功能时，协议的最小版本,默认： 1.1  </p>
</li>
<li><p>gzip_buffers number size;<br>支持实现压缩功能时缓冲区数量及每个缓存区的大小,默认： 32 4k 或 16 8k  </p>
</li>
<li><p>gzip_types mime-type …;<br>指明仅对哪些类型的资源执行压缩操作；即压缩过滤器,默认包含有text/html，不用显示指定，否则出错  </p>
</li>
<li><p>gzip_vary on | off;<br>如果启用压缩，是否在响应报文首部插入”Vary: AcceptEncoding”  </p>
</li>
<li><p>gzip_proxied off | expired | no-cache | no-store | private | no_last_modified | no_etag | auth | any …;<br>nginx对于代理服务器请求的响应报文，在何种条件下启用压缩功能<br>off：对被代理的请求不启用压缩<br>expired,no-cache, no-store， private：对代理服务器请求的响应报文首部Cache-Control值任何一个，启用压缩功能<br>示例：  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gzip on;</div><div class="line">gzip_comp_level 6;</div><div class="line">gzip_min_length 64;</div><div class="line">gzip_proxied any;</div><div class="line">gzip_types text/xml text/css application/javascript;</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="ngx-http-ssl-module"><a href="#ngx-http-ssl-module" class="headerlink" title="ngx_http_ssl_module"></a>ngx_http_ssl_module</h5><ol>
<li>ssl on | off;<br>为指定虚拟机启用HTTPS protocol， 建议用listen指令代替  </li>
<li>ssl_certificate file;<br>当前虚拟主机使用PEM格式的证书文件  </li>
<li>ssl_certificate_key file;<br>当前虚拟主机上与其证书匹配的私钥文件  </li>
<li>ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2];<br>支持ssl协议版本，默认为后三个  </li>
<li>ssl_session_cache off | none | [builtin[:size]] [shared:name:size];<br>builtin[:size]：使用OpenSSL内建缓存，为每worker进程私有<br>[shared:name:size]：在各worker之间使用一个共享的缓存  </li>
<li>ssl_session_timeout time;<br>客户端连接可以复用ssl session cache中缓存的ssl参数的有效时长，默认5m<br>示例：   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">listen 443 ssl;</div><div class="line">server_name www.magedu.com;</div><div class="line">root /vhosts/ssl/htdocs;</div><div class="line">ssl on;</div><div class="line">ssl_certificate /etc/nginx/ssl/nginx.crt;</div><div class="line">ssl_certificate_key /etc/nginx/ssl/nginx.key;</div><div class="line">ssl_session_cache shared:sslcache:20m;</div><div class="line">ssl_session_timeout 10m;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="ngx-http-rewrite-module"><a href="#ngx-http-rewrite-module" class="headerlink" title="ngx_http_rewrite_module"></a>ngx_http_rewrite_module</h5><p>The ngx_http_rewrite_module module is used to change request URI using PCRE regular expressions,return redirects, and conditionally select configurations.<br>将用户请求的URI基于PCRE regex所描述的模式进行检查，而后完成重定向替换<br>示例：<br>    <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://www.magedu.com/hn</div><div class="line">        --&gt; http://www.magedu.com/henan</div><div class="line">http://www.magedu.com</div><div class="line">        --&gt; https://www.magedu.com/</div></pre></td></tr></table></figure></p>
<ul>
<li>rewrite regex replacement [flag]<br>将用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为replacement指定的新的URI<br>注意：如果在同一级配置块中存在多个rewrite规则，那么会自下而下逐个检查；被某条件规则替换完成后，会重新一轮的替换检查<br>隐含有循环机制,但不超过10次；如果超过，提示500响应码， [flag]所表示的标志位用于控制此循环机制<br>如果replacement是以<a href="http://或https://开头，则替换结果会直接以重向返回给客户端" target="_blank" rel="external">http://或https://开头，则替换结果会直接以重向返回给客户端</a><br>301：永久重定向  </li>
<li><p>[flag]：<br>last：重写完成后停止对当前URI在当前location中后续的其它重写操作，而后对新的URI启动新一轮重写检查；提前重启新一轮循环<br>break：重写完成后停止对当前URI在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环，建议在location中使用<br>redirect：临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；不能以<a href="http://或https://开头，使用相对路径，状态码：" target="_blank" rel="external">http://或https://开头，使用相对路径，状态码：</a> 302<br>permanent:重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求，状态码：301  </p>
</li>
<li><p>return  </p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">return</span> code [text];</div><div class="line"><span class="built_in">return</span> code URL;</div><div class="line"><span class="built_in">return</span> URL;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>停止处理，并返回给客户端指定的响应码  </p>
<ul>
<li><p>rewrite_log on | off;<br>是否开启重写日志, 发送至error_log（notice level）  </p>
</li>
<li><p>set $variable value;<br>用户自定义变量<br>注意：变量定义和调用都要以$开头  </p>
</li>
<li><p>if (condition) { … }<br>引入新的上下文,条件满足时，执行配置块中的配置指令； server, location  </p>
</li>
<li>condition：  <ul>
<li>比较操作符：  <ul>
<li><code>==</code> 相同  </li>
<li><code>!=</code> 不同  </li>
<li><code>~</code> 模式匹配，区分字符大小写  </li>
<li><code>~*</code>模式匹配，不区分字符大小写  </li>
<li><code>!~</code>模式不匹配，区分字符大小写  </li>
<li><code>!~*</code>模式不匹配，不区分字符大小写  </li>
</ul>
</li>
<li>文件及目录存在性判断：  <ul>
<li><code>-e, !-e</code> 存在（包括文件，目录，软链接）  </li>
<li><code>-f, !-f</code> 文件  </li>
<li><code>-d, !-d</code> 目录  </li>
<li><code>-x, !-x</code> 执行  </li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="ngx-http-referer-module"><a href="#ngx-http-referer-module" class="headerlink" title="ngx_http_referer_module"></a>ngx_http_referer_module</h5><p>The ngx_http_referer_module module is used to block access to a site for requests with invalid values in the “Referer” header field. 可防止盗链  </p>
<ul>
<li>valid_referers none|blocked|server_names|string …;<br>定义referer首部的合法可用值，不能匹配的将是非法值  <ul>
<li>none：请求报文首部没有referer首部  </li>
<li>blocked：请求报文有referer首部，但无有效值  </li>
<li>server_names：参数，其可以有值作为主机名或主机名模式  </li>
<li>arbitrary_string：任意字符串，但可使用*作通配符  </li>
<li>regular expression：被指定的正则表达式模式匹配到的字符串,要使用~开头，例如： ~.*.magedu.com  </li>
</ul>
</li>
</ul>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">valid_referers none block server_names *.magedu.com *.mageedu.com magedu.* mageedu.* ~\.magedu\.;</div><div class="line"><span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) &#123;</div><div class="line">    <span class="built_in">return</span> 403;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ngx-http-proxy-module"><a href="#ngx-http-proxy-module" class="headerlink" title="ngx_http_proxy_module"></a>ngx_http_proxy_module</h5><p>The ngx_http_proxy_module module allows passing requests to another server.</p>
<ol>
<li>proxy_pass URL;<br>Context:location, if in location, limit_except<br>注意： proxy_pass后面的路径不带uri时，其会将location的uri传递给后端主机  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    server_name HOSTNAME;</div><div class="line">        location /uri/ &#123;</div><div class="line">        proxy_pass http://host[:port]; 最后没有/</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>上面示例： <a href="http://HOSTNAME/uri" target="_blank" rel="external">http://HOSTNAME/uri</a> –&gt; <a href="http://host/uri" target="_blank" rel="external">http://host/uri</a><br><a href="http://host[:port]/" target="_blank" rel="external">http://host[:port]/</a> 意味着： <a href="http://HOSTNAME/uri" target="_blank" rel="external">http://HOSTNAME/uri</a> –&gt; <a href="http://host/" target="_blank" rel="external">http://host/</a><br><code>proxy_pass</code>后面的路径是一个uri时，其会将location的uri替换为proxy_pass的uri<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    ...</div><div class="line">    server_name HOSTNAME;</div><div class="line">        location /uri/ &#123;</div><div class="line">        proxy_pass http://host/new_uri/;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="http://HOSTNAME/uri/" target="_blank" rel="external">http://HOSTNAME/uri/</a> –&gt; <a href="http://host/new_uri/" target="_blank" rel="external">http://host/new_uri/</a>  </p>
<p>如果location定义其uri时使用了正则表达式的模式，则proxy_pass之后必须不能使用uri; 用户请求时传递的uri将直接附加代理到的服务的之后<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">...</div><div class="line">    server_name HOSTNAME;</div><div class="line">        location ~|~* /uri/ &#123;</div><div class="line">        proxy_pass http://host; 不能加/</div><div class="line">    &#125;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="http://HOSTNAME/uri/" target="_blank" rel="external">http://HOSTNAME/uri/</a> –&gt; <a href="http://host/uri/" target="_blank" rel="external">http://host/uri/</a>  </p>
<ol>
<li>proxy_set_header field value;<br>设定发往后端主机的请求报文的请求首部的值  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Context: http, server, location</div><div class="line">proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>标准格式如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">X-Forwarded-For: client1, proxy1, proxy2</div></pre></td></tr></table></figure></p>
<ol>
<li><p>proxy_cache_path;<br>定义可用于proxy功能的缓存； Context:http  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];</div></pre></td></tr></table></figure>
</li>
<li><p>proxy_cache zone | off; 默认off<br>指明调用的缓存，或关闭缓存机制； Context:http,server, location  </p>
</li>
<li><p>proxy_cache_key string;<br>缓存中用于“键”的内容<br>默认值： proxy_cache_key $scheme$proxy_host$request_uri;  </p>
</li>
<li><p>proxy_cache_valid [code …] time;<br>定义对特定响应码的响应内容的缓存时长<br>定义在http{…}中<br>示例:  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proxy_cache_valid 200 302 10m;</div><div class="line">proxy_cache_valid 404 1m;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>示例：<br>在http配置定义缓存<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">proxy_cache_path /var/cache/nginx/proxy_cache</div><div class="line">levels=1:1:1 keys_zone=proxycache:20m</div><div class="line">inactive=120s max_size=1g;</div></pre></td></tr></table></figure></p>
<p>调用缓存功能，需要定义在相应的配置段，如server{…}；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">proxy_cache proxycache;</div><div class="line">proxy_cache_key <span class="variable">$request_uri</span>;</div><div class="line">proxy_cache_valid 200 302 301 1h;</div><div class="line">proxy_cache_valid any 1m;</div></pre></td></tr></table></figure></p>
<ol>
<li><p>proxy_cache_use_stale;<br>proxy_cache_use_stale error | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | off …<br>在被代理的后端服务器出现哪种情况下，可以真接使用过期的缓存响应客户端  </p>
</li>
<li><p>proxy_cache_methods GET | HEAD | POST …;<br>对哪些客户端请求方法对应的响应进行缓存， GET和HEAD方法总是被缓存  </p>
</li>
<li><p>proxy_hide_header field;<br>By default, nginx does not pass the header fields “Date”, “Server”, “X-Pad”, and “X-Accel-…” from the response of a proxied server to a client. 用于隐藏后端服务器特定的响应首部  </p>
</li>
<li><p>proxy_connect_timeout time;<br>定义与后端服务器建立连接的超时时长，如超时会出现502错误，默认为60s，一般不建议超出75s  </p>
</li>
<li><p>proxy_send_timeout time;<br>把请求发送给后端服务器的超时时长；默认为60s  </p>
</li>
<li><p>proxy_read_timeout time;<br>等待后端服务器发送响应报文的超时时长， 默认为60s  </p>
</li>
</ol>
<h5 id="ngx-http-headers-module"><a href="#ngx-http-headers-module" class="headerlink" title="ngx_http_headers_module"></a>ngx_http_headers_module</h5><p>向由代理服务器响应给客户端的响应报文添加自定义首部，或修改指定首部的值  </p>
<ol>
<li><p>add_header name value [always];<br> 添加自定义首部  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">add_header X-Via <span class="variable">$server_addr</span>;</div><div class="line">add_header X-Cache <span class="variable">$upstream_cache_status</span>;</div><div class="line">add_header X-Accel <span class="variable">$server_name</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>add_trailer name value [always];<br> 添加自定义响应信息的尾部  </p>
</li>
</ol>
<h5 id="ngx-http-fastcgi-module模块"><a href="#ngx-http-fastcgi-module模块" class="headerlink" title="ngx_http_fastcgi_module模块"></a>ngx_http_fastcgi_module模块</h5><p>转发请求到FastCGI服务器，不支持php模块方式  </p>
<ol>
<li><p>fastcgi_pass address;<br>address为后端的fastcgi server的地址可用位置： location, if in location  </p>
</li>
<li><p>fastcgi_index name;<br>fastcgi默认的主页资源<br>示例： fastcgi_index index.php;  </p>
</li>
<li><p>fastcgi_param parameter value [if_not_empty];<br>设置传递给 FastCGI服务器的参数值，可以是文本，变量或组合  </p>
</li>
</ol>
<p>示例1：  </p>
<ul>
<li>在后端服务器先配置fpm server和mariadb-server  </li>
<li>在前端nginx服务上做以下配置：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location ~* \.php$ &#123;</div><div class="line">fastcgi_pass 后端fpm服务器IP:9000;</div><div class="line">fastcgi_index index.php;</div><div class="line">fastcgi_param SCRIPT_FILENAME /usr/share/nginx/html<span class="variable">$fastcgi_script_name</span>;</div><div class="line">include fastcgi_params;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>示例2：<br>通过/pm_status和/ping来获取fpm server状态信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">location ~* ^/(pm_status|ping)$ &#123;</div><div class="line">include fastcgi_params;</div><div class="line">fastcgi_pass 后端fpm服务器IP:9000;</div><div class="line">fastcgi_param SCRIPT_FILENAME</div><div class="line"><span class="variable">$fastcgi_script_name</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>fastcgi_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];  </li>
</ol>
<ul>
<li>定义fastcgi的缓存；  <ul>
<li>path 缓存位置为磁盘上的文件系统  </li>
<li>max_size=size  磁盘path路径中用于缓存数据的缓存空间上限  </li>
<li>levels=levels：缓存目录的层级数量，以及每一级的目录数量<br>  levels=ONE:TWO:THREE<br>示例： leves=1:2:2    </li>
<li>keys_zone=name:size<br>  k/v映射的内存空间的名称及大小  </li>
<li>inactive=time<br>  非活动时长  </li>
</ul>
</li>
</ul>
<ol>
<li><p>fastcgi_cache zone | off;<br>调用指定的缓存空间来缓存数据<br>可用位置： http, server, location  </p>
</li>
<li><p>fastcgi_cache_key string;<br>定义用作缓存项的key的字符串<br>示例： fastcgi_cache_key $request_rui;  </p>
</li>
<li><p>fastcgi_cache_methods GET | HEAD | POST …;<br>为哪些请求方法使用缓存  </p>
</li>
<li><p>fastcgi_cache_min_uses number;<br>缓存空间中的缓存项在inactive定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项  </p>
</li>
<li><p>fastcgi_keep_conn on | off;<br>收到后端服务器响应后， fastcgi服务器是否关闭连接，建议启用长连接  </p>
</li>
<li><p>fastcgi_cache_valid [code …] time;<br>不同的响应码各自的缓存时长  </p>
</li>
</ol>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">    http &#123;</div><div class="line">    fastcgi_cache_path /var/cache/nginx/fcgi_cache levels=1:2:1 keys_zone=fcgicache:20m inactive=120s;</div><div class="line">    ...</div><div class="line">        server &#123;</div><div class="line">            location ~* \.php$ &#123;</div><div class="line">            ...</div><div class="line">            fastcgi_cache fcgicache;</div><div class="line">            fastcgi_cache_key <span class="variable">$request_uri</span>;</div><div class="line">            fastcgi_cache_valid 200 302 10m;</div><div class="line">            fastcgi_cache_valid 301 1h;</div><div class="line">            fastcgi_cache_valid any 1m;</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ngx-http-upstream-module模块"><a href="#ngx-http-upstream-module模块" class="headerlink" title="ngx_http_upstream_module模块"></a>ngx_http_upstream_module模块</h5><p>用于将多个服务器定义成服务器组，而由proxy_pass,fastcgi_pass等指令进行引用  </p>
<ol>
<li><p>upstream name { … }<br>定义后端服务器组，会引入一个新的上下文<br>默认调度算法是wrr  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Context: http</div><div class="line">upstream httpdsrvs &#123;</div><div class="line">server ...</div><div class="line">server...</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>server address [parameters];<br>在upstream上下文中server成员，以及相关的参数； Context:upstream  </p>
</li>
</ol>
<ul>
<li>address的表示格式：  <ul>
<li>unix:/PATH/TO/SOME_SOCK_FILE  </li>
<li>IP[:PORT]  </li>
<li>HOSTNAME[:PORT]  </li>
</ul>
</li>
<li>parameters：  <ul>
<li>weight=number 权重，默认为1  </li>
<li>max_conns 连接后端报务器最大并发活动连接数， 1.11.5后支持  </li>
<li>max_fails=number 失败尝试最大次数；超出此处指定的次数时， server将被标记为不可用,默认为1  </li>
<li>fail_timeout=time 后端服务器标记为不可用状态的连接超时时长，默认10s  </li>
<li>backup 将服务器标记为“备用”，即所有服务器均不可用时才启用  </li>
<li>down 标记为“不可用”，配合ip_hash使用，实现灰度发布  </li>
</ul>
</li>
</ul>
<ol>
<li><p>ip_hash 源地址hash调度方法  </p>
</li>
<li><p>least_conn 最少连接调度算法，当server拥有不同的权重时其为wlc，当所有后端主机连接数相同时，则使用wrr，适用于长连接  </p>
</li>
<li><p>hash key [consistent] 基于指定的key的hash表来实现对请求的调度，此处的key可以直接文本、变量或二者组合作用：将请求分类，同一类请求将发往同一个upstream server，使用consistent参数， 将使用ketama一致性hash算法，适用于后端是Cache服务器（如varnish）时使用  </p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">hash</span> <span class="variable">$request_uri</span> consistent;</div><div class="line"><span class="built_in">hash</span> <span class="variable">$remote_addr</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>keepalive 连接数N;<br>为每个worker进程保留的空闲的长连接数量,可节约nginx端口，并减少连接管理的消耗  </p>
</li>
<li><p>health_check [parameters];<br>健康状态检测机制；只能用于location上下文常用参数：  </p>
</li>
</ol>
<ul>
<li>interval=time检测的频率，默认为5秒  </li>
<li>fails=number：判定服务器不可用的失败检测次数；默认为1次  </li>
<li>passes=number：判定服务器可用的失败检测次数；默认为1次  </li>
<li>uri=uri：做健康状态检测测试的目标uri；默认为/  </li>
<li>match=NAME：健康状态检测的结果评估调用此处指定的match配置块  </li>
</ul>
<p><strong>注意：仅对nginx plus有效</strong>  </p>
<ol>
<li>match name { … }<br>对backend server做健康状态检测时，定义其结果判断机制；只能用于http上下文<br>常用的参数：  </li>
</ol>
<ul>
<li>status code[ code …]: 期望的响应状态码  </li>
<li>header HEADER[operator value]：期望存在响应首部，也可对期望的响应首部的值基于比较操作符和值进行比较  </li>
<li>body：期望响应报文的主体部分应该有的内容  </li>
</ul>
<p><strong>注意：仅对nginx plus有效</strong>  </p>
<h5 id="ngx-stream-core-module"><a href="#ngx-stream-core-module" class="headerlink" title="ngx_stream_core_module"></a>ngx_stream_core_module</h5><ul>
<li>nginx的其它的二次发行版：<br>Tengine：由淘宝网发起的Web服务器项目。它在Nginx的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如淘宝网，天猫商城等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。从2011年12月开始， Tengine成为一个开源项目，官网 <a href="http://tengine.taobao.org/" target="_blank" rel="external">http://tengine.taobao.org/</a><br>OpenResty：基于 Nginx 与 Lua 语言的高性能 Web平台  </li>
<li>ngx_stream_core_module模块<br>模拟反代基于tcp或udp的服务连接，即工作于传输层的反代或调度器  </li>
</ul>
<ol>
<li>stream { … }<br>定义stream相关的服务； Context:main  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    upstream telnetsrvs &#123;</div><div class="line">        server 192.168.22.2:23;</div><div class="line">        server 192.168.22.3:23;</div><div class="line">        least_conn;</div><div class="line">    &#125;</div><div class="line">    server &#123;</div><div class="line">        listen 10.1.0.6:23;</div><div class="line">        proxy_pass telnetsrvs;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>listen   <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen address:port [ssl] [udp] [proxy_protocol] [backlog=number] [<span class="built_in">bind</span>] [ipv6only=on|off] [reuseport] [so_keepalive=on|off|[keepidle]:[keepintvl]:[keepcnt]];</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="ngx-stream-proxy-module模块"><a href="#ngx-stream-proxy-module模块" class="headerlink" title="ngx_stream_proxy_module模块"></a>ngx_stream_proxy_module模块</h5><p>可实现代理基于TCP， UDP (1.9.13), UNIX-domain sockets的数据流  </p>
<ul>
<li>proxy_pass address;<br>指定后端服务器地址  </li>
<li>proxy_timeout timeout;<br>无数据传输时，保持连接状态的超时时长,默认为10m  </li>
<li>proxy_connect_timeout time;<br>设置nginx与被代理的服务器尝试建立连接的超时时长,默认为60s  </li>
</ul>
<p>示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">stream &#123;</div><div class="line">    upstream telnetsrvs &#123;</div><div class="line">        server 192.168.10.130:23;</div><div class="line">        server 192.168.10.131:23;</div><div class="line">        <span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent;</div><div class="line">    &#125;</div><div class="line">    server &#123;</div><div class="line">        listen 172.16.100.10:2323;</div><div class="line">        proxy_pass telnetsrvs;</div><div class="line">        proxy_timeout 60s;</div><div class="line">        proxy_connect_timeout 10s;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/10/23/CentOS6编译安装LAMP/">CentOS6编译安装LAMP</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-10-23
        </span>
        
          <div class="post-category">
            
              <a href="/categories/实验/">实验</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>LAMP是指一组一起使用来运行动态网站或服务器的自由软件名称的首字母缩写；  </p>
<ul>
<li><strong>L</strong>inux， 操作系统  </li>
<li><strong>A</strong>pache，WEB服务器  </li>
<li><strong>M</strong>ariaDB或<strong>M</strong>ySQL，数据库管理系统  </li>
<li><strong>P</strong>HP、<strong>P</strong>erl或<strong>P</strong>ython  </li>
</ul>
<p>在这里，我们主要演示Linux、Httpd、MariaDB和PHP的组合的编译安装。  </p>
          <div class="read-more">
            <a href="/2017/10/23/CentOS6编译安装LAMP/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/10/11/搭建私有CA配置HTTPS服务/">搭建私有CA配置HTTPS服务</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-10-11
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
              <a href="/categories/Linux/实验/">实验</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>超文本传输安全协议（英语：Hypertext Transfer Protocol Secure，缩写：HTTPS，常称为HTTP over TLS，HTTP over SSL或HTTP Secure）是一种通过计算机网络进行安全通信的传输协议。HTTPS经由HTTP进行通信，但利用SSL/TLS来加密数据包。HTTPS开发的主要目的，是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。这个协议由网景公司（Netscape）在1994年首次提出，随后扩展到互联网上。   </p>
<p>HTTPS的主要思想是在不安全的网络上创建一安全信道，并可在使用适当的加密包和服务器证书可被验证且可被信任时，对窃听和中间人攻击提供合理的防护。<br>
          <div class="read-more">
            <a href="/2017/10/11/搭建私有CA配置HTTPS服务/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/25/CentOS6-9使用二进制程序包安装MariaDB/">CentOS6.9使用二进制程序包安装MariaDB</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-25
        </span>
        
          <div class="post-category">
            
              <a href="/categories/MariaDB/">MariaDB</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>MariaDB二进制压缩包命名格式形如：mariadb-版本名-操作系统名.tar.gz，请根据您的操作系统下载正确的版本。  </p>
<h5 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h5><ul>
<li><strong>CentOS release 6.9</strong>  </li>
<li><strong>mariadb-10.2.8-linux-x86_64.tar.gz</strong>  </li>
</ul>
<p>在<a href="https://downloads.mariadb.org/mariadb/" target="_blank" rel="external">MariaDB官网</a>下载最新的稳定版MariaDB二进制程序<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/mariadb/01.gif" alt="image">  </p>
          <div class="read-more">
            <a href="/2017/09/25/CentOS6-9使用二进制程序包安装MariaDB/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/22/Bind的安装和配置使用详解/">Bind的安装和配置使用详解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-22
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>BIND（Berkeley Internet Name Daemon）是现今互联网上最常使用的DNS服务器软件，使用BIND作为服务器软件的DNS服务器约占所有DNS服务器的九成。BIND现在由互联网系统协会（Internet Systems Consortium）负责开发与维护。 【<a href="https://zh.wikipedia.org/wiki/BIND" target="_blank" rel="external">摘至维基百科 </a>】</p>
          <div class="read-more">
            <a href="/2017/09/22/Bind的安装和配置使用详解/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/17/TCP-Wrappers详解/">TCP_Wrappers(hosts.allow和hosts.deny)详解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-17
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>TCP Wrapper是一个基于主机的网络访问控制系统，属于工作在传输层的TCP协议。用于对有状态连接的特定服务进行安全检测并实现访问控制。<br>原始代码是1990年左右由荷兰人Wietse Venema编写的，目的是监视埃因霍温理工大学数学和计算机科学系的Unix工作站上的黑客行动。<br>
          <div class="read-more">
            <a href="/2017/09/17/TCP-Wrappers详解/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/13/SSH基于密钥的登录认证/">SSH基于密钥的登录认证</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-13
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h3 id="SSH简介"><a href="#SSH简介" class="headerlink" title="SSH简介"></a>SSH简介</h3><p>SSH，secure shell, protocol, 安全的远程登录，使用的是tcp/22端口。  </p>
<h4 id="具体的软件实现："><a href="#具体的软件实现：" class="headerlink" title="具体的软件实现："></a>具体的软件实现：</h4><ul>
<li>OpenSSH: ssh协议的开源实现,CentOS默认安装  </li>
<li>Dropbear：另一个开源实现  </li>
</ul>
<p><em>在这里，我们主要介绍OpenSSH基于密钥的登录验证配置过程</em>  </p>
          <div class="read-more">
            <a href="/2017/09/13/SSH基于密钥的登录认证/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/13/机器人三定律/">机器人三定律</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-13
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <p><img src="http://ovnpik36u.bkt.clouddn.com/20170913/irobot/irobot.png" alt="image"><br><em>电影《I,Robot》剧照</em></p>
          <div class="read-more">
            <a href="/2017/09/13/机器人三定律/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/12/Windows10启用Linux子系统/">Windows10启用Linux子系统</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-12
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Windows/">Windows</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在去年的Build 2016上，微软向全世界介绍了他们还处于Beta阶段的Windows下的 Linux 子系统<code>Windows Subsystem for Linux（WSL）</code>，它可以让开发者们在 Windows 10 下通过 Bash shell 运行原生的Ubuntu用户态二进制程序。不得不说，这是对缺少Money换MAC的IT工作者的福音！<br>
          <div class="read-more">
            <a href="/2017/09/12/Windows10启用Linux子系统/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/08/CentOS7启动流程图-转载/">CentOS7启动流程图--转载</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-08
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <p>马哥教育Linux线下培训第25期的大神<a href="http://www.pojun.tech" target="_blank" rel="external">xiaoshuaigege</a>画的<strong>CentOS 7启动流程图</strong>，整个启动过程描述的非常细致，在此分享学习~~  </p>
          <div class="read-more">
            <a href="/2017/09/08/CentOS7启动流程图-转载/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/04/CentOS7内核编译安装/">CentOS7内核编译安装</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-04
        </span>
        
          <div class="post-category">
            
              <a href="/categories/实验/">实验</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>Linux内核是操作系统的核心，也是操作系统最基本的部分。  </p>
<p>Linux内核的体积结构是单内核的、但是他充分采用了微内核的设计思想、使得虽然是单内核、但工作在模块化的方式下、并且这个模块可以动态装载或卸载；Linux负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。如是我们在了解Linux内核的基础上根据自己的需要、量身定制一个更高效，更稳定的内核，就需要我们手动去编译和配置内核里的各项相关的参数和信息了。<br>
          <div class="read-more">
            <a href="/2017/09/04/CentOS7内核编译安装/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/03/CentOS6-9启动系列-启动相关的破坏性实验/">CentOS6.9启动系列--启动相关的破坏性实验</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-03
        </span>
        
          <div class="post-category">
            
              <a href="/categories/实验/">实验</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h4><ul>
<li>OS版本：CentOS release 6.9  </li>
<li>Grub版本：grub-0.97-99.el6.x86_64  </li>
</ul>
<h4 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h4><p>移除/boot/grub目录下除grub.conf外的所有文件，然后重启系统  </p>
<h5 id="相关操作"><a href="#相关操作" class="headerlink" title="相关操作"></a>相关操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 app]<span class="comment"># mv /boot/grub/* /app</span></div><div class="line">[root@MyCentOS6 app]<span class="comment"># ls</span></div><div class="line">device.map     grub.conf         minix_stage1_5     stage2</div><div class="line">e2fs_stage1_5  iso9660_stage1_5  reiserfs_stage1_5  ufs2_stage1_5</div><div class="line">fat_stage1_5   jfs_stage1_5      splash.xpm.gz      vstafs_stage1_5</div><div class="line">ffs_stage1_5   menu.lst          stage1             xfs_stage1_5</div><div class="line">[root@MyCentOS6 app]<span class="comment"># mv grub.conf /boot/grub/</span></div><div class="line">[root@MyCentOS6 app]<span class="comment"># ls /boot/grub/</span></div><div class="line">grub.conf</div><div class="line">[root@MyCentOS6 app]<span class="comment"># reboot</span></div></pre></td></tr></table></figure>
<p>重启后，启动界面只是报一个<code>failed to read image</code>的错误，但是依然能够正常启动；<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/16.png" alt="image">  </p>
<h5 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h5><p>一般情况下，系统启动的时候主要用到<code>/boot/grub</code>下的<code>grub.conf</code>文件，其余的都是系统系统的1阶段和1.5阶段的备份文件，只有在1阶段和1.5阶段出现故障时，才会用到这些备份文件。所以移除后并不受影响。  </p>
<h4 id="实验二-破坏MBR"><a href="#实验二-破坏MBR" class="headerlink" title="实验二 破坏MBR"></a>实验二 破坏MBR</h4><p>在实验一的技术上，破坏一阶段的MBR主引导记录，并恢复  </p>
<h5 id="相关操作-1"><a href="#相关操作-1" class="headerlink" title="相关操作"></a>相关操作</h5><p>查看/dev/sda磁盘上的MBR主引导记录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># hexdump -C -n 512 /dev/sda</span></div><div class="line">00000000  eb 48 90 00 00 00 00 00  00 00 00 00 00 00 00 00  |.H..............|</div><div class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">*</div><div class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 03 02  |................|</div><div class="line">00000040  ff 00 00 20 01 00 00 00  00 02 fa 90 90 f6 c2 80  |... ............|</div><div class="line">00000050  75 02 b2 80 ea 59 7c 00  00 31 c0 8e d8 8e d0 bc  |u....Y|..1......|</div><div class="line">00000060  00 20 fb a0 40 7c 3c ff  74 02 88 c2 52 f6 c2 80  |. ..@|&lt;.t...R...|</div><div class="line">00000070  74 54 b4 41 bb aa 55 <span class="built_in">cd</span>  13 5a 52 72 49 81 fb 55  |tT.A..U..ZRrI..U|</div><div class="line">00000080  aa 75 43 a0 41 7c 84 c0  75 05 83 e1 01 74 37 66  |.uC.A|..u....t7f|</div><div class="line">00000090  8b 4c 10 be 05 7c c6 44  ff 01 66 8b 1e 44 7c c7  |.L...|.D..f..D|.|</div><div class="line">000000a0  04 10 00 c7 44 02 01 00  66 89 5c 08 c7 44 06 00  |....D...f.\..D..|</div><div class="line">000000b0  70 66 31 c0 89 44 04 66  89 44 0c b4 42 <span class="built_in">cd</span> 13 72  |pf1..D.f.D..B..r|</div><div class="line">000000c0  05 bb 00 70 eb 7d b4 08  <span class="built_in">cd</span> 13 73 0a f6 c2 80 0f  |...p.&#125;....s.....|</div><div class="line">000000d0  84 f0 00 e9 8d 00 be 05  7c c6 44 ff 00 66 31 c0  |........|.D..f1.|</div><div class="line">000000e0  88 f0 40 66 89 44 04 31  d2 88 ca c1 e2 02 88 e8  |..@f.D.1........|</div><div class="line">000000f0  88 f4 40 89 44 08 31 c0  88 d0 c0 e8 02 66 89 04  |..@.D.1......f..|</div><div class="line">00000100  66 a1 44 7c 66 31 d2 66  f7 34 88 54 0a 66 31 d2  |f.D|f1.f.4.T.f1.|</div><div class="line">00000110  66 f7 74 04 88 54 0b 89  44 0c 3b 44 08 7d 3c 8a  |f.t..T..D.;D.&#125;&lt;.|</div><div class="line">00000120  54 0d c0 e2 06 8a 4c 0a  fe c1 08 d1 8a 6c 0c 5a  |T.....L......l.Z|</div><div class="line">00000130  8a 74 0b bb 00 70 8e c3  31 db b8 01 02 <span class="built_in">cd</span> 13 72  |.t...p..1......r|</div><div class="line">00000140  2a 8c c3 8e 06 48 7c 60  1e b9 00 01 8e db 31 f6  |*....H|`......1.|</div><div class="line">00000150  31 ff <span class="built_in">fc</span> f3 a5 1f 61 ff  26 42 7c be 7f 7d e8 40  |1.....a.&amp;B|..&#125;.@|</div><div class="line">00000160  00 eb 0e be 84 7d e8 38  00 eb 06 be 8e 7d e8 30  |.....&#125;.8.....&#125;.0|</div><div class="line">00000170  00 be 93 7d e8 2a 00 eb  fe 47 52 55 42 20 00 47  |...&#125;.*...GRUB .G|</div><div class="line">00000180  65 6f 6d 00 48 61 72 64  20 44 69 73 6b 00 52 65  |eom.Hard Disk.Re|</div><div class="line">00000190  61 64 00 20 45 72 72 6f  72 00 bb 01 00 b4 0e <span class="built_in">cd</span>  |ad. Error.......|</div><div class="line">000001a0  10 ac 3c 00 75 f4 c3 00  00 00 00 00 00 00 00 00  |..&lt;.u...........|</div><div class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</div><div class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</div><div class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 40 06 00 fe  |)....... ...@...|</div><div class="line">000001e0  ff ff 83 fe ff ff 00 08  60 06 00 00 40 06 00 fe  |........`...@...|</div><div class="line">000001f0  ff ff 05 fe ff ff 00 08  a0 0c 00 f8 5f 0c 55 aa  |............_.U.|</div><div class="line">00000200</div></pre></td></tr></table></figure></p>
<p>可以看到，8020前边，图片白底的446字节的内容都是MBR信息<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/17.png" alt="image"><br>破坏磁盘上的MBR内容<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># dd if=/dev/zero of=/dev/sda bs=1 count=446</span></div><div class="line">446+0 records <span class="keyword">in</span></div><div class="line">446+0 records out</div><div class="line">446 bytes (446 B) copied, 0.000421322 s, 1.1 MB/s</div></pre></td></tr></table></figure></p>
<p>清空后再次查看/dev/sda磁盘上的前512字节：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># hexdump -C -n 512 /dev/sda                </span></div><div class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">*   //重复的使用*省略，如果需要查看详细可以使用hexdump的-v参数</div><div class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</div><div class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</div><div class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 40 06 00 fe  |)....... ...@...|</div><div class="line">000001e0  ff ff 83 fe ff ff 00 08  60 06 00 00 40 06 00 fe  |........`...@...|</div><div class="line">000001f0  ff ff 05 fe ff ff 00 08  a0 0c 00 f8 5f 0c 55 aa  |............_.U.|</div><div class="line">00000200</div></pre></td></tr></table></figure></p>
<p>再次查看发现，/dev/sda磁盘上的前446字节已经全被情况为0了；<br>执行重启操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure></p>
<h5 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h5><p>重启后，因为挂载有光盘镜像，直接进入了光盘引导界面。<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/18.png" alt="image">  </p>
<h5 id="修复过程"><a href="#修复过程" class="headerlink" title="修复过程"></a>修复过程</h5><p>进入光盘的<code>Rescue installed system</code>救援模式<br>选择使用的语言和键盘设置<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/19.png" alt="image"><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/20.png" alt="image"><br>在救援模式下是否启用网络？我们选择不启用<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/21.png" alt="image"><br>进入救援模式后，我们看到的根是救援模式的根，我们硬盘上的操作系统的根在<code>/mnt/sysimage</code>下<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/22.png" alt="image"><br>如果需要硬盘上的操作系统为根目录，可以使用<code>chroot /mnt/sysimage</code>命令<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/23.png" alt="image"><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/24.png" alt="image"><br>选择启动shell<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/25.png" alt="image"><br>在救援模式下查看被破坏的MBR主引导记录<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/26.png" alt="image"><br>因为救援模式下没有<code>grub</code>相关的命令，所以我们需要切根<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sh-4.1<span class="comment">#chroot /mnt/sysimage/</span></div><div class="line">sh-4.1<span class="comment">#ls /boot/grub</span></div><div class="line">grub.conf</div><div class="line">sh-4.1<span class="comment">#ls /sbin/grub</span></div><div class="line">/sbin/grub</div></pre></td></tr></table></figure></p>
<p>修复被破坏的MBR主引导记录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh-4.1<span class="comment">#grub-install /dev/sda</span></div></pre></td></tr></table></figure></p>
<p><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/27.png" alt="image"><br>重启后系统能够正常的启动，查看<code>/boot/grub/</code>目录下，发现生成的新的备份文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># ls /boot/grub/</span></div><div class="line">device.map     ffs_stage1_5      jfs_stage1_5       stage1         vstafs_stage1_5</div><div class="line">e2fs_stage1_5  grub.conf         minix_stage1_5     stage2         xfs_stage1_5</div><div class="line">fat_stage1_5   iso9660_stage1_5  reiserfs_stage1_5  ufs2_stage1_5</div></pre></td></tr></table></figure></p>
<p>查看磁盘上的MBR引导信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># hexdump -C -n 512 /dev/sda</span></div><div class="line">00000000  eb 48 90 00 00 00 00 00  00 00 00 00 00 00 00 00  |.H..............|</div><div class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">*</div><div class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 03 02  |................|</div><div class="line">00000040  ff 00 00 20 01 00 00 00  00 02 fa 90 90 f6 c2 80  |... ............|</div><div class="line">00000050  75 02 b2 80 ea 59 7c 00  00 31 c0 8e d8 8e d0 bc  |u....Y|..1......|</div><div class="line">00000060  00 20 fb a0 40 7c 3c ff  74 02 88 c2 52 f6 c2 80  |. ..@|&lt;.t...R...|</div><div class="line">00000070  74 54 b4 41 bb aa 55 <span class="built_in">cd</span>  13 5a 52 72 49 81 fb 55  |tT.A..U..ZRrI..U|</div><div class="line">00000080  aa 75 43 a0 41 7c 84 c0  75 05 83 e1 01 74 37 66  |.uC.A|..u....t7f|</div><div class="line">00000090  8b 4c 10 be 05 7c c6 44  ff 01 66 8b 1e 44 7c c7  |.L...|.D..f..D|.|</div><div class="line">000000a0  04 10 00 c7 44 02 01 00  66 89 5c 08 c7 44 06 00  |....D...f.\..D..|</div><div class="line">000000b0  70 66 31 c0 89 44 04 66  89 44 0c b4 42 <span class="built_in">cd</span> 13 72  |pf1..D.f.D..B..r|</div><div class="line">000000c0  05 bb 00 70 eb 7d b4 08  <span class="built_in">cd</span> 13 73 0a f6 c2 80 0f  |...p.&#125;....s.....|</div><div class="line">000000d0  84 f0 00 e9 8d 00 be 05  7c c6 44 ff 00 66 31 c0  |........|.D..f1.|</div><div class="line">000000e0  88 f0 40 66 89 44 04 31  d2 88 ca c1 e2 02 88 e8  |..@f.D.1........|</div><div class="line">000000f0  88 f4 40 89 44 08 31 c0  88 d0 c0 e8 02 66 89 04  |..@.D.1......f..|</div><div class="line">00000100  66 a1 44 7c 66 31 d2 66  f7 34 88 54 0a 66 31 d2  |f.D|f1.f.4.T.f1.|</div><div class="line">00000110  66 f7 74 04 88 54 0b 89  44 0c 3b 44 08 7d 3c 8a  |f.t..T..D.;D.&#125;&lt;.|</div><div class="line">00000120  54 0d c0 e2 06 8a 4c 0a  fe c1 08 d1 8a 6c 0c 5a  |T.....L......l.Z|</div><div class="line">00000130  8a 74 0b bb 00 70 8e c3  31 db b8 01 02 <span class="built_in">cd</span> 13 72  |.t...p..1......r|</div><div class="line">00000140  2a 8c c3 8e 06 48 7c 60  1e b9 00 01 8e db 31 f6  |*....H|`......1.|</div><div class="line">00000150  31 ff <span class="built_in">fc</span> f3 a5 1f 61 ff  26 42 7c be 7f 7d e8 40  |1.....a.&amp;B|..&#125;.@|</div><div class="line">00000160  00 eb 0e be 84 7d e8 38  00 eb 06 be 8e 7d e8 30  |.....&#125;.8.....&#125;.0|</div><div class="line">00000170  00 be 93 7d e8 2a 00 eb  fe 47 52 55 42 20 00 47  |...&#125;.*...GRUB .G|</div><div class="line">00000180  65 6f 6d 00 48 61 72 64  20 44 69 73 6b 00 52 65  |eom.Hard Disk.Re|</div><div class="line">00000190  61 64 00 20 45 72 72 6f  72 00 bb 01 00 b4 0e <span class="built_in">cd</span>  |ad. Error.......|</div><div class="line">000001a0  10 ac 3c 00 75 f4 c3 00  00 00 00 00 00 00 00 00  |..&lt;.u...........|</div><div class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</div><div class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</div><div class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 40 06 00 fe  |)....... ...@...|</div><div class="line">000001e0  ff ff 83 fe ff ff 00 08  60 06 00 00 40 06 00 fe  |........`...@...|</div><div class="line">000001f0  ff ff 05 fe ff ff 00 08  a0 0c 00 f8 5f 0c 55 aa  |............_.U.|</div><div class="line">00000200</div></pre></td></tr></table></figure></p>
<p>可以看到，系统启动一阶段的MBR引导信息已经被恢复;  </p>
<h4 id="实验三：破坏系统启动的1-5阶段"><a href="#实验三：破坏系统启动的1-5阶段" class="headerlink" title="实验三：破坏系统启动的1.5阶段"></a>实验三：破坏系统启动的1.5阶段</h4><p>破坏磁盘上MBR之后的分区，让1阶段中的boot loader不能够识别2阶段所在的分区上的文件系统；  </p>
<h5 id="相关操作-2"><a href="#相关操作-2" class="headerlink" title="相关操作"></a>相关操作</h5><p>清除MBR后的9728字节的信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># dd if=/dev/zero of=/dev/sda bs=1 count=10240 skip=512 seek=512</span></div><div class="line">10240+0 records <span class="keyword">in</span></div><div class="line">10240+0 records out</div><div class="line">10240 bytes (10 kB) copied, 0.00533366 s, 1.9 MB/s</div></pre></td></tr></table></figure></p>
<p>查看清除后的信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># hexdump -C -n 10240 /dev/sda</span></div><div class="line">00000000  eb 48 90 00 00 00 00 00  00 00 00 00 00 00 00 00  |.H..............|</div><div class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">*</div><div class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 03 02  |................|</div><div class="line">00000040  ff 00 00 20 01 00 00 00  00 02 fa 90 90 f6 c2 80  |... ............|</div><div class="line">00000050  75 02 b2 80 ea 59 7c 00  00 31 c0 8e d8 8e d0 bc  |u....Y|..1......|</div><div class="line">00000060  00 20 fb a0 40 7c 3c ff  74 02 88 c2 52 f6 c2 80  |. ..@|&lt;.t...R...|</div><div class="line">00000070  74 54 b4 41 bb aa 55 <span class="built_in">cd</span>  13 5a 52 72 49 81 fb 55  |tT.A..U..ZRrI..U|</div><div class="line">00000080  aa 75 43 a0 41 7c 84 c0  75 05 83 e1 01 74 37 66  |.uC.A|..u....t7f|</div><div class="line">00000090  8b 4c 10 be 05 7c c6 44  ff 01 66 8b 1e 44 7c c7  |.L...|.D..f..D|.|</div><div class="line">000000a0  04 10 00 c7 44 02 01 00  66 89 5c 08 c7 44 06 00  |....D...f.\..D..|</div><div class="line">000000b0  70 66 31 c0 89 44 04 66  89 44 0c b4 42 <span class="built_in">cd</span> 13 72  |pf1..D.f.D..B..r|</div><div class="line">000000c0  05 bb 00 70 eb 7d b4 08  <span class="built_in">cd</span> 13 73 0a f6 c2 80 0f  |...p.&#125;....s.....|</div><div class="line">000000d0  84 f0 00 e9 8d 00 be 05  7c c6 44 ff 00 66 31 c0  |........|.D..f1.|</div><div class="line">000000e0  88 f0 40 66 89 44 04 31  d2 88 ca c1 e2 02 88 e8  |..@f.D.1........|</div><div class="line">000000f0  88 f4 40 89 44 08 31 c0  88 d0 c0 e8 02 66 89 04  |..@.D.1......f..|</div><div class="line">00000100  66 a1 44 7c 66 31 d2 66  f7 34 88 54 0a 66 31 d2  |f.D|f1.f.4.T.f1.|</div><div class="line">00000110  66 f7 74 04 88 54 0b 89  44 0c 3b 44 08 7d 3c 8a  |f.t..T..D.;D.&#125;&lt;.|</div><div class="line">00000120  54 0d c0 e2 06 8a 4c 0a  fe c1 08 d1 8a 6c 0c 5a  |T.....L......l.Z|</div><div class="line">00000130  8a 74 0b bb 00 70 8e c3  31 db b8 01 02 <span class="built_in">cd</span> 13 72  |.t...p..1......r|</div><div class="line">00000140  2a 8c c3 8e 06 48 7c 60  1e b9 00 01 8e db 31 f6  |*....H|`......1.|</div><div class="line">00000150  31 ff <span class="built_in">fc</span> f3 a5 1f 61 ff  26 42 7c be 7f 7d e8 40  |1.....a.&amp;B|..&#125;.@|</div><div class="line">00000160  00 eb 0e be 84 7d e8 38  00 eb 06 be 8e 7d e8 30  |.....&#125;.8.....&#125;.0|</div><div class="line">00000170  00 be 93 7d e8 2a 00 eb  fe 47 52 55 42 20 00 47  |...&#125;.*...GRUB .G|</div><div class="line">00000180  65 6f 6d 00 48 61 72 64  20 44 69 73 6b 00 52 65  |eom.Hard Disk.Re|</div><div class="line">00000190  61 64 00 20 45 72 72 6f  72 00 bb 01 00 b4 0e <span class="built_in">cd</span>  |ad. Error.......|</div><div class="line">000001a0  10 ac 3c 00 75 f4 c3 00  00 00 00 00 00 00 00 00  |..&lt;.u...........|</div><div class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</div><div class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</div><div class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 40 06 00 fe  |)....... ...@...|</div><div class="line">000001e0  ff ff 83 fe ff ff 00 08  60 06 00 00 40 06 00 fe  |........`...@...|</div><div class="line">000001f0  ff ff 05 fe ff ff 00 08  a0 0c 00 f8 5f 0c 55 aa  |............_.U.|</div><div class="line">00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">*</div><div class="line">00002800</div></pre></td></tr></table></figure></p>
<p>使用hexdump的-v参数显示详细结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># hexdump -C -n  1024 -v /dev/sda </span></div><div class="line">00000000  eb 48 90 00 00 00 00 00  00 00 00 00 00 00 00 00  |.H..............|</div><div class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 03 02  |................|</div><div class="line">00000040  ff 00 00 20 01 00 00 00  00 02 fa 90 90 f6 c2 80  |... ............|</div><div class="line">00000050  75 02 b2 80 ea 59 7c 00  00 31 c0 8e d8 8e d0 bc  |u....Y|..1......|</div><div class="line">00000060  00 20 fb a0 40 7c 3c ff  74 02 88 c2 52 f6 c2 80  |. ..@|&lt;.t...R...|</div><div class="line">00000070  74 54 b4 41 bb aa 55 <span class="built_in">cd</span>  13 5a 52 72 49 81 fb 55  |tT.A..U..ZRrI..U|</div><div class="line">00000080  aa 75 43 a0 41 7c 84 c0  75 05 83 e1 01 74 37 66  |.uC.A|..u....t7f|</div><div class="line">00000090  8b 4c 10 be 05 7c c6 44  ff 01 66 8b 1e 44 7c c7  |.L...|.D..f..D|.|</div><div class="line">000000a0  04 10 00 c7 44 02 01 00  66 89 5c 08 c7 44 06 00  |....D...f.\..D..|</div><div class="line">000000b0  70 66 31 c0 89 44 04 66  89 44 0c b4 42 <span class="built_in">cd</span> 13 72  |pf1..D.f.D..B..r|</div><div class="line">000000c0  05 bb 00 70 eb 7d b4 08  <span class="built_in">cd</span> 13 73 0a f6 c2 80 0f  |...p.&#125;....s.....|</div><div class="line">000000d0  84 f0 00 e9 8d 00 be 05  7c c6 44 ff 00 66 31 c0  |........|.D..f1.|</div><div class="line">000000e0  88 f0 40 66 89 44 04 31  d2 88 ca c1 e2 02 88 e8  |..@f.D.1........|</div><div class="line">000000f0  88 f4 40 89 44 08 31 c0  88 d0 c0 e8 02 66 89 04  |..@.D.1......f..|</div><div class="line">00000100  66 a1 44 7c 66 31 d2 66  f7 34 88 54 0a 66 31 d2  |f.D|f1.f.4.T.f1.|</div><div class="line">00000110  66 f7 74 04 88 54 0b 89  44 0c 3b 44 08 7d 3c 8a  |f.t..T..D.;D.&#125;&lt;.|</div><div class="line">00000120  54 0d c0 e2 06 8a 4c 0a  fe c1 08 d1 8a 6c 0c 5a  |T.....L......l.Z|</div><div class="line">00000130  8a 74 0b bb 00 70 8e c3  31 db b8 01 02 <span class="built_in">cd</span> 13 72  |.t...p..1......r|</div><div class="line">00000140  2a 8c c3 8e 06 48 7c 60  1e b9 00 01 8e db 31 f6  |*....H|`......1.|</div><div class="line">00000150  31 ff <span class="built_in">fc</span> f3 a5 1f 61 ff  26 42 7c be 7f 7d e8 40  |1.....a.&amp;B|..&#125;.@|</div><div class="line">00000160  00 eb 0e be 84 7d e8 38  00 eb 06 be 8e 7d e8 30  |.....&#125;.8.....&#125;.0|</div><div class="line">00000170  00 be 93 7d e8 2a 00 eb  fe 47 52 55 42 20 00 47  |...&#125;.*...GRUB .G|</div><div class="line">00000180  65 6f 6d 00 48 61 72 64  20 44 69 73 6b 00 52 65  |eom.Hard Disk.Re|</div><div class="line">00000190  61 64 00 20 45 72 72 6f  72 00 bb 01 00 b4 0e <span class="built_in">cd</span>  |ad. Error.......|</div><div class="line">000001a0  10 ac 3c 00 75 f4 c3 00  00 00 00 00 00 00 00 00  |..&lt;.u...........|</div><div class="line">000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 20  |............... |</div><div class="line">000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|</div><div class="line">000001d0  29 82 83 fe ff ff 00 08  20 00 00 00 40 06 00 fe  |)....... ...@...|</div><div class="line">000001e0  ff ff 83 fe ff ff 00 08  60 06 00 00 40 06 00 fe  |........`...@...|</div><div class="line">000001f0  ff ff 05 fe ff ff 00 08  a0 0c 00 f8 5f 0c 55 aa  |............_.U.|</div><div class="line">00000200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000210  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000220  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000230  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000240  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000250  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000260  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000270  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000280  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000290  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000002a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000002b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000002c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000002d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000002e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000002f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000300  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000310  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000320  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000330  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000340  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000350  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000360  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000370  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000380  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00000390  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000003a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000003b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000003c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000003d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000003e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">000003f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div></pre></td></tr></table></figure></p>
<p>可以看到MBR后的磁盘内容都为0了；<br>重启系统看效果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure></p>
<h5 id="现象-1"><a href="#现象-1" class="headerlink" title="现象"></a>现象</h5><p>系统启动之后直接显示黑屏<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/28.png" alt="image">  </p>
<h5 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h5><p>系统启动之后，因为1阶段的MBR主引导记录是可用的，所以能够正常从硬盘启动引导，但是磁盘中MBR后的数据都被清零了，导致卡在了1.5阶段，现象就是如图所示的黑屏；  </p>
<h5 id="修复过程-1"><a href="#修复过程-1" class="headerlink" title="修复过程"></a>修复过程</h5><p>调BIOS使用系统安装光盘进入救援模式，然后切根，使用grub命令进行修复：<br><em>注意：grub命令依赖/boot/grub/目录下的1阶段和1.5阶段备份文件，如果把他们移除后使用grub命令就会修复失败：</em><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/29.png" alt="image"><br>把从/boot/grub/内的备份文件恢复后，重新使用grub命令修复1.5阶段<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/30.png" alt="image"><br>可以看到修复成功的提示，并可以看到修复了27个扇区；<br>退出grub后，重启系统，系统成功启动进入登陆界面<br>查看前27个扇区的信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#hexdump -C -n 13959 /dev/sda</span></div><div class="line">.....................</div><div class="line">000034d0  00 00 00 00 01 00 00 00  65 78 74 32 66 73 00 69  |........ext2fs.i|</div><div class="line">000034e0  6e 74 65 72 6e 61 6c 20  65 72 72 6f 72 3a 20 74  |nternal error: t|</div><div class="line">000034f0  68 65 20 73 65 63 6f 6e  64 20 73 65 63 74 6f 72  |he second sector|</div><div class="line">00003500  20 6f 66 20 53 74 61 67  65 20 32 20 69 73 20 75  | of Stage 2 is u|</div><div class="line">00003510  6e 6b 6e 6f 77 6e 2e 00  14 00 00 00 00 00 00 00  |nknown..........|</div><div class="line">00003520  01 7a 52 00 01 7c 08 01  1b 0c 04 04 88 01 00 00  |.zR..|..........|</div><div class="line">00003530  28 00 00 00 1c 00 00 00  68 f9 ff ff 72 01 00 00  |(.......h...r...|</div><div class="line">00003540  00 41 0e 08 85 02 42 0d  05 4b 86 04 87 03 02 68  |.A....B..K.....h|</div><div class="line">00003550  0a c6 41 c7 41 c5 0c 04  04 48 0b 00 34 00 00 00  |..A.A....H..4...|</div><div class="line">00003560  48 00 00 00 bc fa ff ff  cc 01 00 00 00 41 0e 08  |H............A..|</div><div class="line">00003570  85 02 42 0d 05 4b 86 04  87 03 02 64 0a c6 41 c7  |..B..K.....d..A.|</div><div class="line">00003580  41 0c 04 04 c5 44 0b 61  0a c6 41 c7 41 c5 0c 04  |A....D.a..A.A...|</div><div class="line">00003590  04 45 0b 00 48 00 00 00  80 00 00 00 54 <span class="built_in">fc</span> ff ff  |.E..H.......T...|</div><div class="line">000035a0  28 01 00 00 00 41 0e 08  85 02 42 0d 05 4e 86 04  |(....A....B..N..|</div><div class="line">000035b0  87 03 76 0a c6 41 c7 41  0c 04 04 c5 47 0b 6c 0a  |..v..A.A....G.l.|</div><div class="line">000035c0  c6 41 c7 41 c5 0c 04 04  42 0b 54 0a c6 41 c7 41  |.A.A....B.T..A.A|</div><div class="line">000035d0  0c 04 04 c5 42 0b 02 8d  c6 41 c7 41 0c 04 04 c5  |....B....A.A....|</div><div class="line">000035e0  4c 00 00 00 cc 00 00 00  38 fd ff ff 3b 01 00 00  |L.......8...;...|</div><div class="line">000035f0  00 41 0e 08 85 02 42 0d  05 4e 86 04 87 03 5c 0a  |.A....B..N....\.|</div><div class="line">00003600  c6 41 c7 41 c5 0c 04 04  41 0b 6b 0a c6 41 c7 41  |.A.A....A.k..A.A|</div><div class="line">00003610  0c 04 04 c5 43 0b 68 0a  c6 41 c7 41 0c 04 04 c5  |....C.h..A.A....|</div><div class="line">00003620  46 0b 02 85 0a c6 41 c7  41 0c 04 04 c5 41 0b 00  |F.....A.A....A..|</div><div class="line">00003630  00 01 00 00 d8 52 00 00  59 48 00 00 44 49 00 00  |.....R..YH..DI..|</div><div class="line">00003640  d7 42 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |.B..............|</div><div class="line">00003650  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00003660  00 00 00 00 ff 00 00 00  01 00 00 00 ff ff ff ff  |................|</div><div class="line">00003670  ff ff ff ff 00 00 00 00  00 00 00 00 00 00 00 00  |................|</div><div class="line">00003680  00 00 00 00 00 00 00                              |.......|</div><div class="line">00003687</div><div class="line">............省略..........</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：修复后，系统启动会依赖/boot/grub/stage2，所以/boot/grub目录下至少要存在grub.conf和stage2文件。否则系统不能正常启动！  </p>
</blockquote>
<h4 id="实验四-移除grub-conf文件"><a href="#实验四-移除grub-conf文件" class="headerlink" title="实验四 移除grub.conf文件"></a>实验四 移除grub.conf文件</h4><p>移除/boot/grub/grub.conf文件，然后重启系统看效果并修复  </p>
<h4 id="相关操作-3"><a href="#相关操作-3" class="headerlink" title="相关操作"></a>相关操作</h4><p>移除/boot/grub/grub.conf文件并重启系统<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># mv /boot/grub/grub.conf /app/</span></div><div class="line">[root@MyCentOS6 ~]<span class="comment"># ls /boot/grub/</span></div><div class="line">device.map     ffs_stage1_5      minix_stage1_5     stage2           xfs_stage1_5</div><div class="line">e2fs_stage1_5  iso9660_stage1_5  reiserfs_stage1_5  ufs2_stage1_5</div><div class="line">fat_stage1_5   jfs_stage1_5      stage1             vstafs_stage1_5</div><div class="line">[root@MyCentOS6 ~]<span class="comment"># reboot</span></div><div class="line"></div><div class="line">Broadcast message from root@MyCentOS6.9</div><div class="line">        (/dev/pts/1) at 8:34 ...</div><div class="line"></div><div class="line">The system is going down <span class="keyword">for</span> reboot NOW!</div></pre></td></tr></table></figure></p>
<p>系统启动之后会显示如下界面：<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/31.png" alt="image">  </p>
<h5 id="原因-1"><a href="#原因-1" class="headerlink" title="原因"></a>原因</h5><p>开机加电自检后，通过BIOS设置的第一启动项找到硬盘后，通过硬盘上的MBR主分区引导加载磁盘上的内容，但是没有读到grub.conf内的相应配置；  </p>
<h5 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h5><p>使用grub交互命令启动系统：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">grub&gt; root (hd0,0)</div><div class="line">grub&gt; kernel /vmlinuz-2.6.32-696.e16.x86_64 root=/dev/sda2</div><div class="line">grub&gt; initrd /initramfs-2.6.32-696.e16.x86_64.img</div></pre></td></tr></table></figure></p>
<p><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/32.png" alt="image"><br>键入<code>boot</code>敲回车后，即进入后续的启动流程；  </p>
<blockquote>
<p>注意：虽然系统成功启动了，但是/boot/grub/目录下并没有grub.conf文件。需要自己去配置相关文件，不然下次启动还是会卡在grub的交互界面、手工输入才能启动；  </p>
</blockquote>
<h4 id="实验五-删除-boot-grub目录"><a href="#实验五-删除-boot-grub目录" class="headerlink" title="实验五 删除/boot/grub目录"></a>实验五 删除/boot/grub目录</h4><p>删除/boot/grub目录后，重启看效果，并修复  </p>
<h5 id="相关操作-4"><a href="#相关操作-4" class="headerlink" title="相关操作"></a>相关操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># rm -rf /boot/grub</span></div><div class="line">[root@MyCentOS6 ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure>
<p>系统启动后，报错<code>Error 15</code><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/33.png" alt="image">  </p>
<h5 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h5><p>使用系统安装光盘，进入救援模式后，切根，使用<code>grub-install</code>命令修复：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sh-4.1<span class="comment"># grub-install /dev/sda</span></div><div class="line">sh-4.1<span class="comment"># sync    //确保写入磁盘</span></div></pre></td></tr></table></figure></p>
<p><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/34.png" alt="image"><br>这时候，查看/boot/grub/目录就可以看到又新生成了相应文件。但是并没有grub.conf文件。<br>创建grub.conf文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /boot/grub/grub.conf</div><div class="line">default=0</div><div class="line">timeout=3</div><div class="line">title magelinux</div><div class="line">kernel  /vmlinuz-2.6.32-696.el6.x86_64</div><div class="line">initrd  /initramfs-2.6.32-696.el6.x86_64.img</div></pre></td></tr></table></figure></p>
<p>保存后，重启系统，即可成功启动系统！  </p>
<h4 id="实验六-删除-boot目录"><a href="#实验六-删除-boot目录" class="headerlink" title="实验六 删除/boot目录"></a>实验六 删除/boot目录</h4><p>删除/boot目录后重启系统，并修复  </p>
<h4 id="相关操作-5"><a href="#相关操作-5" class="headerlink" title="相关操作"></a>相关操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># rm -rf /boot</span></div><div class="line">[root@MyCentOS6 ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure>
<p>启动后，跟实验五的结果一样，报错“Error 15”<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/33.png" alt="image">  </p>
<h5 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h5><p>使用系统安装光盘，进入救援模式后，切根,挂载光盘，从光盘里考入内核文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">chroot /mnt/sysimage/</div><div class="line">mount /dev/sr0 /mnt</div><div class="line"><span class="built_in">cd</span> /mnt/isolinux/</div><div class="line">cp vmlinuz /boot/</div><div class="line">mkinitrd /boot/initramfs.img `uname -r`</div><div class="line">grub-install /dev/sda</div><div class="line">sync</div></pre></td></tr></table></figure></p>
<p>查看/boot/下的文件发现还差/boot/grub/grub.conf文件，继续手工编写：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /boot/grub/grub.conf</div><div class="line">default=0</div><div class="line">timeout=3</div><div class="line">title magelinux</div><div class="line">kernel  /vmlinuz-2.6.32-696.el6.x86_64</div><div class="line">initrd  /initramfs-2.6.32-696.el6.x86_64.img</div></pre></td></tr></table></figure></p>
<p>完成之后重启系统，又能愉快的启动了~~</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/03/CentOS6-9启动系列-为Grub设置密码/">CentOS6.9启动系列--为Grub设置密码</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-03
        </span>
        
          <div class="post-category">
            
              <a href="/categories/实验/">实验</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h4><ul>
<li>OS版本：CentOS release 6.9  </li>
<li>Grub版本：grub-0.97-99.el6.x86_64  <h4 id="明文密码"><a href="#明文密码" class="headerlink" title="明文密码"></a>明文密码</h4>编辑<code>/boot/grub/grub.conf</code>文件：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">vim /boot/grub/grub.conf</div><div class="line"><span class="comment"># grub.conf generated by anaconda</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Note that you do not have to rerun grub after making changes to this file</span></div><div class="line"><span class="comment"># NOTICE:  You have a /boot partition.  This means that</span></div><div class="line"><span class="comment">#          all kernel and initrd paths are relative to /boot/, eg.</span></div><div class="line"><span class="comment">#          root (hd0,0)</span></div><div class="line"><span class="comment">#          kernel /vmlinuz-version ro root=/dev/sda2</span></div><div class="line"><span class="comment">#          initrd /initrd-[generic-]version.img</span></div><div class="line"><span class="comment">#boot=/dev/sda</span></div><div class="line">default=0</div><div class="line">timeout=5</div><div class="line"><span class="comment">#splashimage=(hd0,0)/grub/splash.xpm.gz     //这个是启动菜单的背景图片</span></div><div class="line">password magedu     //编辑启动引导菜单的密码</div><div class="line">hiddenmenu</div><div class="line">title CentOS 6 (2.6.32-696.el6.x86_64)</div><div class="line">        root (hd0,0)</div><div class="line">        kernel /vmlinuz-2.6.32-696.el6.x86_64 ro root=UUID=811f130c-f1b2-423d-9149-29703</div><div class="line">0fbfe80 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashke</div><div class="line">rnel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</div><div class="line">        initrd /initramfs-2.6.32-696.el6.x86_64.img</div><div class="line">        password hello      //第一个启动引导项的启动口令</div><div class="line">title CentOS 9 (9.6.32-696.el6.x86_64)</div><div class="line">        root (hd0,0)</div><div class="line">        kernel /vmlinuz-2.6.32-696.el6.x86_64 ro root=UUID=811f130c-f1b2-423d-9149-29703</div><div class="line">0fbfe80 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashke</div><div class="line">rnel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</div><div class="line">        initrd /initramfs-2.6.32-696.el6.x86_64.img</div></pre></td></tr></table></figure>
</li>
</ul>
<p>新增行<code>password magedu</code>说明：<br>这个密码锁定的是启动引导菜单，设置后系统重新启动时，如果需要选择、编辑启动引导菜单或者进入单用户模式时，就需要使用到该密码；<br><em>如图所示，默认可以在不需要密码的情况下可以上下切换启动项。如果需要编辑引导菜单，则需要按<code>p</code>进行设置：</em><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/12.png" alt="image"><br><em>按<code>p</code>后如图所示</em><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/13.png" alt="image">  </p>
<blockquote>
<p>Note: 默认启动菜单的背景图片没有被注释掉，如果在进入编辑菜单时明明密码输入正确却总是报错，可以把这个背景图片行注释掉试试；  </p>
</blockquote>
<p>新增行<code>password hello</code>说明：<br>这个密码放在第一个启动菜单后面，是对第一个启动菜单生效的。设置后，选择第一个菜单启动后会需要输入密码后才能启动。<br><em>如下图所示：</em><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/grub/15.png" alt="image">  </p>
<h4 id="密文密码："><a href="#密文密码：" class="headerlink" title="密文密码："></a>密文密码：</h4><p>明文密码终究是不安全的，整个密码赤裸裸的容易被偷窥，所有我们也可以把密码设置为密文。  </p>
<h5 id="使用MD5加密："><a href="#使用MD5加密：" class="headerlink" title="使用MD5加密："></a>使用MD5加密：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># grub-md5-crypt</span></div><div class="line">Password:   //magedu</div><div class="line">Retype password: </div><div class="line"><span class="variable">$1</span><span class="variable">$ojFxT</span>/<span class="variable">$sqRFyURU7Ie0RturOYG1B1</span></div><div class="line">[root@MyCentOS6 ~]<span class="comment"># grub-md5-crypt </span></div><div class="line">Password:   //hello</div><div class="line">Retype password: </div><div class="line"><span class="variable">$1</span><span class="variable">$rwHxT</span>/<span class="variable">$Wm5QugEHbPnsd2vXLquzY</span>/</div></pre></td></tr></table></figure>
<p>把生成的密文复制粘贴到/boot/grub/grub.conf文件中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># vim /boot/grub/grub.conf </span></div><div class="line"><span class="comment">#boot=/dev/sda</span></div><div class="line"><span class="comment"># grub.conf generated by anaconda</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Note that you do not have to rerun grub after making changes to this file</span></div><div class="line"><span class="comment"># NOTICE:  You have a /boot partition.  This means that</span></div><div class="line"><span class="comment">#          all kernel and initrd paths are relative to /boot/, eg.</span></div><div class="line"><span class="comment">#          root (hd0,0)</span></div><div class="line"><span class="comment">#          kernel /vmlinuz-version ro root=/dev/sda2</span></div><div class="line"><span class="comment">#          initrd /initrd-[generic-]version.img</span></div><div class="line"><span class="comment">#boot=/dev/sda</span></div><div class="line">default=0</div><div class="line">timeout=5</div><div class="line"><span class="comment">#splashimage=(hd0,0)/grub/splash.xpm.gz</span></div><div class="line">password --md5 <span class="variable">$1</span><span class="variable">$ojFxT</span>/<span class="variable">$sqRFyURU7Ie0RturOYG1B1</span></div><div class="line">hiddenmenu</div><div class="line">title CentOS 6 (2.6.32-696.el6.x86_64)</div><div class="line">        root (hd0,0)</div><div class="line">        kernel /vmlinuz-2.6.32-696.el6.x86_64 ro root=UUID=811f130c-f1b2-423d-9149-29703</div><div class="line">0fbfe80 rd_NO_LUKS rd_NO_LVM LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashke</div><div class="line">rnel=auto  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet</div><div class="line">        initrd /initramfs-2.6.32-696.el6.x86_64.img</div><div class="line">        password --md5 <span class="variable">$1</span><span class="variable">$rwHxT</span>/<span class="variable">$Wm5QugEHbPnsd2vXLquzY</span>/</div></pre></td></tr></table></figure></p>
<h5 id="使用更安全的SHA512加密："><a href="#使用更安全的SHA512加密：" class="headerlink" title="使用更安全的SHA512加密："></a>使用更安全的SHA512加密：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># grub-crypt </span></div><div class="line">Password: </div><div class="line">Retype password: </div><div class="line"><span class="variable">$6</span><span class="variable">$XUXQ1PbCHSVFL7Pf</span><span class="variable">$5</span>/.NTV40xqUPUdPE2MUBmepR/SZZ/5CTR9TNNhEN09zcajDPBXTHCoy8fT2Pc9QAv1jz2/wfKywDx0JkhSGl./</div></pre></td></tr></table></figure>
<p>同样，需要把密码的密文复制粘贴到<code>/boot/grub/grub.conf</code>文件中，格式如下：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">password --encrypted <span class="variable">$6</span><span class="variable">$XUXQ1PbCHSVFL7Pf</span><span class="variable">$5</span>/.NTV40xqUPUdPE2MUBmepR/SZZ/5CTR9TNNhEN09zcajDPBXTHCoy8fT2Pc9QAv1jz2/wfKywDx0JkhSGl./</div></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/24/牛顿第一定律-很有哲理！/">牛顿第一定律--很有哲理！</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-24
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <blockquote>
<p>牛顿第一定律：<br>任何一个物体在不受外力的作用下，会一直保持静止或做匀速直线运动。  </p>
</blockquote>
<p><strong>人和事，不也是这样吗？</strong><br>如果想让事态能够按照自己的预期发展，不<code>努力</code>去改变当前的<code>状态</code>怎么能行？  </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/24/Linux常用命令总结-11、Linux计划任务/">Linux常用命令总结-11、Linux计划任务</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-24
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>在生产环境中，我们经常需要在某个时间点执行某个操作，或者需要周期性的重复执行某个操作，这时候我们就需要用到计划任务。  </p>
<h4 id="计划任务分类"><a href="#计划任务分类" class="headerlink" title="计划任务分类"></a>计划任务分类</h4><ul>
<li><p>未来的某个时间点执行一次任务</p>
<blockquote>
<p>at: 管理员指定时间执行执行指定的任务；<br>batch: 系统自行选择空闲时间去执行此处指定的任务；  </p>
</blockquote>
</li>
<li><p>周期性运行某个任务  </p>
<blockquote>
<p>cron  </p>
</blockquote>
</li>
</ul>
<h4 id="Linux的任务计划"><a href="#Linux的任务计划" class="headerlink" title="Linux的任务计划"></a>Linux的任务计划</h4><h5 id="at任务"><a href="#at任务" class="headerlink" title="at任务"></a>at任务</h5><p>用户可以通过使用at命令在指定的某个时间点执行一次任务。  </p>
<h6 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h6><ul>
<li><code>at</code>是一个外部命令，由软件包<code>at</code>提供，所以需要提供atd服务才能实现at任务。  </li>
<li>at命令详解：<br>使用格式：  <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">at [option] TIME</div></pre></td></tr></table></figure>
</li>
</ul>
<p>常用选项：<br><code>-V</code>: 显示版本信息:<br><code>-q QUEUE</code><br><code>-l</code>: 列出指定队列中等待运行的作业；相当于atq<br><code>-d</code>: 删除指定的作业；相当于atrm<br><code>-c</code>: 查看具体作业任务<br><code>-f /path/from/somefile</code>：从指定的文件中读取任务<br><code>-m</code>:当任务被完成之后，将给用户发送邮件，即使没有标准输出  </p>
<p>TIME:<br>定义执行at这项任务的时间<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">HH:MM [YYYY-mm-dd]</div><div class="line">noon:中午十二点)  </div><div class="line">midnight:半夜<span class="number">12</span>点  </div><div class="line">teatime:下午四点</div><div class="line">tomorrow:明天</div><div class="line">now+<span class="comment">#&#123;minutes,hours,days,OR weeks&#125;</span></div></pre></td></tr></table></figure></p>
<p>at时间格式：  </p>
<ul>
<li><code>HH:MM 02:00</code><br>在今日的 HH:MM 进行，若该时刻已过，则明天此时执行任务  </li>
<li><code>HH:MM YYYY-MM-DD 02:00 2016-09-20</code><br>规定在某年某月的某一天的特殊时刻进行该项任务  </li>
<li><p><code>HH:MM[am|pm] [Month] [Date]</code><br>例如：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">04</span>pm March <span class="number">17</span></div><div class="line"><span class="number">17</span>:<span class="number">20</span> tomorrow</div></pre></td></tr></table></figure>
</li>
<li><p><code>HH:MM[am|pm] + number [minutes|hours|days|weeks]</code><br>在某个时间点再加几个时间后才进行该项任务<br>例如：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">now + <span class="number">5</span> minutes</div><div class="line"><span class="number">02</span>pm + <span class="number">3</span> days</div></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="相关配置文件"><a href="#相关配置文件" class="headerlink" title="相关配置文件"></a>相关配置文件</h6><ol>
<li><code>/var/spool/at</code><br>at计划任务的队列存放在该目录中  </li>
<li><code>/etc/at.{allow,deny}</code><br><code>/etc/at.allow</code>默认不存在，只有该文件中的用户才能执行at命令<br><code>/etc/at.deny</code>默认存在，拒绝该文件中用户执行at命令， 而没有在at.deny 文件中的使用者则可执行;  <blockquote>
<p>注意：如果两个文件都不存在，只有 root 可以执行 at 命令  </p>
</blockquote>
</li>
</ol>
<h6 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h6><ul>
<li><p>交互式<br>设置在13:00在屏幕上输出“hello,world!”,并查看当前存在的计划任务  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]# at 13:00</div><div class="line">at&gt; echo hello,world!       //按Ctrl+D保存并退出at计划任务；</div><div class="line">at&gt; &lt;EOT&gt;</div><div class="line">job 3 at 2017-08-24 13:00</div><div class="line">Can't open /var/run/atd.pid to signal atd. No atd running?</div><div class="line">[root@MyCentOS6 ~]# at -l</div><div class="line">1       2017-08-24 13:00 a root</div></pre></td></tr></table></figure>
</li>
<li><p>输入重定向<br>设置14:00在屏幕上输出“wahaha”<br>使用<code>echo</code>重定向：  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]# echo "echo wahaha" | at 14:00</div><div class="line">job 4 at 2017-08-24 14:00</div><div class="line">Can't open /var/run/atd.pid to signal atd. No atd running?</div><div class="line">[root@MyCentOS6 ~]# at -l</div><div class="line">2       2017-08-24 14:00 a root</div><div class="line">1       2017-08-24 13:00 a root</div></pre></td></tr></table></figure>
</li>
</ul>
<p>使用<code>EOF</code>重定向:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># at 15:00 &lt;&lt;EOF</span></div><div class="line">&gt; echo wahaha</div><div class="line">&gt; EOF</div><div class="line">job <span class="number">7</span> at <span class="number">2017</span><span class="number">-08</span><span class="number">-24</span> <span class="number">15</span>:<span class="number">00</span></div><div class="line">Can<span class="string">'t open /var/run/atd.pid to signal atd. No atd running?</span></div></pre></td></tr></table></figure></p>
<ul>
<li>使用<code>at -f /path/to/somefile</code><br>设置15:00运行/root/at/at.sh脚本  <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">at -f /root/bin/at.sh <span class="number">15</span>:<span class="number">00</span></div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>Note: 作业的执行结果以邮件通知给相关用户  </p>
</blockquote>
<h5 id="batch"><a href="#batch" class="headerlink" title="batch"></a>batch</h5><p>让系统自行选择空闲时间去执行此处指定的任务  </p>
<h4 id="周期性计划任务cron"><a href="#周期性计划任务cron" class="headerlink" title="周期性计划任务cron"></a>周期性计划任务cron</h4><h5 id="相关的程序包"><a href="#相关的程序包" class="headerlink" title="相关的程序包"></a>相关的程序包</h5><ul>
<li><code>cronie</code>：主程序包，提供了crond守护进程及相关辅助工具；  </li>
<li><code>cronie-anacron</code>: cronie的补充流程；用于监控cronie任务执行状态；如cronie中的任务在过去该运行的的时间点未能正常运行，则anacron会随后启动一次此任务；  </li>
<li><code>crontabs</code>: 包含CentOS提供系统维护任务；<br><strong>确保crond任务处于运行状态</strong>  </li>
</ul>
<p>CentOS 6:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># service crond status</span></div><div class="line">crond (pid  <span class="number">1328</span>) <span class="keyword">is</span> running...</div></pre></td></tr></table></figure></p>
<p>CentOS 7:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#systemctl status crond</span></div><div class="line">● crond.service - Command Scheduler</div><div class="line">   Loaded: loaded (/usr/lib/systemd/system/crond.service; enabled; vendor preset: enabled)</div><div class="line">   Active: active (running) since Thu <span class="number">2017</span><span class="number">-08</span><span class="number">-24</span> <span class="number">14</span>:<span class="number">07</span>:<span class="number">03</span> CST; <span class="number">11</span>min ago</div><div class="line"> Main PID: <span class="number">674</span> (crond)</div><div class="line">   CGroup: /system.slice/crond.service</div><div class="line">           └─<span class="number">674</span> /usr/sbin/crond -n</div></pre></td></tr></table></figure></p>
<h5 id="周期性计划任务分类"><a href="#周期性计划任务分类" class="headerlink" title="周期性计划任务分类"></a>周期性计划任务分类</h5><p>计划要周期性执行的任务提交给crond，由其来实现到点运行。  </p>
<h6 id="系统cron任务"><a href="#系统cron任务" class="headerlink" title="系统cron任务"></a>系统cron任务</h6><p>系统维护作业。<br>相关配置文件<code>/etc/crontab</code>,详情参考<code>man 5 crontab</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 log]<span class="comment"># ll cron</span></div><div class="line">-rw-------. <span class="number">1</span> root root <span class="number">46145</span> Aug <span class="number">24</span> <span class="number">10</span>:<span class="number">10</span> cron</div><div class="line">[root@MyCentOS6 log]<span class="comment"># cat /etc/crontab </span></div><div class="line">SHELL=/bin/bash</div><div class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</div><div class="line">MAILTO=root</div><div class="line">HOME=/</div><div class="line"></div><div class="line"><span class="comment"># For details see man 4 crontabs</span></div><div class="line"></div><div class="line"><span class="comment"># Example of job definition:</span></div><div class="line"><span class="comment"># .---------------- minute (0 - 59)</span></div><div class="line"><span class="comment"># |  .------------- hour (0 - 23)</span></div><div class="line"><span class="comment"># |  |  .---------- day of month (1 - 31)</span></div><div class="line"><span class="comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span></div><div class="line"><span class="comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></div><div class="line"><span class="comment"># |  |  |  |  |</span></div><div class="line"><span class="comment"># *  *  *  *  * user-name command to be executed</span></div></pre></td></tr></table></figure></p>
<p><em>例如：晚上9点10分运行echo命令</em><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">10</span> <span class="number">21</span> * * * centos /bin/echo <span class="string">"Howdy!"</span></div></pre></td></tr></table></figure></p>
<p>系统的计划任务有：<br><code>/etc/crontab</code><br><code>/etc/cron.d/</code>: 配置文件<br><code>/etc/cron.hourly/</code>: 脚本<br><code>/etc/cron.daily/</code>: 脚本<br><code>/etc/cron.weekly/</code>: 脚本<br><code>/etc/cron.monthly/</code>:脚本</p>
<h6 id="用户cron任务"><a href="#用户cron任务" class="headerlink" title="用户cron任务"></a>用户cron任务</h6><p>使用crontab命令  </p>
<h5 id="cron任务时间表示法"><a href="#cron任务时间表示法" class="headerlink" title="cron任务时间表示法"></a>cron任务时间表示法</h5><ol>
<li>特定值：<br>给定时间点有限取值范围内的值；</li>
<li><code>*</code><br>给定时间点上有效取值范围内的所有值；表示”每…”;  </li>
<li>离散取值：<code>#，#，#</code></li>
<li>连续取值：-，例如：<code>#-#</code>  </li>
<li>在指定时间范围上，定义歩长<code>/#</code></li>
</ol>
<p><em>例如：每3小时echo命令：</em><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span> */<span class="number">3</span> * * * gentoo /bin/echo <span class="string">"howdy!"</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：day 和 week如果都存在时，两者为或的关系，day 或 week都会执行。  </p>
</blockquote>
<p>特殊时间格式表示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@reboot         Run once after reboot.</span></div><div class="line"><span class="meta">@yearly         0 0 1 1 *</span></div><div class="line"><span class="meta">@annually       0 0 1 1 *</span></div><div class="line"><span class="meta">@monthly        0 0 1 * *</span></div><div class="line"><span class="meta">@weekly         0 0 * * 0</span></div><div class="line"><span class="meta">@daily          0 0 * * *</span></div><div class="line"><span class="meta">@hourly         0 * * * *</span></div></pre></td></tr></table></figure></p>
<h5 id="用户cron详解："><a href="#用户cron详解：" class="headerlink" title="用户cron详解："></a>用户cron详解：</h5><p>crontab命令定义,每个用户都有专用的cron任务文件：/var/spool/cron/USERNAME  </p>
<h6 id="crontab命令："><a href="#crontab命令：" class="headerlink" title="crontab命令："></a>crontab命令：</h6><p>使用格式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">crontab [-u user] [-l | -r | -e] [-i] [-s]</div></pre></td></tr></table></figure></p>
<p>常用参数：<br><code>-l</code>: 列出所有任务；<br><code>-e</code>: 编辑任务；<br><code>-r</code>：移出所有任务；<br><code>-i</code>：同-r一同使用，以交互式模式让用户有选择地移除指定任务；<br><code>-u user</code>: 仅root可运行，代为为指定用户管理cron任务；  </p>
<h6 id="控制用户执行计划任务："><a href="#控制用户执行计划任务：" class="headerlink" title="控制用户执行计划任务："></a>控制用户执行计划任务：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/cron.&#123;allow,deny&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Note:<br>1.运行结果以邮件通知给相关用户：如果不想收到邮件通知，可用使用重定向：<br>2.对于cron任务来讲，%有特殊用途；如果在命令中要使用%，则需要转义；不过，如果把%放置于单引号中，也可以不用转义；</p>
</blockquote>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/22/好好敲实验吧，别再瞎折腾了！不做死就不会死！！/">好好敲实验吧，别再瞎折腾了！不做死就不会死！！</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-22
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>上周刚刚系统学习了一些网络知识，教室里的网络就成了同学们的实验场，所有的电脑和虚拟机都成了靶机……什么arp地址欺骗、IP地址冲突也接踵而来。后面的大哥，前段时间还经历了被莫名<code>rm -rf /</code>的困扰……<br>为此，我在所有的虚拟机上面添加了双网卡，其中一块设置为<code>仅主机</code>模式，并把sshd服务的监听地址设置为该网卡的IP地址。然后又在<code>/etc/hosts.allow</code>里面添加了允许的网段，毕竟只能宿主机ssh连接有点不现实，慢慢想办法优化加固吧！只要不被其他用户非法登录，其他问题都好说！可能在此您问有疑问：为什么不用iptables或Firewall做限制呢？先简单介绍一下我此时所处的环境吧—<code>马哥教育郑州校区25期Linux学习班</code>。因为要经常做实验、系统防火墙也还没学，好多时候防火墙设置不好严重影响实验结果。所以，不是不想用，是水平不够。<br>设置sshd服务监听IP：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vim /etc/ssh/sshd_config</div><div class="line"><span class="comment">#ListenAddress 0.0.0.0</span></div><div class="line">ListenAddress <span class="number">192.168</span><span class="number">.25</span><span class="number">.7</span></div></pre></td></tr></table></figure></p>
<p>注释掉原来的行，并重新添加<code>ListenAddress 仅主机网卡IP</code><br>设置访问限制：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vim /etc/hosts.allow</div><div class="line">#allow sshd</div><div class="line">sshd:192.168.25.*:allow     //允许仅主机IP网段</div><div class="line">sshd:172.18.222.254:allow   //允许物理机真实网卡IP</div><div class="line">sshd:all:deny           //拒绝所有</div></pre></td></tr></table></figure></p>
<p>其实这两个策略选择一个就好了，做访问限制策略应该比设置sshd监听IP更灵活一些……  </p>
<p>虚拟机设置好，开始折腾物理机…..  </p>
<p>先把网关的IP在物理机上做MAC地址绑定，防止arp地址欺骗：<br>网关IP：172.18.0.1<br>网关MAC：84-2b-2b-43-d0-50<br>在windows使用过管理员权限打开“命令提示符”在里面执行：<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function">C:\<span class="title">WINDOWS</span>\<span class="title">system32</span>&gt;<span class="title">arp</span> -<span class="title">s</span> 172.18.0.1 84-2<span class="title">b</span>-2<span class="title">b</span>-43-<span class="title">d0</span>-50</span></div><div class="line"><span class="title">C</span>:\<span class="title">WINDOWS</span>\<span class="title">system32</span>&gt;<span class="title">arp</span> -<span class="title">a</span></div><div class="line"></div><div class="line">接口: 192.168.25.1 --- 0<span class="title">x6</span></div><div class="line">  <span class="title">Internet</span> 地址         物理地址              类型</div><div class="line">  172.18.0.1            84-2<span class="title">b</span>-2<span class="title">b</span>-43-<span class="title">d0</span>-50     静态</div><div class="line">  192.168.25.7          00-0<span class="title">c</span>-29-06-99-<span class="title">f1</span>     动态</div><div class="line">  192.168.25.255        <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     静态</div><div class="line">  224.0.0.2             01-00-5<span class="title">e</span>-00-00-02     静态</div><div class="line">  224.0.0.22            01-00-5<span class="title">e</span>-00-00-16     静态</div><div class="line">  224.0.0.100           01-00-5<span class="title">e</span>-00-00-64     静态</div><div class="line">  224.0.0.252           01-00-5<span class="title">e</span>-00-00-<span class="title">fc</span>     静态</div><div class="line">  224.0.1.60            01-00-5<span class="title">e</span>-00-01-3<span class="title">c</span>     静态</div><div class="line">  234.123.12.1          01-00-5<span class="title">e</span>-7<span class="title">b</span>-0<span class="title">c</span>-01     静态</div><div class="line">  239.192.152.143       01-00-5<span class="title">e</span>-40-98-8<span class="title">f</span>     静态</div><div class="line">  239.255.255.250       01-00-5<span class="title">e</span>-7<span class="title">f</span>-<span class="title">ff</span>-<span class="title">fa</span>     静态</div><div class="line"></div><div class="line">接口: 172.18.125.254 --- 0<span class="title">x8</span></div><div class="line">  <span class="title">Internet</span> 地址         物理地址              类型</div><div class="line">  172.18.0.1            84-2<span class="title">b</span>-2<span class="title">b</span>-43-<span class="title">d0</span>-50     动态</div><div class="line">  172.18.0.104          <span class="title">b8</span>-88-<span class="title">e3</span>-79-1<span class="title">b</span>-20     动态</div><div class="line">  172.18.3.10           <span class="title">ec</span>-55-<span class="title">f9</span>-<span class="title">c2</span>-08-7<span class="title">a</span>     动态</div></pre></td></tr></table></figure></p>
<p>可以看到，因为有多个网卡，这个要绑定的arp表项被绑定到了第一个显示的网卡上。而且我在网上也并没有找到<code>arp -s</code>指定网卡的配置过程。扑街！<br>删除添加错误的arp表项：<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">C:\<span class="title">WINDOWS</span>\<span class="title">system32</span>&gt;<span class="title">arp</span> -<span class="title">d</span> 172.18.0.1</span></div></pre></td></tr></table></figure></p>
<p>在网上找的使用其他的方法完美解决：<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function">C:\<span class="title">WINDOWS</span>\<span class="title">system32</span>&gt;<span class="title">netsh</span> <span class="title">i</span> <span class="title">i</span> <span class="title">show</span> <span class="title">in</span>   //查看网卡对应的<span class="title">Idx</span>值</span></div><div class="line"></div><div class="line"><span class="title">Idx</span>     <span class="title">Met</span>         <span class="title">MTU</span>          状态                名称</div><div class="line">---  ----------  ----------  ------------  ---------------------------</div><div class="line"> 15          25        1500  <span class="title">disconnected</span>  <span class="title">WLAN</span></div><div class="line">  8          25        1500  <span class="title">connected</span>     以太网</div><div class="line"> 12          25        1500  <span class="title">disconnected</span>  本地连接* 2</div><div class="line">  1          75  4294967295  <span class="title">connected</span>     <span class="title">Loopback</span> <span class="title">Pseudo</span>-<span class="title">Interface</span> 1</div><div class="line">  9          55        1500  <span class="title">connected</span>     本地连接* 13</div><div class="line">  6          35        1500  <span class="title">connected</span>     <span class="title">VMware</span> <span class="title">Network</span> <span class="title">Adapter</span> <span class="title">VMnet1</span></div><div class="line"> 14          35        1500  <span class="title">connected</span>     <span class="title">VMware</span> <span class="title">Network</span> <span class="title">Adapter</span> <span class="title">VMnet8</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="title">C</span>:\<span class="title">WINDOWS</span>\<span class="title">system32</span>&gt;<span class="title">netsh</span> -<span class="title">c</span> "<span class="title">i</span> <span class="title">i</span>" <span class="title">add</span> <span class="title">ne</span> 8 172.18.0.1 84-2<span class="title">b</span>-2<span class="title">b</span>-43-<span class="title">d0</span>-50</div></pre></td></tr></table></figure></p>
<p>参数介绍：<br><code>netsh i i show in</code>为<code>netsh interface ipv4 show interfaces</code>的缩写.<br><code>netsh -c &#39;i i&#39; add ne Idx IP 对应MAC</code><br>查看arp表项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">C:\WINDOWS\system32&gt;arp -a</div><div class="line"></div><div class="line">接口: 172.18.125.254 --- 0x8</div><div class="line">  Internet 地址         物理地址              类型</div><div class="line">  172.18.0.1            84-2b-2b-43-d0-50     静态</div><div class="line">  172.18.252.89         68-f7-28-ae-6a-ab     动态</div><div class="line">  172.18.252.115        08-d4-0c-5b-e7-da     动态</div><div class="line">  172.18.255.255        ff-ff-ff-ff-ff-ff     静态</div><div class="line">  224.0.0.2             01-00-5e-00-00-02     静态</div><div class="line">  224.0.0.18            01-00-5e-00-00-12     静态</div><div class="line">  224.0.0.22            01-00-5e-00-00-16     静态</div><div class="line">  224.0.0.100           01-00-5e-00-00-64     静态</div><div class="line">  224.0.0.252           01-00-5e-00-00-fc     静态</div><div class="line">  224.0.1.60            01-00-5e-00-01-3c     静态</div><div class="line">  234.123.12.1          01-00-5e-7b-0c-01     静态</div><div class="line">  238.238.238.238       01-00-5e-6e-ee-ee     静态</div><div class="line">  239.192.152.143       01-00-5e-40-98-8f     静态</div><div class="line">  239.255.255.250       01-00-5e-7f-ff-fa     静态</div></pre></td></tr></table></figure></p>
<p>总算，成功添加了静态arp表项！其中还遇到了点其他问题，终极解决办法就是：<code>禁用所有的网络适配器，只保留要添加arp表项的网卡！</code>如果禁用网卡的话，使用<code>arp -s</code>添加应该也没问题了。  </p>
<p>后来，我还不满足，因为教室用的是<code>172.18.0.0/16</code>的B类网段，老师要求IP地址的第三位使用自己的学号设置静态IP，以避免冲突！如此一来，岂不是每个人固定了IP，只要知道学号就可以扫描对应的网段，查看某某某开了几台虚机、运行了什么服务了？  </p>
<p>坚决不！班里总共只有70+人，B类的大网段只用了三分之一的小子网，所有我就设置了一个<code>172.18.2xx.0/16</code>的网段。这样还不够！物理机的MAC地址是不是要改一下？改成什么更隐蔽更有个性呢？于是乎，我又把物理机网卡的MAC地址改成了使用VMware Warestation随机生成的一个MAC地址。  </p>
<p>然后，问题又来了！  </p>
<p>所有的虚拟机使用ping的时候，都显示类似ICMP重定向的结果…..<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]<span class="comment"># ping 172.18.0.1</span></div><div class="line">PING <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span> (<span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</div><div class="line">From <span class="number">172.18</span><span class="number">.222</span><span class="number">.254</span>: icmp_seq=<span class="number">1</span> Redirect Network(New nexthop: <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>)</div><div class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">1.77</span> ms</div><div class="line">From <span class="number">172.18</span><span class="number">.222</span><span class="number">.254</span>: icmp_seq=<span class="number">2</span> Redirect Network(New nexthop: <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>)</div><div class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.550</span> ms</div><div class="line">From <span class="number">172.18</span><span class="number">.222</span><span class="number">.254</span>: icmp_seq=<span class="number">3</span> Redirect Network(New nexthop: <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>)</div><div class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">172.18</span><span class="number">.0</span><span class="number">.1</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">64</span> time=<span class="number">0.671</span> ms</div></pre></td></tr></table></figure></p>
<p>阿西吧！看到这个问题，我内心是崩溃的，我并没有意识到是修改了物理机的MAC地址造成的。我检查了路由表、重设了IP、检查了防火墙、SELinux，最后又百度谷歌，检查了内核的ICMP转发设置…..直到最后我又打开了第三台虚拟机的时候，发现之前好好的虚拟机现在也出现了这个问题，我终于把问题定位到了物理机上，然后又各种检查…..换了网段、改了IP，又改了MAC…  </p>
<p>改了MAC之后，终于ping网关不再显示类似ICMP重定向的结果了…..  </p>
<p>也终于，结束了这次苦心的折腾！夜里11点半了，视频没看，实验没敲。虽然问题解决了，但是并没有找到具体原因，因为我检查了所有运行的虚拟机MAC,并没有MAC地址冲突。这个时间——浪费的太不值得！<br>好好敲试验吧，别再瞎折腾了！不做死就不会死！苦笑ing…</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/21/CentOS系列使用Tab命令补全/">CentOS系列使用Tab命令补全</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-21
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux小技巧/">Linux小技巧</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>使用CentOS系列的时候，有的系统能够在命令行终端使用Tab补全命令或显示命令的后续参数，有的就不可以。这是因为有的系统是最小化安装，没有安装<code>bash-completion.noarch</code>软件包。  </p>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><h5 id="CenOS-7系列可以直接使用yum安装"><a href="#CenOS-7系列可以直接使用yum安装" class="headerlink" title="CenOS 7系列可以直接使用yum安装"></a>CenOS 7系列可以直接使用yum安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y bash-completion</div></pre></td></tr></table></figure>
<h5 id="CenOS-6系列解决办法"><a href="#CenOS-6系列解决办法" class="headerlink" title="CenOS 6系列解决办法"></a>CenOS 6系列解决办法</h5><p>在CentOS 6系列中，这个软件存在EPEL源里，所有我们需要先配置一个可用的EPEL源，可参考<a href="http://blog.wangbinzhou.com/2017/08/05/yum%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA%E5%92%8Cyum%E6%BA%90%E9%85%8D%E7%BD%AE/">yum源配置方法</a>然后再使用yum安装,这里就不写详细步骤了；  </p>
<blockquote>
<p>注意: 配置完成之后，需要重新登陆后才能生效。 </p>
</blockquote>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/20/CentOS7网卡命名方式详解及修改为传统eth格式/">CentOS7网卡命名方式详解及修改为传统eth格式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-20
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>CentOS系统传统的网卡命名是使用以太网<code>eth[0,1,2,...]</code>和<code>wlan[0,1,2,...]</code>来命名的。但是到了CentOS 7系列，CentOS系统抛弃了传统的命名方式、采用了新的网卡命名机制来命名。新的命名机制避免了网卡名的冲突，但是也不给我们对系统网络的统一管理带来了不便，在这里我们详细介绍一下CentOS 7系列的网卡命名机制，以及修改回传统命名方式的方法。  </p>
<h4 id="网卡命名机制"><a href="#网卡命名机制" class="headerlink" title="网卡命名机制"></a>网卡命名机制</h4><p>CentOS 7系统对网络设备的命名方式：  </p>
<ol>
<li>如果Firmware或BIOS为主板上集成的设备提供的索引信息可用，且可预测则根据此索引进行命名，例如eno1；  </li>
<li>如果Firmware或BIOS为PCI-E扩展槽所提供的索引信息可用，且可预测，则根据此索引进行命名，例如ens1；  </li>
<li>如果硬件接口的物理位置信息可用，则根据此信息进行命名，例如enp2s0；  </li>
<li>如果用户显式启用，也可根据MAC地址进行命名，enx2387a2387a1dc56；  </li>
<li>上述均可不用时，则使用传统的<code>eth</code>命名机制；  </li>
</ol>
<p>上述命名机制中，有的需要biosdevname程序的参与；  </p>
<h4 id="网卡名称组成格式："><a href="#网卡名称组成格式：" class="headerlink" title="网卡名称组成格式："></a>网卡名称组成格式：</h4><h5 id="网卡名称的前两个字符"><a href="#网卡名称的前两个字符" class="headerlink" title="网卡名称的前两个字符"></a>网卡名称的前两个字符</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">en：ethernet    以太网</div><div class="line">wl: wlan        无线局域网</div><div class="line">ww: wwan        无线广域网</div></pre></td></tr></table></figure>
<h5 id="网卡名称的第三个字符根据设备类型选择："><a href="#网卡名称的第三个字符根据设备类型选择：" class="headerlink" title="网卡名称的第三个字符根据设备类型选择："></a>网卡名称的第三个字符根据设备类型选择：</h5><p><code>o&lt;index&gt;</code>: 集成设备的设备索引号；<br><code>s&lt;slot&gt;</code>: 扩展插槽的索引号；<br><code>x&lt;MAC&gt;</code>: 基于MAC地址的命名；<br><code>p&lt;bus&gt;s&lt;slot&gt;</code>: enp2s1  </p>
<h4 id="网卡设备的命名过程："><a href="#网卡设备的命名过程：" class="headerlink" title="网卡设备的命名过程："></a>网卡设备的命名过程：</h4><h5 id="第一步："><a href="#第一步：" class="headerlink" title="第一步："></a>第一步：</h5><p><code>udev</code>，辅助工具程序<code>/lib/udev/rename_device</code>,<code>/usr/lib/udev/rules.d/60-net.rules</code>  </p>
<h5 id="第二歩："><a href="#第二歩：" class="headerlink" title="第二歩："></a>第二歩：</h5><p><code>biosdevname</code> 会根据<code>/usr/lib/udev/rules.d/71-biosdevname.rules</code>  </p>
<h5 id="第三步："><a href="#第三步：" class="headerlink" title="第三步："></a>第三步：</h5><p>通过检测网络接口设备，根据<code>/usr/lib/udev/rules.d/75-net-description</code><br>ID_NET_NAME_ONBOARD, ID_NET_NAME_SLOT, ID_NET_NAME_PATH  </p>
<h4 id="修改回传统的命名方式："><a href="#修改回传统的命名方式：" class="headerlink" title="修改回传统的命名方式："></a>修改回传统的命名方式：</h4><p>配置前查看网卡命名：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#ifconfig</span></div><div class="line">ens32: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 172.18.234.200  netmask 255.255.0.0  broadcast 172.18.255.255</div><div class="line">        inet6 fe80::20c:29ff:fe06:99e7  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:06:99:e7  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 2875  bytes 237906 (232.3 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 12  bytes 888 (888.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</div><div class="line">        inet 127.0.0.1  netmask 255.0.0.0</div><div class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</div><div class="line">        loop  txqueuelen 1  (Local Loopback)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div></pre></td></tr></table></figure></p>
<h5 id="1-编辑-etc-default-grub配置文件"><a href="#1-编辑-etc-default-grub配置文件" class="headerlink" title="(1) 编辑/etc/default/grub配置文件"></a>(1) 编辑/etc/default/grub配置文件</h5><p>找到<code>GRUB_CMDLINE_LINUX</code>修改如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vim /etc/default/grub</div><div class="line">GRUB_TIMEOUT=5</div><div class="line">GRUB_DISTRIBUTOR=<span class="string">"<span class="variable">$(sed 's, release .*$,,g' /etc/system-release)</span>"</span></div><div class="line">GRUB_DEFAULT=saved</div><div class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></div><div class="line">GRUB_TERMINAL_OUTPUT=<span class="string">"console"</span></div><div class="line">GRUB_COMLINE_LINUX=<span class="string">"net.ifnames=0 rhgb quiet"</span></div><div class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></div></pre></td></tr></table></figure></p>
<h5 id="2-为grub2生成其配置文件"><a href="#2-为grub2生成其配置文件" class="headerlink" title="(2) 为grub2生成其配置文件"></a>(2) 为grub2生成其配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grub2-mkconfig -o /etc/grub2.cfg</div></pre></td></tr></table></figure>
<h5 id="3-重启系统"><a href="#3-重启系统" class="headerlink" title="(3) 重启系统"></a>(3) 重启系统</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">reboot</div></pre></td></tr></table></figure>
<p>检查是否网卡名称修改为eth的传统命名：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#ifconfig</span></div><div class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 172.18.251.228  netmask 255.255.0.0  broadcast 172.18.255.255</div><div class="line">        inet6 fe80::4463:d483:3b87:1c36  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 00:0c:29:06:99:e7  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 42  bytes 3400 (3.3 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 13  bytes 1490 (1.4 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line"></div><div class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</div><div class="line">        inet 127.0.0.1  netmask 255.0.0.0</div><div class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</div><div class="line">        loop  txqueuelen 1  (Local Loopback)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div></pre></td></tr></table></figure></p>
<h5 id="4-删除原来的网络配置文件ens32后创建新配置文件eth0，完成后重启网络服务即可"><a href="#4-删除原来的网络配置文件ens32后创建新配置文件eth0，完成后重启网络服务即可" class="headerlink" title="(4) 删除原来的网络配置文件ens32后创建新配置文件eth0，完成后重启网络服务即可"></a>(4) 删除原来的网络配置文件ens32后创建新配置文件eth0，完成后重启网络服务即可</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#cd /etc/sysconfig/network-scripts/</span></div><div class="line">[root@CentOS7 /etc/sysconfig/network-scripts]<span class="comment">#mv ifcfg-ens32 /tmp/</span></div><div class="line">[root@CentOS7 /etc/sysconfig/network-scripts]<span class="comment">#vim ifcfg-eth0</span></div><div class="line">TYPE=<span class="string">"Ethernet"</span></div><div class="line">BOOTPROTO=<span class="string">"static"</span></div><div class="line">IPADDR=<span class="string">"172.18.1.200"</span></div><div class="line">PREFIX=16</div><div class="line">GATEWAY=172.18.0.1</div><div class="line">DNS1=172.18.0.1</div><div class="line">DNS2=114.114.114.114</div><div class="line">DEFROUTE=<span class="string">"yes"</span></div><div class="line">PEERDNS=<span class="string">"yes"</span></div><div class="line">PEERROUTES=<span class="string">"yes"</span></div><div class="line">IPV4_FAILURE_FATAL=<span class="string">"no"</span></div><div class="line">NAME=<span class="string">"eth0"</span></div><div class="line">UUID=<span class="string">"4c86fd71-0281-4d10-a331-6ff63b387ec9"</span></div><div class="line">DEVICE=<span class="string">"eth0"</span></div><div class="line">ONBOOT=<span class="string">"yes"</span></div><div class="line">[root@CentOS7 ~]<span class="comment">#systemctl restart network</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Note: ifcfg-ens32 文件最好删除掉，否则重启 network 服务时会报错。</p>
</blockquote>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/10/内网ssh连接速度很慢的解决方案/">内网ssh连接速度很慢的解决方案</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-10
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>我在自己电脑上使用VMware Warkstation装了几台CentOS虚拟机做实验，CentOS虚拟机装了两块网卡分别作为内网卡和外网卡。内网卡使用<code>仅主机模式</code>作为管理口让宿主机来连接。在保证能够正常ping通、而且延时都小于1ms的情况下，宿主机使用SecureCRT通过ssh连接虚拟机的时候，个别主机出现连接时间过长的问题，有一个虚拟机竟然需要等待10-30S！  </p>
<p>人生苦短，时间宝贵，解决这个问题刻不容缓！  </p>
<h4 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h4><p>通过其他主机通过ssh连接问题主机：<br>使用<code>ssh</code>命令，通过<code>-v</code>参数来显示连接的详细过程：<br><code>v</code>最多能能加三个，加的越多，显示的越详细；<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">[root@MyCentOS6 ~]# ssh -v 192.168.25.7</div><div class="line">OpenSSH_5.3p1, OpenSSL 1.0.1e-fips 11 Feb 2013</div><div class="line">debug1: Reading configuration data /etc/ssh/ssh_config</div><div class="line">debug1: Applying options for *</div><div class="line">debug1: Connecting to 192.168.25.7 [192.168.25.7] port 22.</div><div class="line">debug1: Connection established.</div><div class="line">debug1: permanently_set_uid: 0/0</div><div class="line">debug1: identity file /root/.ssh/identity type -1</div><div class="line">debug1: identity file /root/.ssh/identity-cert type -1</div><div class="line">debug1: identity file /root/.ssh/id_rsa type -1</div><div class="line">debug1: identity file /root/.ssh/id_rsa-cert type -1</div><div class="line">debug1: identity file /root/.ssh/id_dsa type -1</div><div class="line">debug1: identity file /root/.ssh/id_dsa-cert type -1</div><div class="line">debug1: identity file /root/.ssh/id_ecdsa type -1</div><div class="line">debug1: identity file /root/.ssh/id_ecdsa-cert type -1</div><div class="line">debug1: Remote protocol version 2.0, remote software version OpenSSH_6.6.1</div><div class="line">debug1: match: OpenSSH_6.6.1 pat OpenSSH*</div><div class="line">debug1: Enabling compatibility mode for protocol 2.0</div><div class="line">debug1: Local version string SSH-2.0-OpenSSH_5.3</div><div class="line">debug1: SSH2_MSG_KEXINIT sent</div><div class="line">debug1: SSH2_MSG_KEXINIT received</div><div class="line">debug1: kex: server-&gt;client aes128-ctr hmac-sha1 none</div><div class="line">debug1: kex: client-&gt;server aes128-ctr hmac-sha1 none</div><div class="line">debug1: SSH2_MSG_KEX_DH_GEX_REQUEST(1024&lt;2048&lt;8192) sent</div><div class="line">debug1: expecting SSH2_MSG_KEX_DH_GEX_GROUP</div><div class="line">debug1: SSH2_MSG_KEX_DH_GEX_INIT sent</div><div class="line">debug1: expecting SSH2_MSG_KEX_DH_GEX_REPLY</div><div class="line">debug1: Host '192.168.25.7' is known and matches the RSA host key.</div><div class="line">debug1: Found key in /root/.ssh/known_hosts:1</div><div class="line">debug1: ssh_rsa_verify: signature correct</div><div class="line">debug1: SSH2_MSG_NEWKEYS sent</div><div class="line">debug1: expecting SSH2_MSG_NEWKEYS</div><div class="line">debug1: SSH2_MSG_NEWKEYS received</div><div class="line">debug1: SSH2_MSG_SERVICE_REQUEST sent</div><div class="line">debug1: SSH2_MSG_SERVICE_ACCEPT received</div><div class="line">debug1: Authentications that can continue: publickey,gssapi-keyex,gssapi-with-mic,password</div><div class="line">debug1: Next authentication method: gssapi-keyex</div><div class="line">debug1: No valid Key exchange context</div><div class="line">debug1: Next authentication method: gssapi-with-mic</div><div class="line">debug1: Unspecified GSS failure.  Minor code may provide more information</div><div class="line">Cannot determine realm for numeric host address</div><div class="line"></div><div class="line">debug1: Unspecified GSS failure.  Minor code may provide more information</div><div class="line">Cannot determine realm for numeric host address</div><div class="line"></div><div class="line">debug1: Next authentication method: publickey</div><div class="line">debug1: Trying private key: /root/.ssh/identity</div><div class="line">debug1: Trying private key: /root/.ssh/id_rsa</div><div class="line">debug1: Trying private key: /root/.ssh/id_dsa</div><div class="line">debug1: Trying private key: /root/.ssh/id_ecdsa</div><div class="line">debug1: Next authentication method: password</div><div class="line">root@192.168.25.7's password: </div><div class="line">debug1: Authentication succeeded (password).</div><div class="line">debug1: channel 0: new [client-session]</div><div class="line">debug1: Requesting no-more-sessions@openssh.com</div><div class="line">debug1: Entering interactive session.</div><div class="line">debug1: Sending environment.</div><div class="line">debug1: Sending env LANG = en_US.UTF-8</div><div class="line">Last login: Thu Aug 10 15:53:06 2017 from gateway</div><div class="line">[root@CentOS7 ~]#</div></pre></td></tr></table></figure></p>
<p>可以看到如下的错误信息：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">debug1: Next authentication method: gssapi-<span class="keyword">with</span>-mic</div><div class="line">debug1: An invalid name was supplied</div><div class="line">Cannot determine realm <span class="keyword">for</span> numeric host address</div></pre></td></tr></table></figure></p>
<p>从<code>gssapi-with-mic</code>这一行开始，就开始耗费时间了。  </p>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>修改<code>/etc/ssh/sshd_config</code>文件如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vim /etc/ssh/sshd_config</div><div class="line">UseDNS no</div><div class="line">GSSAPIAuthentication no</div></pre></td></tr></table></figure></p>
<p>找到上面的两个字段并修改，然后重启sshd服务：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl restart sshd</div></pre></td></tr></table></figure></p>
<p>参数说明：<br><code>UseDNS</code>:指定 是否应该对远程主机名进行反向解析，以检查此主机名是否与其IP地址真实对应。默认值为<code>yes</code>,改为<code>no</code>。<br><code>GSSAPIAuthentication</code>:是否允许使用基于 GSSAPI 的用户认证。默认值为<code>yes</code>,改为<code>no</code>。  </p>
<p>重启sshd服务后，再连接，应该就很快了！</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/05/yum仓库搭建和yum源配置/">yum仓库搭建和yum源配置</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-05
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux/">Linux</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>yum(Yellowdog Update Modifier)是rpm的前端程序，能够很好的解决软件包的相关依赖性。在日常工作中，我们可以使用安装光盘作为yum源，也可以使用阿里、网易或者搜狐提供的公共yum源。<br>在公司的网络环境中如果有很多台Centos服务器，我们就很有必要自己搭建一个yum仓库来统一管理和安装软件。这样既保证了软件包的来源合法性，又能够节省出口带宽、提高效率。  </p>
<h4 id="搭建yum仓库"><a href="#搭建yum仓库" class="headerlink" title="搭建yum仓库"></a>搭建yum仓库</h4><p>yum仓库有四种搭建方式，分别是：<code>http://</code>、<code>https://</code>、<code>ftp://</code>和<code>file://</code>；<br>在这里，我们分别使用<code>ftp://</code>和<code>http://</code>这两种方式进行仓库的搭建；  </p>
<h5 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h5><ul>
<li>yum仓库系统环境：CentOS 7.3  </li>
<li>http服务软件：httpd-2.4.6-45.el7.centos.4.x86_64  </li>
<li>ftp服务软件：vsftpd-3.0.2-21.el7.x86_64  </li>
<li>为避免干扰，临时关闭了SElinux和Firewalld；<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#setenforce 0       //临时关闭SElinux</span></div><div class="line"><span class="comment">#getenforce         //检查SElinux状态</span></div><div class="line"> Permissive			//打印警告而不是强制执行。</div><div class="line"><span class="comment">#systemctl stop firewalld   //关闭Firewalld防火墙；</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="使用ftp方式搭建yum仓库"><a href="#使用ftp方式搭建yum仓库" class="headerlink" title="使用ftp方式搭建yum仓库"></a>使用ftp方式搭建yum仓库</h5><p>yum安装vsftpd软件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#yum install -y vsftpd</span></div><div class="line"><span class="comment">#systemctl start vsftpd     //启动vsftpd服务；</span></div><div class="line"><span class="comment">#systemctl enable vsftpd    //设置vsftpd开机自启；</span></div></pre></td></tr></table></figure></p>
<p>查看vsftpd安装后的相关目录：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#rpm -ql vsftpd</span></div><div class="line">/etc/logrotate.d/vsftpd</div><div class="line">/etc/pam.d/vsftpd</div><div class="line">/etc/vsftpd/ftpusers</div><div class="line">/etc/vsftpd/user_list</div><div class="line">/etc/vsftpd/vsftpd.conf     //主配置文件</div><div class="line">    ...省略若干...</div><div class="line">/etc/vsftpd/vsftpd_conf_migrate.sh</div><div class="line">/usr/sbin/vsftpd</div><div class="line">/var/ftp/pub    //ftp文件共享目录；</div></pre></td></tr></table></figure></p>
<p>在这里，我们将CentOS安装光盘里面的软件包拷贝到yum仓库目录下，如有条件，也可以从公共的镜像站点下载相关软件包；<br><strong>yum仓库主要文件：</strong>  </p>
<ul>
<li>Packages&emsp;&emsp;//软件包目录</li>
<li>repodata&emsp;&emsp;//存储众多rpm包和包相关元数据文件，yum客户端通过查找该文件来判断yum仓库内是否有自己需要的rpm包；  </li>
<li>RPM-GPG-KEY-CentOS-7&emsp;&emsp;//软件包来源合法性校验KEY</li>
</ul>
<blockquote>
<p>Note: 这三个文件是yum仓库的必备文件，安装光盘里面的其他文件可拷可不拷；  </p>
</blockquote>
<p>在FTP目录下创建相关版本的目录：<br>创建一个系统主目录“centos”，并在目录下创建版本目录“6”和“7”：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#mkdir -pv /var/ftp/put/centos/&#123;6,7&#125;</span></div></pre></td></tr></table></figure></p>
<p>分别挂载CentOS6、7系列的光盘，并将光盘里的内容拷贝到FTP对应的目录下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#mount /dev/sr0 /media/cdrom</span></div><div class="line"><span class="comment">#cp -r /media/cdrom/* /var/ftp/pub/centos/6</span></div></pre></td></tr></table></figure></p>
<p>测试：在浏览器里面输入ftp://yum仓库IP；<br>如果能够正常访问并看到我们从光盘里面拷贝的软件包，就说明yum仓库搭建成功；  </p>
<h5 id="使用http方式搭建yum仓库"><a href="#使用http方式搭建yum仓库" class="headerlink" title="使用http方式搭建yum仓库"></a>使用http方式搭建yum仓库</h5><p>安装httpd软件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#yum install -y httpd</span></div><div class="line"><span class="comment">#systemctl start httpd      //启动httpd软件；</span></div><div class="line"><span class="comment">#systemctl enable httpd     //设置httpd开机自启；</span></div></pre></td></tr></table></figure></p>
<p>查看httpd软件安装生成的相关配置目录：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#rpm -ql httpd</span></div><div class="line">/etc/httpd</div><div class="line">/etc/httpd/conf</div><div class="line">...省略若干...</div><div class="line">/usr/sbin/apachectl</div><div class="line">/usr/sbin/fcgistarter</div><div class="line">/usr/sbin/htcacheclean</div><div class="line">/usr/sbin/httpd</div><div class="line">/usr/sbin/rotatelogs</div><div class="line">/usr/sbin/suexec</div><div class="line">/var/cache/httpd</div><div class="line">/var/cache/httpd/proxy</div><div class="line">/var/lib/dav</div><div class="line">/var/log/httpd</div><div class="line">/var/www/cgi-bin</div><div class="line">/var/www/html       //项目存放目录</div></pre></td></tr></table></figure></p>
<p>在/var/www/html下创建项目目录并将系统安装盘内容拷贝到相应目录下；（因为与FTP操作相同，在此省略相应操作）<br>下载<code>createrepo</code>，用来生成<code>repodata</code>文件。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">createrepo /var/www/html/centos/</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Note:如果使用系统安装光盘里面的软件包，并且不再往里面添加其他rpm包的话，可以直接使用系统盘自带的<code>repodata</code>文件；如果需要往里面添加新的rpm包组，或者自己搭建第三方yum仓库的话，就需要用<code>createrepo</code>软件生成<code>repodata</code>文件，否则yum客户端就找不到新添加的rpm包；<br>至此，我们的yum仓库已经搭建好了。接下来我们配置客户端的yum源。  </p>
</blockquote>
<h4 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h4><h5 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h5><p>yum客户端配置文件有两个：<br>1、为所有仓库提供公共配置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/yum.conf</div></pre></td></tr></table></figure></p>
<p>2、为仓库的指向提供配置：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/yum.repos.d/*.repo</div></pre></td></tr></table></figure></p>
<p>yum仓库指向的主要项有：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[repoID]</div><div class="line">name=<span class="string">"yum仓库名字"</span></div><div class="line">baseurl=<span class="string">"url指向yum仓库的系统相同版本目录下的repodata父目录即可"</span></div><div class="line">gpgcheck=&#123;<span class="number">1</span>|<span class="number">0</span>&#125;  //是否启用软件包来源合法性校验；</div><div class="line">gpgkey=<span class="string">"URL"</span>    //若启用校验，此处填写yum仓库的GPGKEY的url；</div><div class="line">enabled=&#123;<span class="number">0</span>|<span class="number">1</span>&#125;   //是否启用该yum源；<span class="number">0</span>为禁用，<span class="number">1</span>是启用；</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Note：使用yum的时候会到<code>/etc/yum.repos.d/</code>目录下查找<code>*.repo</code>文件，所有我们把系统的默认文件删除或移动到其他目录下，自己新建一个<code>*.repo</code>文件。  </p>
</blockquote>
<h5 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h5><p>将yum源修改为阿里云的yum源：<br>先把系统默认的yum源修改为.bak后缀作为备份：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#find /etc/yum.repos.d/ -name "*.repo" -exec mv &#123;&#125; &#123;&#125;.bak \;</span></div></pre></td></tr></table></figure></p>
<p>配置阿里云的yum源：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#vim /etc/yum.repos.d/centos.repo</span></div><div class="line">[aliyun]</div><div class="line">name=aliyun_yum</div><div class="line">baseurl=https://mirrors.aliyun.com/centos/$releasever/os/$basearch/</div><div class="line">gpgcheck=<span class="number">1</span></div><div class="line">gpgkey=https://mirrors.aliyun.com/centos/$releasever/os/$basearch/RPM-GPG-KEY-CentOS<span class="number">-7</span></div><div class="line">enabled=<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>验证修改是否已切换为阿里云的yum源：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#yum repolist all</span></div><div class="line">Loaded plugins: fastestmirror</div><div class="line">aliyun                                                          					| <span class="number">3.6</span> kB  <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>     </div><div class="line">(<span class="number">1</span>/<span class="number">2</span>): aliyun/primary_db                                        					| <span class="number">5.6</span> MB  <span class="number">00</span>:<span class="number">00</span>:<span class="number">06</span>     </div><div class="line">(<span class="number">2</span>/<span class="number">2</span>): aliyun/group_gz                                         						| <span class="number">155</span> kB  <span class="number">00</span>:<span class="number">00</span>:<span class="number">15</span>     </div><div class="line">Loading mirror speeds <span class="keyword">from</span> cached hostfile</div><div class="line">repo id                                 	repo name                                   status</div><div class="line">aliyun                                  	aliyun_yum                                  <span class="number">9</span>,<span class="number">363</span></div><div class="line">repolist: <span class="number">9</span>,<span class="number">363</span></div></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/08/01/Linux常用命令总结：10、文件查找之locate和find/">Linux常用命令总结：10、文件查找之locate和find</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-08-01
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>&emsp;&emsp;在日常生活中，有时候我们需要在Linux系统上查找符合特定条件的文件，可以通过命令<code>locate</code>和<code>find</code>来查找。<br><strong>区别：</strong><br><code>locate</code>: 非实时查找，每天会定时更新生成一个数据库，通过数据库查找；<br><code>find</code>: 实时查找；  </p>
<h4 id="locate"><a href="#locate" class="headerlink" title="locate"></a>locate</h4><p>&emsp;&emsp;<code>locate</code>命令依赖于系统系统在较为空闲时自动构建（周期性任务）的一个文件索引数据库<code>/var/lib/mlocate/mlocate.db</code>进行查找文件。索引构建过程需要遍历整个根文件系统，极消耗资源。管理员可以通过命令<code>updatedb</code>手动更新数据库。<br><strong>工作特点：</strong>  </p>
<ul>
<li>查找速度快；  </li>
<li>模糊查找；</li>
<li>非实时查找；</li>
<li>搜索的是文件的全路径，不仅仅是文件名；</li>
<li>可能只搜索用户具备读取和执行权限的目录；<br><strong>用法：</strong>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">locate [OPTION]... PATTERN...</div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>常用参数：</strong><br><code>-i</code>: 不区分大小写的搜索；<br><code>-n N</code>: 只列举前N个匹配项目；<br><code>-r</code>: 使用正则表达式搜索；<br><strong>示例：</strong><br><code>locate conf</code>: 搜索名称或路径中带有“conf”的文件；<br><code>locate -r &#39;\.conf$&#39;</code>: 使用正则表达式来搜索以“.conf”结尾的文件；  </p>
<h4 id="find"><a href="#find" class="headerlink" title="find"></a>find</h4><p>&emsp;&emsp;实时查找工具，通过遍历指定路径完成文件查找；  </p>
<h5 id="工作特点"><a href="#工作特点" class="headerlink" title="工作特点"></a>工作特点</h5><ul>
<li>查找速度略慢；  </li>
<li>精确查找；  </li>
<li>实时查找；  </li>
<li>可能只搜素用户具备读取和执行权限的目录；  </li>
</ul>
<h5 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find [OPTIOON]...[查找路径] [查找条件] [处理动作]</div></pre></td></tr></table></figure>
<p>查找路径：指定具体目标路径；默认为当前目录；<br>查找条件：指定的查找标准，可以是文件名、大小、类型、权限等标准进行；默认为找出指定路径下的所有文件；<br>处理动作：对符合条件的文件做操作，默认输出至屏幕；  </p>
<h6 id="查找条件："><a href="#查找条件：" class="headerlink" title="查找条件："></a>查找条件：</h6><p>指定搜索层级：<br><code>-maxdepth level</code>：最大搜索目录深度，指定目录为1级；<br><code>-mindepth level</code>：最小搜索目录深度；<br>根据文件名和inode查找：<br><code>-name &quot;文件名称&quot;</code>: 支持使用glob:<code>*,?,[],[^]</code>;<br><code>-iname &quot;文件名称&quot;</code>：不区分字母大小写；<br><code>inum n</code>: 按inode好查找；<br><code>-samefile name</code>: 相同inode号的文件；<br><code>-links n</code>: 链接数为n的文件；<br><code>-regex &quot;PATTERN&quot;</code>: 以PATTERN匹配整个文件路径字符串，而不仅仅是文件名称；<br>根据属主、属组查找：<br><code>-user USERNAME</code>:查找属主为指定用户（UID）的文件；<br><code>-group GRPNAME</code>:查找属组为指定组（GID）的文件；<br><code>uid UserID</code>:查找属主为指定的UID号的文件；<br><code>gid GroupID</code>:查找属组为指定的GID号的文件；<br><code>-nouser</code>:查找没有属主的文件；<br><code>-nogroup</code>:  查找没有属组的文件；<br>根据文件类型查找：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-<span class="built_in">type</span> TYPE:  </div><div class="line">            f: 普通文件</div><div class="line">            d: 目录文件</div><div class="line">            l: 符号链接文件</div><div class="line">            s: 套接字文件</div><div class="line">            b：块设备文件</div><div class="line">            c: 字符设备文件</div><div class="line">            p: 管道文件</div></pre></td></tr></table></figure></p>
<p>组合条件：<br>&emsp;&emsp;&emsp;&emsp;与：<code>-a</code><br>&emsp;&emsp;&emsp;&emsp;或：<code>-o</code><br>&emsp;&emsp;&emsp;&emsp;非：<code>-not,!</code><br>德·摩根定律：<br>&emsp;&emsp;&emsp;&emsp;&emsp;<code>(非 A) 或 (非 B) = 非(A 且 B)</code><br>&emsp;&emsp;&emsp;&emsp;&emsp;<code>(非 A) 且 (非 B) = 非(A 或 B)</code><br>&emsp;&emsp;示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">!A -a !B = !(A - oB)</div><div class="line">!A -O !B = !(A -a B)</div></pre></td></tr></table></figure></p>
<p>find示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">find -name snow.png     //搜索名为snow.png的文件</div><div class="line">find -iname snow.png    //不区分大小写地搜索名为snow.png、Snow.png、SNOW.PNG等等的文件</div><div class="line">find / -name <span class="string">"*.txt"</span>    //搜索/目录下.txt后缀的文件</div><div class="line">find /var -name <span class="string">"*log*"</span>     //搜索名称包含<span class="built_in">log</span>字符的文件</div><div class="line">find -user joe -group joe   //搜索被用户joe以及群组joe所拥有的文件</div><div class="line">find -user joe -not -group joe</div><div class="line">find -user joe -o -user jane</div><div class="line">find -not \( -user joe -o -user jane \)</div><div class="line">find / -user joe -o -uid 500</div></pre></td></tr></table></figure></p>
<p>&emsp;找出/tmp目录下，属主不是root，且文件名不以f开头的文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find /tmp \( -not -user root -a -not -name <span class="string">'f*'</span> \) -ls</div><div class="line">find /tmp -not \( -user root -o -name <span class="string">'f*'</span> \) -ls</div></pre></td></tr></table></figure></p>
<p>&emsp;排除目录：<br>&emsp;&emsp;<em>示例：查找/etc/下，除/etc/sane.d目录的其他所有.conf后缀的文件</em><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">find /etc -path <span class="string">'/etc/sane.d'</span> -a -prune -o -name <span class="string">"*.conf"</span></div><div class="line">find /etc \(-path <span class="string">'/etc/sane.d'</span> -o -path <span class="string">'/etc/fonts'</span> \) -a prune -o name <span class="string">"*.conf"</span></div></pre></td></tr></table></figure></p>
<p>根据文件大小来查找：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-size [+|-]<span class="comment">#UNIT    常用单位:k,M,G,c(byte)</span></div><div class="line"><span class="comment">#UNIT: (#-1,#]</span></div><div class="line">    如： 6k 表示（5k,6k]</div><div class="line">-<span class="comment">#UNIT: [0,#-1]</span></div><div class="line">    如： -6k 表示[0,5k]</div><div class="line">+<span class="comment">#UNIT： (#,∞)</span></div><div class="line">    如： +6k 表示(6k,∞)</div></pre></td></tr></table></figure></p>
<p>根据时间戳：<br>&emsp;<em>以“天”为单位：</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-atime [+|-]<span class="comment">#,</span></div><div class="line">	<span class="comment">#: [#,#+1)</span></div><div class="line">	+<span class="comment">#: [#+1,∞]</span></div><div class="line">    -<span class="comment">#: [0,#)</span></div><div class="line">    -mtime</div><div class="line">    -ctime</div></pre></td></tr></table></figure></p>
<p>&emsp;<em>以“分钟”为单位:</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-amin</div><div class="line">-mmin</div><div class="line">-cmin</div></pre></td></tr></table></figure></p>
<p>根据权限查找：<br><code>-perm [/|-]MODE</code><br>&emsp;<code>MODE</code>: 精确权限匹配<br>&emsp;<code>/MODE</code>：任何一类(u,g,o)对象的权限中只要能一位匹配即可，或关系， + 从centos7开始淘汰<br>&emsp;<code>-MODE</code>：每一类对象都必须同时拥有指定权限，与关系0 表示不关注  </p>
<blockquote>
<p>Note:<br>&emsp;&emsp;&emsp;find -perm 755 会匹配权限模式恰好是755的文件<br>&emsp;&emsp;&emsp;只要当任意人有写权限时， find -perm +222就会匹配<br>&emsp;&emsp;&emsp;只有当每个人都有写权限时， find -perm -222才会匹配<br>&emsp;&emsp;&emsp;只有当其它人（other）有写权限时， find -perm -002才会匹配</p>
</blockquote>
<h6 id="处理动作："><a href="#处理动作：" class="headerlink" title="处理动作："></a>处理动作：</h6><p><code>-print</code>：默认的处理动作，显示至屏幕<br><code>-ls</code>：类似于对查找到的文件执行“ls -l”命令<br><code>-delete</code>：删除查找到的文件<br><code>-fls file</code>：查找到的所有文件的长格式信息保存至指定文件中<br><code>-ok COMMAND {} \;</code>: 对查找到的每个文件执行由COMMAND指定的命令，对于每个文件执行命令之前，都会交互式要求用户确认<br><code>-exec COMMAND {} \;</code> 对查找到的每个文件执行由COMMAND指定的命令<br><code>{}</code>: 用于引用查找到的文件名称自身find传递查找到的文件至后面指定的命令时，查找到所有符合条件的文件一次性传递给后面的命令  </p>
<h6 id="参数替换xargs："><a href="#参数替换xargs：" class="headerlink" title="参数替换xargs："></a>参数替换xargs：</h6><p>由于很多命令不支持管道|来传递参数，而日常工作中有这个必要，所以就有了xargs命令。xargs用于产生某个命令的参数， xargs 可以读入 stdin的数据，并且以空格符或回车符将 stdin 的数据分隔成为arguments。  </p>
<blockquote>
<p>注意：文件名或者是其他意义的名词内含有空格符的情况有些命令不能接受过多参数，命令执行可能会失败， xargs可以解决.  </p>
</blockquote>
<p>&emsp;示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ls f* |xargs rm</div><div class="line">find /sbin -perm +700 |ls -l 这个命令是错误的</div><div class="line">find /sbin -perm +7000 | xargs ls –l</div><div class="line">find和xargs格式： find | xargs COMMAND</div></pre></td></tr></table></figure></p>
<h5 id="find示例："><a href="#find示例：" class="headerlink" title="find示例："></a>find示例：</h5><p>备份配置文件，添加.orig这个扩展名:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find -name “*.conf” -<span class="keyword">exec</span> cp &#123;&#125; &#123;&#125;.orig \;</div></pre></td></tr></table></figure></p>
<p>提示删除存在时间超过３天以上的joe的临时文件:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find /tmp -ctime +<span class="number">3</span> -user joe -ok rm &#123;&#125; \;</div></pre></td></tr></table></figure></p>
<p>提示删除存在时间超过３天以上的joe的临时文件:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find ~ -perm <span class="number">-002</span> -<span class="keyword">exec</span> chmod o-w &#123;&#125; \;</div></pre></td></tr></table></figure></p>
<p>搜索/data目录下权限为644、后缀为“.sh”的普通文件后，把权限修改为755；<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find /data –type f -perm <span class="number">644</span> -name “*.sh” –<span class="keyword">exec</span> chmod <span class="number">755</span> &#123;&#125; \;</div></pre></td></tr></table></figure></p>
<p>搜索/home下的目录文件，并列表查看：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find /home –type d -ls</div></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/27/使用Squid-Stunnel代理上网/">使用Squid+Stunnel代理上网</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-27
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h5 id="一、简介："><a href="#一、简介：" class="headerlink" title="一、简介："></a><strong>一、简介：</strong></h5><p>&emsp;&emsp;作为一个IT从业者，经常需要到Google上面去查找一些技术相关的资料。但是由于……(此处省略若干字)，我们无法访问谷歌。因为上家单位属于互联网公司的缘故，我接触到了使用Squid + Stunnel科学上网的方式。<br>&emsp;&emsp;关于下面的配置步骤，各位看官如果发现有错误或需要优化的地方，欢迎指正和发表建议！新手上路，请多多关照！</p>
<h5 id="二、安装环境及原理："><a href="#二、安装环境及原理：" class="headerlink" title="二、安装环境及原理："></a><strong>二、安装环境及原理：</strong></h5><p>&emsp;&emsp;<strong>服务端：</strong>阿里云香港区ECS主机（CentOS 7.3.1611）一台；<br>&emsp;&emsp;<strong>软件：</strong>squid-3.5.20-2.el7_3.3.x86_64&emsp;stunnel-4.56-6.el7.x86_64<br>&emsp;&emsp;<strong>客户端：</strong>stunnel-5.39-win32-installer.exe&emsp;&amp;&emsp;Proxy SwitchyOmega（Chrome扩展程序）<br>&emsp;&emsp;<strong>原理：</strong>当客户端访问谷歌时,Stunnel的客户端通过和服务端建立起加密连接，由Squid代理用户去请求谷歌网站并把请求结果通过Stunnel的加密隧道返回给客户端；</p>
<h5 id="三、服务端配置："><a href="#三、服务端配置：" class="headerlink" title="三、服务端配置："></a><strong>三、服务端配置：</strong></h5><h6 id="emsp-1、服务端安装配置Squid："><a href="#emsp-1、服务端安装配置Squid：" class="headerlink" title="&emsp;1、服务端安装配置Squid："></a>&emsp;1、服务端安装配置Squid：</h6> <figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#yum install -y squid                   //yum安装Squid</span></div><div class="line"><span class="comment">#vim /etc/squid/squid.conf              //修改配置文件</span></div><div class="line">    <span class="comment"># And finally deny all other access to this proxy</span></div><div class="line">    <span class="comment">#http_access deny all               //注释掉该行</span></div><div class="line">    http_access allow all               //复制上一行，将“deny”改为“allow”</div><div class="line">    <span class="comment"># Squid normally listens to port 3128</span></div><div class="line">    http_port <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3128</span>            //在端口前加入本地回环地址，只允许本地访问；</div></pre></td></tr></table></figure>
<h6 id="emsp-2、服务端安装Stunnel："><a href="#emsp-2、服务端安装Stunnel：" class="headerlink" title="&emsp;2、服务端安装Stunnel："></a>&emsp;2、服务端安装Stunnel：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#yum install -y stunnel     //yum安装Stunnel</span></div></pre></td></tr></table></figure>
<h6 id="emsp-3、生成加密代理证书："><a href="#emsp-3、生成加密代理证书：" class="headerlink" title="&emsp;3、生成加密代理证书："></a>&emsp;3、生成加密代理证书：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#cd /etc/stunnel</span></div><div class="line"><span class="comment">#openssl req -new -x509 -days 3650 -nodes -out stunnel.pem -keyout stunnel.pem     //生成证书</span></div><div class="line">Generating a <span class="number">2048</span> bit RSA private key</div><div class="line">.....+++</div><div class="line">....+++</div><div class="line">writing new private key to <span class="string">'stunnel.pem'</span></div><div class="line">-----</div><div class="line">You are about to be asked to enter information that will be incorporated</div><div class="line">into your certificate request.</div><div class="line">What you are about to enter <span class="keyword">is</span> what <span class="keyword">is</span> called a Distinguished Name <span class="keyword">or</span> a DN.</div><div class="line">There are quite a few fields but you can leave some blank</div><div class="line">For some fields there will be a default value,</div><div class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</div><div class="line">-----</div><div class="line">Country Name (<span class="number">2</span> letter code) [XX]:CN                            //国家字母代码</div><div class="line">State <span class="keyword">or</span> Province Name (full name) []:BeiJing                   //省份</div><div class="line">Locality Name (eg, city) [Default City]:BeiJing                 //城市</div><div class="line">Organization Name (eg, company) [Default Company Ltd]:          //组织名称</div><div class="line">Organizational Unit Name (eg, section) []:                      //组织单位名称</div><div class="line">Common Name (eg, your name <span class="keyword">or</span> your serve<span class="string">r's hostname) []:       //当前系统的主机名</span></div><div class="line">Email Address []:                                               //邮件地址</div></pre></td></tr></table></figure>
<p>&emsp;结束后会在/etc/stunnel/目录下生成一个stunnel.pem的文件；</p>
<h6 id="emsp-4、配置Stunnel："><a href="#emsp-4、配置Stunnel：" class="headerlink" title="&emsp;4、配置Stunnel："></a>&emsp;4、配置Stunnel：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#vim /etc/stunnel/stunnel.conf      //stunnel.conf如果没有可以自行创建；</span></div><div class="line">client = no</div><div class="line">cert = /etc/stunnel/stunnel.pem     //配置加密代理证书</div><div class="line">CAfile = /etc/stunnel/stunnel.pem</div><div class="line">[https]</div><div class="line">accept = <span class="number">34567</span>                      //服务端口</div><div class="line">connect = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3128</span>            //指向本地的Squid服务端口</div></pre></td></tr></table></figure>
<h6 id="emsp-5、启动服务并检查："><a href="#emsp-5、启动服务并检查：" class="headerlink" title="&emsp;5、启动服务并检查："></a>&emsp;5、启动服务并检查：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#systemctl start squid.service      //启动Squid；</span></div><div class="line"><span class="comment">#stunnel        //启动Stunnel；</span></div><div class="line"><span class="comment">#ss -tunlp      //检测端口判断服务是否启动；</span></div><div class="line">Netid State      Recv-Q Send-Q       Local Address:Port        Peer Address:Port</div><div class="line">tcp   LISTEN     <span class="number">0</span>      <span class="number">128</span>              <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3128</span>                   *:*           //squid服务            </div><div class="line">tcp   LISTEN     <span class="number">0</span>      <span class="number">128</span>                      *:<span class="number">34567</span>                  *:*           //Stunnel服务</div></pre></td></tr></table></figure>
<h6 id="emsp-6、对公网开放34567端口；"><a href="#emsp-6、对公网开放34567端口；" class="headerlink" title="&emsp;6、对公网开放34567端口；"></a>&emsp;6、对公网开放34567端口；</h6><p>&emsp;在Centos 7的默认防火墙Firewall上放行TCP:34567端口:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#firewall-cmd --zone=public --add-port=34567/tcp --permanent</span></div></pre></td></tr></table></figure></p>
<p>&emsp;在阿里云控制台里面添加端口映射后，在客户端上面测试是否能够正常访问Stunnel端口：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">C:\Users\wang&gt;telnet Service_IP <span class="number">34567</span></div></pre></td></tr></table></figure></p>
<p>&emsp;如果命令执行后没有报错，cmd.exe窗口显示的是一个黑屏，说明服务能够正常使用；</p>
<h5 id="四、客户端配置："><a href="#四、客户端配置：" class="headerlink" title="四、客户端配置："></a><strong>四、客户端配置：</strong></h5><h6 id="emsp-1、安装stunnel-exe客户端后直接运行；"><a href="#emsp-1、安装stunnel-exe客户端后直接运行；" class="headerlink" title="&emsp;1、安装stunnel.exe客户端后直接运行；"></a>&emsp;1、安装stunnel.exe客户端后直接运行；</h6><h6 id="emsp-2、配置Stunnel客户端："><a href="#emsp-2、配置Stunnel客户端：" class="headerlink" title="&emsp;2、配置Stunnel客户端："></a>&emsp;2、配置Stunnel客户端：</h6><p>&emsp;&emsp;在电脑托盘里右键单击Stunnel图标，选择“Edit Configure”后清空预配添加如下配置:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">client=yes</div><div class="line">[https]</div><div class="line">accept=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8088</span>       //在浏览器里面添加的代理地址和端口号；</div><div class="line">connect=Service_IP:<span class="number">34567</span>      //对应服务器的IP和端口；</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我使用的是Chrome浏览器，在里面添加了Proxy SwitchyOmega扩展程序，能够灵活的设置代理上网，也可以添加相应的匹配规则，让需要代理网址的走Stunnel访问，国内的网站正常（不走Stunnel）的访问；</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/27/Linux常用命令总结-9、正则表达式/">Linux常用命令总结-9、正则表达式</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-27
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>&emsp;&emsp;<strong>正则表达式（REGEXP）</strong>是一类字符所书写的模式，其中很多字符不表示其字面意义，而是表达控制或通配等功能。通常被用来检索、替换那些符合某个规则的文本。  </p>
<h4 id="程序支持"><a href="#程序支持" class="headerlink" title="程序支持"></a>程序支持</h4><p>&emsp;&emsp;<em>Grep,Sed,Awk,Vim, Less,Nginx,Varnish等;</em>  </p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>&emsp;&emsp;基本正则表达式：BRE<br>&emsp;&emsp;扩展正则表达式：ERE  </p>
<h4 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h4><p>&emsp;&emsp;不表示其字面意义，而用于额外功能性描述；<br>&emsp;&emsp;<strong>元字符分类:</strong>字符匹配、匹配次数、位置锚定，分组；  </p>
<h5 id="基本正则表达式的元字符："><a href="#基本正则表达式的元字符：" class="headerlink" title="基本正则表达式的元字符："></a>基本正则表达式的元字符：</h5><h6 id="字符匹配："><a href="#字符匹配：" class="headerlink" title="字符匹配："></a>字符匹配：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">. 匹配任意单个字符</div><div class="line">[] 匹配指定范围内的任意单个字符</div><div class="line">[^] 匹配指定范围外的任意单个字符</div><div class="line">[0-9],[:digit:] 十进制数字 </div><div class="line">[a-z],[:lower:] 小写字母</div><div class="line">[A-Z],[:upper:] 大写字母</div><div class="line">[:alpha:] 代表任何英文大小写字符，亦即 A-Z, a-z</div><div class="line">[:alnum:] 字母和数字</div><div class="line">[:space:] 水平和垂直的空白字符（比[:blank:]包含的范围广）</div><div class="line">[:blank:] 空白字符（空格和制表符）</div><div class="line">[:cntrl:] 不可打印的控制字符（退格、删除、警铃...）</div><div class="line">[:xdigit:]十六进制数字</div><div class="line">[:graph:] 可打印的非空白字符</div><div class="line">[:<span class="built_in">print</span>:] 可打印字符</div><div class="line">[:punct:] 标点符号</div></pre></td></tr></table></figure>
<h6 id="匹配次数："><a href="#匹配次数：" class="headerlink" title="匹配次数："></a>匹配次数：</h6><p>&emsp;&emsp;<strong>作用:</strong> 用于实现指定其前面的字符所能够出现的次数.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">* 匹配前面的字符任意次，包括0次(贪婪模式：尽可能长的匹配)</div><div class="line">.* 任意长度的任意字符</div><div class="line">\? 匹配其前面的字符0或1次</div><div class="line">\+ 匹配其前面的字符至少1次</div><div class="line">\&#123;n\&#125; 匹配前面的字符n次</div><div class="line">\&#123;m,n\&#125; 匹配前面的字符至少m次，至多n次</div><div class="line">\&#123;,n\&#125; 匹配前面的字符至多n次</div><div class="line">\&#123;n,\&#125; 匹配前面的字符至少n次</div></pre></td></tr></table></figure></p>
<h6 id="位置锚定："><a href="#位置锚定：" class="headerlink" title="位置锚定："></a>位置锚定：</h6><p>&emsp;&emsp;<strong>作用:</strong> 定位出现的位置；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">^ 行首锚定，写在模式的最左侧</div><div class="line">$ 行尾锚定，写在模式的最右侧</div><div class="line">^PATTERN$ 用于模式匹配整行</div><div class="line">^$ 空行</div><div class="line">^[[:space:]]*$ 空白行</div><div class="line">\&lt; 或 \b 词首锚定，用于单词模式的左侧   </div><div class="line">\&gt; 或 \b 词尾锚定；用于单词模式的右侧</div><div class="line">\&lt;PATTERN\&gt; 匹配整个单词</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Note:不包含特殊字符的连续字符组成的串叫单词：</p>
</blockquote>
<h6 id="分组："><a href="#分组：" class="headerlink" title="分组："></a>分组：</h6><p>&emsp;&emsp;<code>\(\)</code>将一个或多个字符捆绑在一起，当作一个整体进行处理.<br>&emsp;&emsp;<strong>如：</strong> <code>\(root\)\+</code></p>
<p>&emsp;&emsp;分组括号中的模式匹配到的内容会被正则表达式引擎记录于内部的变量中,这些变量的命名方式为:<code>\1, \2, \3, ...</code><br>&emsp;&emsp;<code>\1</code> 表示从左侧起第一个左括号以及与之匹配右括号之间的模式所匹配到的字符<br><strong>示例：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">\(string1\+\(string2\)*\)</div><div class="line">\1 ： string1\+\(string2\)*</div><div class="line">\2 ： string2</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>后向引用：</strong>引用前面的分组括号中的模式所匹配字符，而非模式本身.  </p>
<h6 id="或者："><a href="#或者：" class="headerlink" title="或者：\|"></a>或者：<code>\|</code></h6><p>&emsp;&emsp;示例：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">a\|b: a或b C\|cat: C或cat \(C\|c\)at:Cat或cat</div></pre></td></tr></table></figure></p>
<h5 id="扩展正则表达式的元字符："><a href="#扩展正则表达式的元字符：" class="headerlink" title="扩展正则表达式的元字符："></a>扩展正则表达式的元字符：</h5><h6 id="字符匹配：-1"><a href="#字符匹配：-1" class="headerlink" title="字符匹配："></a>字符匹配：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">. 任意单个字符</div><div class="line">[] 指定范围的字符</div><div class="line">[^] 不在指定范围的字符</div></pre></td></tr></table></figure>
<h6 id="次数匹配："><a href="#次数匹配：" class="headerlink" title="次数匹配："></a>次数匹配：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">*：匹配前面字符任意次</div><div class="line">?: 0或1次</div><div class="line">+： 1次或多次</div><div class="line">&#123;m&#125;：匹配m次</div><div class="line">&#123;m,n&#125;：至少m，至多n次</div></pre></td></tr></table></figure>
<h6 id="位置锚定：-1"><a href="#位置锚定：-1" class="headerlink" title="位置锚定："></a>位置锚定：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">^ :行首</div><div class="line">$ :行尾</div><div class="line">\&lt;, \b :语首</div><div class="line">\&gt;, \b :语尾</div></pre></td></tr></table></figure>
<h6 id="分组：-1"><a href="#分组：-1" class="headerlink" title="分组："></a>分组：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">()</div><div class="line">后向引用： \1, \2, ...</div></pre></td></tr></table></figure>
<h6 id="或者：-1"><a href="#或者：-1" class="headerlink" title="或者："></a>或者：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">a|b: a或b</div><div class="line">C|cat: C或cat</div><div class="line">(C|c)at:Cat或cat</div></pre></td></tr></table></figure>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-8、vim文本编辑器/">Linux常用命令总结-8、vim文本编辑器</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-7、文本处理工具/">Linux常用命令总结-7、文本处理工具</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>&emsp;&emsp;作为运维人员，我们经常需要查看、分析和统计日志等信息，在这里，我对初级的文本处理工具的学习做一个小总结。<br><strong>本文提到的命令：</strong><br>&emsp;&emsp;<em>查看文件内容：</em> <code>cat</code>、<code>more</code>、<code>less</code><br>&emsp;&emsp;<em>文件截取：</em> <code>head</code> 和 <code>tail</code><br>&emsp;&emsp;<em>按列抽取:</em>  <code>cut</code><br>&emsp;&emsp;<em>文本数据统计：</em> <code>wc</code><br>&emsp;&emsp;<em>文本排序：</em> <code>sort</code><br>&emsp;&emsp;<em>去重复的行：</em> <code>uniq</code><br>&emsp;&emsp;<em>按关键字抽取：</em><code>grep</code>  </p>
<h4 id="文件查看命令"><a href="#文件查看命令" class="headerlink" title="文件查看命令"></a>文件查看命令</h4><h5 id="标准输入文件：cat"><a href="#标准输入文件：cat" class="headerlink" title="标准输入文件：cat"></a>标准输入文件：cat</h5><p><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数:</strong><br><code>-E</code>: 显示行结束符&amp;；<br><code>-n</code>: 对显示出的每一行进行编号；<br><code>-A</code>: 显示所有控制符；<br><code>-b</code>: 非空行编号；<br><code>-s</code>: 压缩连续的空行成一行；  </p>
<h5 id="分页查看文件：more"><a href="#分页查看文件：more" class="headerlink" title="分页查看文件：more"></a>分页查看文件：more</h5><p><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">more [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-d</code>: 显示翻页及退出提示；</p>
<h5 id="按页查看文件：less"><a href="#按页查看文件：less" class="headerlink" title="按页查看文件：less"></a>按页查看文件：less</h5><p><strong>用法:</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">less [FILE]...</div></pre></td></tr></table></figure></p>
<p><em>查看时常用的命令：</em><br><code>/文本</code>: 搜索“文本”；<br><code>n/N</code>: 跳到<code>下一个</code>或<code>上一个</code>匹配；</p>
<blockquote>
<p>Note: man命令使用的就是less分页器；</p>
</blockquote>
<h5 id="显示文本前-行的内容：head"><a href="#显示文本前-行的内容：head" class="headerlink" title="显示文本前#行的内容：head"></a>显示文本前#行的内容：head</h5><p><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">head [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-c #</code>: 指定获取前#字节；<br><code>-n #</code>: 指定获取前#字节；<br><code>-#</code>: 指定行数；  </p>
<h5 id="显示文本后-行的内容：tail"><a href="#显示文本后-行的内容：tail" class="headerlink" title="显示文本后#行的内容：tail"></a>显示文本后#行的内容：tail</h5><p><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-c #</code>: 指定获取后#字节；<br><code>-n #</code>: 指定获取后#字节；<br><code>- #</code>: 指定行数；<br><code>-f</code>: 跟踪显示文件新追加的内容，常用日志监控；  </p>
<h4 id="文本处理类命令："><a href="#文本处理类命令：" class="headerlink" title="文本处理类命令："></a>文本处理类命令：</h4><h5 id="按列抽取文本：cut"><a href="#按列抽取文本：cut" class="headerlink" title="按列抽取文本：cut"></a>按列抽取文本：cut</h5><p><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cut [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-d DELIMITER</code>: 指明分隔符，默认tab；<br><code>-f FILEDS</code>:<br>&emsp;&emsp;<code>#</code>: 第#字段；<br>&emsp;&emsp;<code>#,#[,#]</code>: 离散的多个字段，例如1,3,6；<br>&emsp;&emsp;<code>#-#</code>: 1-3,7;<br>&emsp;&emsp;<code>-c</code>: 按字符切割；<br>&emsp;&emsp;<code>--output-delimiter=STRING</code>指明输出分隔符；<br><strong>示例：</strong><br>显示文件或STDIN数据的指定列：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cut</span> -d: -f1 /etc/passwd</div><div class="line"><span class="variable">$cat</span> /etc/passwd | cut -d: -f7</div><div class="line"><span class="variable">$cut</span> -c2-5 /usr/share/dict/words</div></pre></td></tr></table></figure></p>
<h5 id="合并两个文件同行号的列到一行：paste"><a href="#合并两个文件同行号的列到一行：paste" class="headerlink" title="合并两个文件同行号的列到一行：paste"></a>合并两个文件同行号的列到一行：paste</h5><p><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">paste [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-d 分隔符</code>: 指定分隔符，默认用TAB;<br><code>-s</code>: 所有行合成一行显示；<br><strong>示例：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$paste</span> f1 f2</div><div class="line"><span class="variable">$paste</span> -s f1 f2</div></pre></td></tr></table></figure></p>
<h5 id="文本数据统计：wc"><a href="#文本数据统计：wc" class="headerlink" title="文本数据统计：wc"></a>文本数据统计：wc</h5><p>&emsp;&emsp;对文件或STDIN（标准输出）的数据，做单词总数、行总数、字节总数字符总数的统计。<br><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wc [OPTION]...[FILE]...</div><div class="line"></div><div class="line"><span class="variable">$wc</span> story.txt</div><div class="line">39      237     1901        story.txt</div><div class="line">行数    字数    字符数</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-l</code>: 只统计行数；<br><code>-w</code>: 只统计单词总数；<br><code>-c</code>: 只统计字节总数；<br><code>-m</code>: 只统计字符总数；  </p>
<h5 id="文本排序：-sort"><a href="#文本排序：-sort" class="headerlink" title="文本排序： sort"></a>文本排序： sort</h5><p>&emsp;&emsp;把整理过的文本显示在标准输出，不会改变原始文件。<br><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sort [OPTIONS]...[FILES]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-r</code>: 执行反方向（由上至下）整理；<br><code>-n</code>: 执行按数字大小整理；<br><code>-f</code>: 选项忽略（fold）字符串中的字符大小写；<br><code>-u</code>: 选项（独特，unique）删除输出中的重复行；<br><code>-t c</code>: 选项使用<code>c</code>作为字符界定符；<br><code>-k X</code>: 选项安装使用<code>c</code>字符分隔的<code>X</code>列来整理能够使用多次；  </p>
<h5 id="去除重复的行：uniq"><a href="#去除重复的行：uniq" class="headerlink" title="去除重复的行：uniq"></a>去除重复的行：uniq</h5><p>&emsp;&emsp;从输入中删除前后相接的重复的行；<br><strong>用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uniq [OPTION]...[FILE]...</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>-c</code>: 显示每行重复出现的次数；<br><code>-d</code>: 仅显示重复出现的行；<br><code>-u</code>: 仅显示不曾重复的行；</p>
<blockquote>
<p>Note: 连续且完全想用方为重复；<br>常和sort命令一起配合使用：<code>sort userlist.txt | uniq -c</code></p>
</blockquote>
<h5 id="文件对比：diff-和-patch"><a href="#文件对比：diff-和-patch" class="headerlink" title="文件对比：diff 和 patch"></a>文件对比：diff 和 patch</h5><h6 id="比较文件：diff"><a href="#比较文件：diff" class="headerlink" title="比较文件：diff"></a>比较文件：diff</h6><p>&emsp;&emsp;比较两个文件之间的区别；<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$diff foo.conf-broken foo.conf-works5c5</div><div class="line">&lt;   use_widgets = no</div><div class="line">---</div><div class="line">&gt;   use_widgets = yes</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注明第5行有区别（改变）。  </p>
</blockquote>
<h6 id="复制对文件改变：patch"><a href="#复制对文件改变：patch" class="headerlink" title="复制对文件改变：patch"></a>复制对文件改变：patch</h6><p><code>diff</code>: 命令的输入被保存在一种叫做“补丁”的文件中。 </p>
<blockquote>
<p>使用<code>-u</code>选项来输出“统一的（unified）”diff格式文件，最适用于补丁文件。<br><code>patch</code>: 复制在其它文件中进行的改变（要谨慎使用）<br>使用<code>-b</code>选项来自动备份改变了的文件；<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$diff -u foo.conf-broken foo.conf-works &gt; foo.patch</div><div class="line">$patch -b foo.conf-broken foo.patch</div></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="文本过滤：grep"><a href="#文本过滤：grep" class="headerlink" title="文本过滤：grep"></a>文本过滤：grep</h4><p>&emsp;&emsp;文本搜索工具，根据用户指定的正则表达式字符及文本字符所编写的过滤条件，对目标文本逐行进行匹配检查，打印匹配到的行。<br><strong>用法：</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">grep [OPTIONS] PATTERN [FILE...]</div><div class="line">    grep root /etc/passwd</div><div class="line">    grep <span class="string">"$USER"</span> /etc/passwd</div><div class="line">    grep <span class="string">'$USER'</span> /etc/passwd</div><div class="line">    grep `whoami` /etc/passwd</div></pre></td></tr></table></figure></p>
<p><strong>参数：</strong><br><code>--color=auto</code>: 对匹配到的文本着色显示；（Centos 7默认已使用alias设置此参数）<br><code>-v</code>: 显示不被pattern匹配到的行；<br><code>-i</code>: 忽略字符大小写；<br><code>-n</code>: 显示匹配的行号；<br><code>-c</code>: 统计匹配的行数；<br><code>-o</code>: 仅显示匹配到的字符串；<br><code>-q</code>: 静默模式，不输出任何信息;<br><code>-A #</code> : after,同时显示匹配行的后#行;<br><code>-B #</code>: before,同时显示匹配行的前#行；<br><code>-c #</code>: context,同时显示匹配行的前后各#行；<br><code>-e</code>: 实现多个选项间的逻辑or关系；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -e <span class="string">'cat'</span> -e <span class="string">'dog'</span> file</div></pre></td></tr></table></figure></p>
<p><code>-w</code>: 匹配整个单词；<br><code>-E</code>: 使用ERE;<br><code>-F</code>: 相当于fgrep，不支持正则表达式；</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-6、用户组和权限管理/">Linux常用命令总结-6、用户组和权限管理</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-5、重定向和管道/">Linux常用命令总结-5、重定向和管道</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-4、文件管理类命令/">Linux常用命令总结-4、文件管理类命令</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-2、文件管理类命令/">Linux常用命令总结-2、文件管理类命令</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-1、线上查询及帮助命令/">Linux常用命令总结-1、线上查询及帮助命令</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令/">Linux常用命令</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>&emsp;&emsp;Linux命令分为<strong>内部命令</strong>和<strong>外部命令</strong>；<br>&emsp;&emsp;<strong>内部命令：</strong> 由shell自带的命令。在系统启动时就调入内存，是常驻内存的，所以执行效率高。<br>&emsp;&emsp;<strong>外部命令：</strong> 由系统的软件提供的命令；，用户需要时才从硬盘中读入内存；  </p>
<h4 id="判断一个命令是否为内部命令：type"><a href="#判断一个命令是否为内部命令：type" class="headerlink" title="判断一个命令是否为内部命令：type"></a>判断一个命令是否为内部命令：type</h4><p>&emsp;&emsp;<strong>常见用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">type</span> COMMAND</div></pre></td></tr></table></figure></p>
<h4 id="显示内部命令列表：help"><a href="#显示内部命令列表：help" class="headerlink" title="显示内部命令列表：help"></a>显示内部命令列表：help</h4><p>&emsp;&emsp;<strong>常见用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#help</span></div></pre></td></tr></table></figure></p>
<h4 id="列出内部命令列表：enable"><a href="#列出内部命令列表：enable" class="headerlink" title="列出内部命令列表：enable"></a>列出内部命令列表：enable</h4><p>&emsp;&emsp;<strong>常见用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">enable</span> COMMAND: 启用内部命令；</div><div class="line">        -n COMMAND: 禁用某个命令；</div><div class="line">        -n：查看被禁用的所有内部命令；</div></pre></td></tr></table></figure></p>
<h4 id="hash缓存表："><a href="#hash缓存表：" class="headerlink" title="hash缓存表："></a>hash缓存表：</h4><p>&emsp;&emsp;系统初始hash表为空，当外部命令执行时，默认会从PATH路径下寻找该命令，找到后会将这条命令的路径记录到hash表中，当再次使用该命令时， shell解释器首先会查看hash表，存在将执行之，如果不存在，将会去PATH路径下寻找。利用hash缓存表可大大提高命令的调用速率。<br>&emsp;&emsp;<strong>常见用法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">hash</span>: 显示<span class="built_in">hash</span>缓存</div><div class="line"><span class="built_in">hash</span> –l: 显示<span class="built_in">hash</span>缓存，可作为输入使用</div><div class="line"><span class="built_in">hash</span> –p path name: 将命令全路径path起别名为name</div><div class="line"><span class="built_in">hash</span> –t name: 打印缓存中name的路径</div><div class="line"><span class="built_in">hash</span> –d name: 清除name缓存</div><div class="line"><span class="built_in">hash</span> –r: 清除缓存</div></pre></td></tr></table></figure></p>
<h4 id="使用命令帮助：man"><a href="#使用命令帮助：man" class="headerlink" title="使用命令帮助：man"></a>使用命令帮助：man</h4><p>&emsp;&emsp;手册存放在<code>/usr/share/man</code>里，几乎每个命令都有man的“页面”;<br>&emsp;&emsp;<strong>配置文件：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/man.config | man_db.conf</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>常用选项：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">man [OPTION] COMMAND</div><div class="line">    -M：到指定位置下搜索COMMAND命令的手册页并显示；</div><div class="line">    -a：列出所有帮助；</div><div class="line">    -k：列出所有匹配的页面，使用whatis数据库；</div><div class="line">    -f：相当于whatis；</div><div class="line">    -w：打印man帮助的文件路径；</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>man命令的操作方法：使用less命令实现</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">space,^v,^f，^F: 向文件尾部翻屏；</div><div class="line">b,^b: 向文首部翻屏；</div><div class="line">d,^d: 向文件尾部翻半屏；</div><div class="line">u，^u: 向文件首部翻半屏；</div><div class="line">RETURN,^N,e,^E or ^J: 向文件尾部翻一行；</div><div class="line">y or ^Y or ^P or k or ^K：向文件首部翻一行</div><div class="line">q: 退出</div><div class="line"><span class="comment">#：跳转至第#行</span></div><div class="line">1G: 回到文件首部</div><div class="line">G：翻至文件尾部</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>使用man搜索：</strong><br>&emsp;&emsp;&emsp;<strong>/KEYWORD:</strong><br>&emsp;&emsp;&emsp;&emsp; &emsp;以KEYWORD指定的字符串为关键字，从当前位置向文件尾部搜索；不区分字符大小写；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<strong>n: 下一个<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;N：上一个</strong><br>&emsp;&emsp;&emsp;<strong>?KEYWORD:</strong><br>&emsp;&emsp;&emsp;&emsp;&emsp;以KEYWORD指定的字符串为关键字，从当前位置向文件首部搜索；不区分字符大小写；<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<strong>n: 跟搜索命令同方向，下一个<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;N：跟搜索命令反方向，上一个</strong>  </p>
<h4 id="info-适合通用文档参考"><a href="#info-适合通用文档参考" class="headerlink" title="info: 适合通用文档参考:"></a>info: 适合通用文档参考:</h4><p>&emsp;&emsp;<strong>使用方法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#info COMMAND</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;没有参数，列出所有的页面；页面结构就想一个网站，每一页分为“节点”，链接节点之前*<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">方向键: PgUp， PgDn 导航  </div><div class="line">Tab键: 移动到下一个链接  </div><div class="line">d: 显示主题目录  </div><div class="line">Home: 显示主题首部  </div><div class="line">Enter: 进入选定链接  </div><div class="line">n/p/u/l: 进入下/前/上一层/最后一个链接  </div><div class="line">s: 文字 文本搜索  </div><div class="line">q: 退出 info</div></pre></td></tr></table></figure></p>
<h4 id="查看命令或文件的的路径-whereis"><a href="#查看命令或文件的的路径-whereis" class="headerlink" title="查看命令或文件的的路径: whereis"></a>查看命令或文件的的路径: whereis</h4><p>&emsp;&emsp;显示命令的简短描述；(需要使用数据库，刚安装后不可立即使用)<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;makewhatis | mandb 制作数据库<br>&emsp;&emsp;&emsp;&emsp;<strong>使用示例：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">whatis cal </div><div class="line">    或 </div><div class="line">man -f cal</div></pre></td></tr></table></figure></p>
<h4 id="查看外部命令的路径which："><a href="#查看外部命令的路径which：" class="headerlink" title="查看外部命令的路径which："></a>查看外部命令的路径which：</h4><p>&emsp;&emsp;查看可执行程序文件的路径<br>&emsp;&emsp;<strong>常用选项：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">which</span> [OPTION]...COMMAND</div><div class="line">        -a: 查看全部</div><div class="line">        --skip-alias：忽略别名</div></pre></td></tr></table></figure></p>
<h4 id="命令别名：alias"><a href="#命令别名：alias" class="headerlink" title="命令别名：alias"></a>命令别名：alias</h4><p>&emsp;&emsp;<strong>使用示例：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">alias</span> NAME=<span class="string">'VALUE'</span>   //定义别名NAME,其相当于执行命令VALUE:  </div><div class="line"><span class="built_in">alias</span>：显示当前shell进程所有可用的命令别名；</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>Note:</strong> 在命令行中定义的别名，仅对当前shell进程有效，如果想永久有效，要定义在配置文件中：<br>&emsp;&emsp;&emsp;&emsp;<strong>仅对当前用户：</strong>~/.bashrc<br>&emsp;&emsp;&emsp;&emsp;<strong>对所有用户有效：</strong>/etc/bashrc<br>&emsp;&emsp;&emsp;编辑配置给出的新配置不会立即生效，需要使用source重新读取配置文件；</p>
</blockquote>
<h4 id="撤销命令别名：-unalias"><a href="#撤销命令别名：-unalias" class="headerlink" title="撤销命令别名：    unalias"></a>撤销命令别名：    unalias</h4><p>&emsp;&emsp;<strong>使用示例：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">unalias</span> [OPTION] NAME</div><div class="line">        -a：取消所有别名；</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>如果别名同原命令同名，如果要执行原命令，可以使用：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">\COMMAND</div><div class="line"><span class="string">'COMMAND'</span></div><div class="line">/PATH/COMMAND:外部命令</div></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/25/Linux常用命令总结-目录/">Linux常用命令总结-目录</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-25
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="Linux常用命令总结"><a href="#Linux常用命令总结" class="headerlink" title="Linux常用命令总结"></a>Linux常用命令总结</h4><h6 id="1、线上查询及帮助命令"><a href="#1、线上查询及帮助命令" class="headerlink" title="1、线上查询及帮助命令"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-1%E3%80%81%E7%BA%BF%E4%B8%8A%E6%9F%A5%E8%AF%A2%E5%8F%8A%E5%B8%AE%E5%8A%A9%E5%91%BD%E4%BB%A4/">1、线上查询及帮助命令</a></h6><h6 id="2、文件管理类命令"><a href="#2、文件管理类命令" class="headerlink" title="2、文件管理类命令"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-2%E3%80%81%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E7%B1%BB%E5%91%BD%E4%BB%A4/">2、文件管理类命令</a></h6><h6 id="3、查看命令历史"><a href="#3、查看命令历史" class="headerlink" title="3、查看命令历史"></a><a href="http://blog.wangbinzhou.com/2017/07/22/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-3%E3%80%81%E6%9F%A5%E7%9C%8B%E5%91%BD%E4%BB%A4%E5%8E%86%E5%8F%B2/">3、查看命令历史</a></h6><h6 id="4、文件管理类命令"><a href="#4、文件管理类命令" class="headerlink" title="4、文件管理类命令"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-4%E3%80%81%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E7%B1%BB%E5%91%BD%E4%BB%A4/">4、文件管理类命令</a></h6><h6 id="5、重定向和管道"><a href="#5、重定向和管道" class="headerlink" title="5、重定向和管道"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-5%E3%80%81%E9%87%8D%E5%AE%9A%E5%90%91%E5%92%8C%E7%AE%A1%E9%81%93/">5、重定向和管道</a></h6><h6 id="6、用户组和权限管理"><a href="#6、用户组和权限管理" class="headerlink" title="6、用户组和权限管理"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-6%E3%80%81%E7%94%A8%E6%88%B7%E7%BB%84%E5%92%8C%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/">6、用户组和权限管理</a></h6><h6 id="7、文本处理工具"><a href="#7、文本处理工具" class="headerlink" title="7、文本处理工具"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-7%E3%80%81%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/">7、文本处理工具</a></h6><h6 id="8、vim文本编辑器"><a href="#8、vim文本编辑器" class="headerlink" title="8、vim文本编辑器"></a><a href="http://blog.wangbinzhou.com/2017/07/25/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-8%E3%80%81vim%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/">8、vim文本编辑器</a></h6><h6 id="9、正则表达式"><a href="#9、正则表达式" class="headerlink" title="9、正则表达式"></a><a href="http://blog.wangbinzhou.com/2017/07/27/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-9%E3%80%81%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">9、正则表达式</a></h6><h6 id="10、文件查找之locate和find"><a href="#10、文件查找之locate和find" class="headerlink" title="10、文件查找之locate和find"></a><a href="http://blog.wangbinzhou.com/2017/08/01/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93%EF%BC%9A10%E3%80%81%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE%E4%B9%8Blocate%E5%92%8Cfind/">10、文件查找之locate和find</a></h6><h6 id="11、Linux计划任务"><a href="#11、Linux计划任务" class="headerlink" title="11、Linux计划任务"></a><a href="http://blog.wangbinzhou.com/2017/08/24/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93-11%E3%80%81Linux%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/">11、Linux计划任务</a></h6>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/07/22/Linux常用命令总结-3、查看命令历史/">Linux常用命令总结-3、查看命令历史</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-07-22
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Linux常用命令总结/">Linux常用命令总结</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h4><h5 id="emsp-1、说明："><a href="#emsp-1、说明：" class="headerlink" title="&emsp;1、说明："></a>&emsp;1、说明：</h5><p>&emsp;&emsp;&emsp;<strong>history是Shell的内置命令，用来查看以前执行过的命令。</strong>  </p>
<h5 id="emsp-2、配置文件"><a href="#emsp-2、配置文件" class="headerlink" title="&emsp;2、配置文件"></a>&emsp;2、配置文件</h5><p>&emsp;&emsp;&emsp;<strong>当登陆Shell时，会读取命令历史文件~/.bash_history中记录下的命令。登录进shell后新执行的命令只会记录在缓存中，这些命令在用户退出时会“追加”至命令历史文件~/.bash_history中。</strong></p>
<h4 id="二、相关参数"><a href="#二、相关参数" class="headerlink" title="二、相关参数"></a>二、相关参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">history</span>:</div><div class="line">		-c: 清空历史命令；  </div><div class="line">		-d: 删除历史中的第N个命令；  </div><div class="line">		 N: 显示最近的N条历史；  </div><div class="line">		-a: 追加本次会话新执行的命令至命令历史文件中;  </div><div class="line">		-n: 读命令历史文件中未读过的行到历史列表；  </div><div class="line">		-r: 读命令历史文件附加到历史列表；  </div><div class="line">		-w: 保存历史列表到指定的命令历史文件中；  </div><div class="line">		-p: 展开历史参数成多行，但不存在历史列表中；  </div><div class="line">		-s: 展开历史参数成一行，附加在历史列表后；</div></pre></td></tr></table></figure>
<h4 id="三、history的常用快捷方式"><a href="#三、history的常用快捷方式" class="headerlink" title="三、history的常用快捷方式"></a>三、history的常用快捷方式</h4><h5 id="emsp-1-重复前一个命令的4个方法："><a href="#emsp-1-重复前一个命令的4个方法：" class="headerlink" title="&emsp;1. 重复前一个命令的4个方法："></a>&emsp;1. 重复前一个命令的4个方法：</h5><h6 id="emsp-emsp-emsp-按↑键并回车执行"><a href="#emsp-emsp-emsp-按↑键并回车执行" class="headerlink" title="&emsp;&emsp;&emsp;按↑键并回车执行;"></a>&emsp;&emsp;&emsp;按<strong>↑</strong>键并回车执行;</h6><h6 id="emsp-emsp-emsp-按-并执行回车；"><a href="#emsp-emsp-emsp-按-并执行回车；" class="headerlink" title="&emsp;&emsp;&emsp;按 !!并执行回车；"></a>&emsp;&emsp;&emsp;按 <strong>!!</strong>并执行回车；</h6><h6 id="emsp-emsp-emsp-输入-1并执行回车"><a href="#emsp-emsp-emsp-输入-1并执行回车" class="headerlink" title="&emsp;&emsp;&emsp;输入!-1并执行回车;"></a>&emsp;&emsp;&emsp;输入<strong>!-1</strong>并执行回车;</h6><h6 id="emsp-emsp-emsp-按Ctrl-P并执行回车；"><a href="#emsp-emsp-emsp-按Ctrl-P并执行回车；" class="headerlink" title="&emsp;&emsp;&emsp;按Ctrl+P并执行回车；"></a>&emsp;&emsp;&emsp;按<strong>Ctrl+P</strong>并执行回车；</h6><h5 id="emsp-2-在命令历史中搜索命令："><a href="#emsp-2-在命令历史中搜索命令：" class="headerlink" title="&emsp;2. 在命令历史中搜索命令："></a>&emsp;2. 在命令历史中搜索命令：</h5><h6 id="emsp-emsp-emsp-Ctrl-r-在命令历史中搜索命令；"><a href="#emsp-emsp-emsp-Ctrl-r-在命令历史中搜索命令；" class="headerlink" title="&emsp;&emsp;&emsp;Ctrl + r : 在命令历史中搜索命令；"></a>&emsp;&emsp;&emsp;<strong>Ctrl + r</strong> : 在命令历史中搜索命令；</h6><h6 id="emsp-emsp-emsp-Ctrl-g-从命令历史搜索模式中退出；"><a href="#emsp-emsp-emsp-Ctrl-g-从命令历史搜索模式中退出；" class="headerlink" title="&emsp;&emsp;&emsp;Ctrl + g : 从命令历史搜索模式中退出；"></a>&emsp;&emsp;&emsp;<strong>Ctrl + g</strong> : 从命令历史搜索模式中退出；</h6><h5 id="emsp-3-要重新调用前一个命令中最后一个参数："><a href="#emsp-3-要重新调用前一个命令中最后一个参数：" class="headerlink" title="&emsp;3. 要重新调用前一个命令中最后一个参数："></a>&emsp;3. 要重新调用前一个命令中最后一个参数：</h5><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Alt + .:	按住Alt键的同时点击 . 键</div><div class="line">Esc, . :	点击Esc键后松开，然后点击 . 键</div><div class="line">	 !$:	表示</div></pre></td></tr></table></figure>
<h5 id="emsp-4-其他命令历史快捷方式"><a href="#emsp-4-其他命令历史快捷方式" class="headerlink" title="&emsp;4. 其他命令历史快捷方式"></a>&emsp;4. 其他命令历史快捷方式</h5><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">				  !n:	执行history命令输出对应序列号n的命令；  </div><div class="line">				 !-n:	执行history历史中倒数第n个命令；  </div><div class="line">				 !:<span class="number">0</span>:	执行前一条命令(去除参数);  </div><div class="line">			Ctrl + n:	显示当前历史中的下一条命令，但不执行；  </div><div class="line">			Ctrl + j:	执行当前命令；  </div><div class="line">			 !string:	重复前一个以“string”开头的命令；  </div><div class="line">			!?string:	重复前一个包含string的命令；  </div><div class="line">		   !string:p:	仅打印历史命令而不执行；  </div><div class="line">			 ^string:	删除上一条命令中第一个string；  </div><div class="line">	^string1^string2:	将上一条命令中的第一个string1替换为string2；  </div><div class="line">!:gs/string1/string2:	将上一条命令中所有的string1都替换为string2;</div></pre></td></tr></table></figure>
<h5 id="emsp-5-调用历史参数："><a href="#emsp-5-调用历史参数：" class="headerlink" title="&emsp;5. 调用历史参数："></a>&emsp;5. 调用历史参数：</h5><figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">command !^: 利用上一个命令的第一个参数做<span class="built_in">cmd</span>的参数;  </div><div class="line">command !$: 利用上一个命令的最后一个参数做<span class="built_in">cmd</span>的参数;  </div><div class="line">command !*: 利用上一个命令的全部参数做<span class="built_in">cmd</span>的参数;  </div><div class="line">command !:n: 利用上一个命令的第n个参数做<span class="built_in">cmd</span>的参数;  </div><div class="line">command !n:^: 调用第n条命令的第一个参数;  </div><div class="line">command !n:$: 调用第n条命令的最后一个参数;  </div><div class="line">command !n:m: 调用第n条命令的第m个参数;  </div><div class="line">command !n:*: 调用第n条命令的所有参数;  </div><div class="line">command !string:^: 从命令历史中搜索以 string 开头的命令，并获取它的第一个参数;  </div><div class="line">command !string:$: 从命令历史中搜索以 string 开头的命令,并获取它的最后一个参数;  </div><div class="line">command !string:n: 从命令历史中搜索以 string 开头的命令，并获取它的第n个参数;  </div><div class="line">command !string:*: 从命令历史中搜索以 string 开头的命令，并获取它的所有参数;  </div><div class="line">```  </div><div class="line">##### 四、命令历史相关环节变量：</div><div class="line">```dos</div><div class="line">HISTSIZE：命令历史记录的条数;  </div><div class="line">HISTFILE：指定历史文件，默认为~/.bash_history;  </div><div class="line">HISTFILESIZE：命令历史文件记录历史的条数;  </div><div class="line">HISTTIMEFORMAT="%F %T"：显示时间;  </div><div class="line">HISTIGNORE="str1:str2*:…"：忽略str1命令， str2开头的历史;</div></pre></td></tr></table></figure>
<h5 id="五、控制命令历史的记录方式："><a href="#五、控制命令历史的记录方式：" class="headerlink" title="五、控制命令历史的记录方式："></a>五、控制命令历史的记录方式：</h5><p>&emsp;<strong>通过修改环境变量：HISTCONTROL的相关参数来控制历史命令的记录方式：</strong></p>
<p>&emsp;&emsp;&emsp;<strong>HISTCONTROL相关参数：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ignoredups:默认，忽略重复的命令，连续且相同为“重复”  </div><div class="line">ignorespace:忽略所有以空白开头的命令  </div><div class="line">ignoreboth:相当于ignoredups, ignorespace的组合  </div><div class="line">erasedups:删除重复命令 </div><div class="line">``` </div><div class="line">&amp;emsp;&amp;emsp;&amp;emsp;**修改方式：**</div><div class="line">```bash</div><div class="line"><span class="comment">#export HISCONTROL="参数"  </span></div><div class="line">文件存放在 /etc/profile 或 ~/.bash_profile</div></pre></td></tr></table></figure></p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:2501228271@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">WangBinZhou</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
