<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="WangBinZhou" />



<meta name="description" content="简介Linux内核是操作系统的核心，也是操作系统最基本的部分。   Linux内核的体积结构是单内核的、但是他充分采用了微内核的设计思想、使得虽然是单内核、但工作在模块化的方式下、并且这个模块可以动态装载或卸载；Linux负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。如是我们在了解Linux内核的基础上根据自己的需要、量身定制一个更高效，更稳定的内核，就需要我们">
<meta name="keywords" content="Linux, Linux实验">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS7内核编译安装">
<meta property="og:url" content="http://blog.wangbinzhou.com/2017/09/04/CentOS7内核编译安装/index.html">
<meta property="og:site_name" content="WangBinZhou">
<meta property="og:description" content="简介Linux内核是操作系统的核心，也是操作系统最基本的部分。   Linux内核的体积结构是单内核的、但是他充分采用了微内核的设计思想、使得虽然是单内核、但工作在模块化的方式下、并且这个模块可以动态装载或卸载；Linux负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。如是我们在了解Linux内核的基础上根据自己的需要、量身定制一个更高效，更稳定的内核，就需要我们">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/01.png">
<meta property="og:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/02.png">
<meta property="og:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/04.png">
<meta property="og:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/05.png">
<meta property="og:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/06.png">
<meta property="og:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/07.png">
<meta property="og:updated_time" content="2017-09-08T06:52:25.578Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CentOS7内核编译安装">
<meta name="twitter:description" content="简介Linux内核是操作系统的核心，也是操作系统最基本的部分。   Linux内核的体积结构是单内核的、但是他充分采用了微内核的设计思想、使得虽然是单内核、但工作在模块化的方式下、并且这个模块可以动态装载或卸载；Linux负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。如是我们在了解Linux内核的基础上根据自己的需要、量身定制一个更高效，更稳定的内核，就需要我们">
<meta name="twitter:image" content="http://ovnpik36u.bkt.clouddn.com/201709/kernel/01.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="WangBinZhou" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>CentOS7内核编译安装 | WangBinZhou</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?3c05068834beb5df940fd3ca767f2305";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">WangBinZhou</a></h1>
        </hgroup>

        
        <p class="header-subtitle">王彬州</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/随笔">随笔</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:2501228271@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa QQ" href="/2501228271" title="QQ"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Linux实验/">Linux, Linux实验</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux原理/">Linux原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux命令/">Linux命令</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux子系统/">Linux子系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSH/">SSH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Squid-Stunnel-代理上网/">Squid/Stunnel/代理上网</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssh-client/">openssh-client</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sshd/">sshd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yum源和yum仓库/">yum源和yum仓库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.zhyu512.com/">Zhyu512</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.yyclinux.com/">顽媃啊</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.at23.net/">WeiDong.z</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">反应慢半拍的金牛男</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">WangBinZhou</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">WangBinZhou</a></h1>
            </hgroup>
            
            <p class="header-subtitle">王彬州</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/随笔">随笔</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:2501228271@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa QQ" target="_blank" href="/2501228271" title="QQ"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-CentOS7内核编译安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/04/CentOS7内核编译安装/" class="article-date">
      <time datetime="2017-09-04T09:33:55.000Z" itemprop="datePublished">2017-09-04</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CentOS7内核编译安装
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/实验/">实验</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux-Linux实验/">Linux, Linux实验</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>Linux内核是操作系统的核心，也是操作系统最基本的部分。  </p>
<p>Linux内核的体积结构是单内核的、但是他充分采用了微内核的设计思想、使得虽然是单内核、但工作在模块化的方式下、并且这个模块可以动态装载或卸载；Linux负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。如是我们在了解Linux内核的基础上根据自己的需要、量身定制一个更高效，更稳定的内核，就需要我们手动去编译和配置内核里的各项相关的参数和信息了。  </p>
<h5 id="CentOS系统中内核的组成部分"><a href="#CentOS系统中内核的组成部分" class="headerlink" title="CentOS系统中内核的组成部分"></a>CentOS系统中内核的组成部分</h5><ul>
<li>内核核心：<code>vmlinuz-VERSION-RELEASE</code>  </li>
<li>内核对象: 主要是一些硬件驱动文件，一般放置于<code>/lib/modules/VERSION-RELEASE/</code>目录下  </li>
<li><p>辅助文件：<code>ramdisk</code>  </p>
<ul>
<li><code>initrd</code>  </li>
<li><code>initramfs</code>  </li>
</ul>
</li>
</ul>
<h5 id="查看与内核相关的文件"><a href="#查看与内核相关的文件" class="headerlink" title="查看与内核相关的文件"></a>查看与内核相关的文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#rpm -ql kernel</span></div></pre></td></tr></table></figure>
<p>将近3000行的输出…..  </p>
<h4 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h4><ul>
<li><p>OS版本：CentOS Linux release 7.3.1611 (Core)  <em>虚拟机</em>  </p>
<ul>
<li>升级前的内核版本：3.10.0 </li>
<li>要升级到的内核版本：4.12.10  </li>
</ul>
</li>
<li>安装开发包组：<code>yum groupinstall -y &quot;Development Tools&quot;</code>  </li>
<li>硬件配置要求：CPU和Memory配置越高越好，根据自己电脑硬件合理分配；硬盘可用空间不低于10G；<br><em>当前实验环境，我的配置如下：</em>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#lscpu</span></div><div class="line">Architecture:          x86_64</div><div class="line">CPU op-mode(s):        32-bit, 64-bit</div><div class="line">Byte Order:            Little Endian</div><div class="line">CPU(s):                8</div><div class="line">On-line CPU(s) list:   0-7</div><div class="line">Thread(s) per core:    1</div><div class="line">Core(s) per socket:    2</div><div class="line">Socket(s):             4</div><div class="line">NUMA node(s):          1</div><div class="line">Vendor ID:             GenuineIntel</div><div class="line">CPU family:            6</div><div class="line">Model:                 94</div><div class="line">Model name:            Intel(R) Core(TM) i7-6700HQ CPU @ 2.60GHz</div><div class="line">Stepping:              3</div><div class="line">CPU MHz:               2600.010</div><div class="line">BogoMIPS:              5202.00</div><div class="line">Hypervisor vendor:     VMware</div><div class="line">Virtualization <span class="built_in">type</span>:   full</div><div class="line">L1d cache:             32K</div><div class="line">L1i cache:             32K</div><div class="line">L2 cache:              256K</div><div class="line">L3 cache:              6144K</div><div class="line">NUMA node0 CPU(s):     0-7</div><div class="line">[root@CentOS7 ~]<span class="comment">#free -h</span></div><div class="line">              total        used        free      shared  buff/cache   available</div><div class="line">Mem:            11G        195M         11G        8.5M        170M         11G</div><div class="line">Swap:          2.0G          0B        2.0G</div><div class="line">[root@CentOS7 ~]<span class="comment">#df -h</span></div><div class="line">Filesystem      Size  Used Avail Use% Mounted on</div><div class="line">/dev/sda5        50G  2.0G   49G   4% /</div><div class="line">devtmpfs        6.0G     0  6.0G   0% /dev</div><div class="line">tmpfs           6.0G     0  6.0G   0% /dev/shm</div><div class="line">tmpfs           6.0G  8.6M  6.0G   1% /run</div><div class="line">tmpfs           6.0G     0  6.0G   0% /sys/fs/cgroup</div><div class="line">/dev/sda2        50G   64M   50G   1% /app</div><div class="line">/dev/sda1      1014M  132M  883M  13% /boot</div><div class="line">tmpfs           1.2G     0  1.2G   0% /run/user/0</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h4><h5 id="下载内核"><a href="#下载内核" class="headerlink" title="下载内核"></a>下载内核</h5><p>Linux内核的官方网址是<a href="https://www.kernel.org/" target="_blank" rel="external">https://www.kernel.org/</a>，界面做的还是蛮清爽的<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/kernel/01.png" alt="image"><br>在这里，我下载的是2017年8月30日刚发行的稳定版<code>4.12.10</code>的源码<br>在CentOS 7上下载并解压<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download]<span class="comment">#wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.12.10.tar.xz</span></div><div class="line">[root@CentOS7 ~/download]<span class="comment">#tar xvf linux-4.12.10.tar.xz</span></div><div class="line">[root@CentOS7 ~/download]<span class="comment">#ll -h linux-4.12.10.tar.xz </span></div><div class="line">-rw-r--r--. 1 root root 95M Aug 30 16:34 linux-4.12.10.tar.xz</div><div class="line">[root@CentOS7 ~/download]<span class="comment"># cd linux-4.12.10/</span></div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#du -sh</span></div><div class="line">837M    .</div></pre></td></tr></table></figure></p>
<p>解压前只有95M，解压后837M。837M的源码编译后会生成多大的文件呢？所以，<strong>硬盘一定要预留出10G以上的空间</strong>  </p>
<h4 id="内核模块管理"><a href="#内核模块管理" class="headerlink" title="内核模块管理"></a>内核模块管理</h4><p>CentOS已安装的内核模块的记录文件：<code>/boot/config-3.10.0-514.el7.x86_64</code>,随后我们在选择模块功能的时候，可以在这个文件的基础上进行添加或删除，不然整个工作量就太大了。    </p>
<h5 id="内核模块选项的参数说明"><a href="#内核模块选项的参数说明" class="headerlink" title="内核模块选项的参数说明"></a>内核模块选项的参数说明</h5><p>是否启用内核某功能总共有三个参数<br><code>[  ]</code>: 没有启用<br><code>[M]</code>: 将该功能安装在/lib/modules/目录下<br>ss<code>[*]</code>: 将该文件安装在内核文件中  </p>
<h5 id="内核模块管理命令"><a href="#内核模块管理命令" class="headerlink" title="内核模块管理命令"></a>内核模块管理命令</h5><ul>
<li><code>lsmod</code>:显示由核心已经装载的内核模块,显示的内容来自于:/proc/modules文件  </li>
<li><code>modinfo</code>:显示模块的详细描述信息  <ul>
<li><code>-n</code>:只显示模块文件路径  </li>
<li><code>-p</code>:显示模块参数</li>
<li><code>-a</code>:author  </li>
<li><code>-d</code>:description  </li>
<li><code>-l</code>:license  </li>
</ul>
</li>
<li>modprobe命令：装载或卸载内核模块  <ul>
<li>配置文件： /etc/modprobe.conf,/etc/modprobe.d/*.conf  </li>
<li>modprobe [ -C config-file ] [ modulename ] [ moduleparame-ters… ]  </li>
<li>modprobe [ -r ] modulename…  </li>
</ul>
</li>
<li>depmod命令：内核模块依赖关系文件及系统信息映射文件的生成工具  </li>
<li>insmod命令：指定模块文件，不自动解决依赖模块  <ul>
<li>insmod [ filename ] [ module options… ]  </li>
<li>insmod `modinfo –n exportfs`  </li>
<li>lnsmod `modinfo –n xfs`  </li>
</ul>
</li>
<li>rmmod命令：卸载模块  <ul>
<li>rmmod [ modulename ]  </li>
<li>rmmod xfs  </li>
<li>rmmod exportfs  </li>
</ul>
</li>
</ul>
<h4 id="编译安装内核"><a href="#编译安装内核" class="headerlink" title="编译安装内核"></a>编译安装内核</h4><h5 id="设置内核模块参数"><a href="#设置内核模块参数" class="headerlink" title="设置内核模块参数"></a>设置内核模块参数</h5><p>将<code>/boot/config-3.10.0-514.el7.x86_64</code>文件复制到解压后的源码目录中，并改名为<code>config</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#cd /root/download/linux-4.12.10/</span></div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#cp /boot/config-3.10.0-514.el7.x86_64 .config</span></div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#ls -a</span></div><div class="line">.             COPYING        .get_maintainer.ignore  Kconfig      net       usr</div><div class="line">..            CREDITS        .gitattributes          kernel       README    virt</div><div class="line">arch          crypto         .gitignore              lib          samples</div><div class="line">block         Documentation  include                 .mailmap     scripts</div><div class="line">certs         drivers        init                    MAINTAINERS  security</div><div class="line">.cocciconfig  firmware       ipc                     Makefile     sound</div><div class="line">.config       fs             Kbuild                  mm           tools</div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#</span></div></pre></td></tr></table></figure></p>
<p>使用<code>make menuconfig</code>配置内核选项<br>第一次使用会报缺少一些软件包的错误，所以我们需要在安装完Development Tools包组的基础上，根据报错再添加相应的软件包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#make menuconfig</span></div><div class="line"> *** Unable to find the ncurses libraries or the</div><div class="line"> *** required header files.</div><div class="line"> *** <span class="string">'make menuconfig'</span> requires the ncurses libraries.</div><div class="line"> *** </div><div class="line"> *** Install ncurses (ncurses-devel) and try again.</div><div class="line"> *** </div><div class="line">make[1]: *** [scripts/kconfig/dochecklxdialog] Error 1</div><div class="line">make: *** [menuconfig] Error 2</div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#yum install -y ncurses-devel</span></div></pre></td></tr></table></figure></p>
<p>再次执行<code>make menuconfig</code>命令后进入菜单界面，我们可以根据需求添加相应的内核模块：<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/kernel/02.png" alt="image"><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">.config - Linux/x86 4.12.10 Kernel Configuration</div><div class="line">─────────────────────────────────────────────────────────────────────────────────────────</div><div class="line"> ┌────────────────────── Linux/x86 4.12.10 Kernel Configuration ──────────────────────┐</div><div class="line"> │  Arrow keys navigate the menu.  &lt;Enter&gt; selects submenus ---&gt; (or empty submenus   │  </div><div class="line"> │  ----).  Highlighted letters are hotkeys.  Pressing &lt;Y&gt; includes, &lt;N&gt; excludes,    │  </div><div class="line"> │  &lt;M&gt; modularizes features.  Press &lt;Esc&gt;&lt;Esc&gt; to <span class="built_in">exit</span>, &lt;?&gt; <span class="keyword">for</span> Help, &lt;/&gt; <span class="keyword">for</span>        │  </div><div class="line"> │  Search.  Legend: [*] built-in  [ ] excluded  &lt;M&gt; module  &lt; &gt; module capable       │  </div><div class="line"> │ ┌────────────────────────────────────────────────────────────────────────────────┐ │  </div><div class="line"> │ │     [*] 64-bit kernel                                                          │ │  </div><div class="line"> │ │         General setup  ---&gt;                                                    │ │  </div><div class="line"> │ │     [*] Enable loadable module support  ---&gt;                                   │ │  </div><div class="line"> │ │     -*- Enable the block layer  ---&gt;                                           │ │  </div><div class="line"> │ │         Processor <span class="built_in">type</span> and features  ---&gt;                                      │ │  </div><div class="line"> │ │         Power management and ACPI options  ---&gt;                                │ │  </div><div class="line"> │ │         Bus options (PCI etc.)  ---&gt;                                           │ │  </div><div class="line"> │ │         Executable file formats / Emulations  ---&gt;                             │ │  </div><div class="line"> │ │     [*] Networking support  ---&gt;                                               │ │  </div><div class="line"> │ │         Device Drivers  ---&gt;                                                   │ │  </div><div class="line"> │ │         Firmware Drivers  ---&gt;                                                 │ │  </div><div class="line"> │ │         File systems  ---&gt;                                                     │ │  </div><div class="line"> │ │         Kernel hacking  ---&gt;                                                   │ │  </div><div class="line"> │ │         Security options  ---&gt;                                                 │ │  </div><div class="line"> │ │     -*- Cryptographic API  ---&gt;                                                │ │  </div><div class="line"> │ │     [*] Virtualization  ---&gt;                                                   │ │  </div><div class="line"> │ │         Library routines  ---&gt;                                                 │ │  </div><div class="line"> │ │                                                                                │ │  </div><div class="line"> │ │                                                                                │ │  </div><div class="line"> │ │                                                                                │ │  </div><div class="line"> │ └────────────────────────────────────────────────────────────────────────────────┘ │  </div><div class="line"> ├────────────────────────────────────────────────────────────────────────────────────┤  </div><div class="line"> │              &lt;Select&gt;    &lt; Exit &gt;    &lt; Help &gt;    &lt; Save &gt;    &lt; Load &gt;              │  </div><div class="line"> └────────────────────────────────────────────────────────────────────────────────────┘</div></pre></td></tr></table></figure></p>
<p>每行后面带<code>---&gt;</code>标志的，说明里面还包含子菜单 ；<code>[*]</code>表示已选则该功能；<br>使用<code>↑</code>、<code>↓</code>、<code>Tab</code>进行选项切换，使用<code>Enter</code>和<code>Esc</code>进入或退出子菜单，使用<code>Space</code>、<code>M</code>键启用或关闭相应模块；  </p>
<h5 id="make编译"><a href="#make编译" class="headerlink" title="make编译"></a>make编译</h5><p>设置好内核模块后，我们开始使用<code>make</code>开始编译<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#make -j 8</span></div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>-j</code>为指定进行编译时使用的CPU线程数，<code>make -j 8</code>即为使用8线程进行编译。  </p>
</blockquote>
<p>这是一个漫长的等待过程，具体有多漫长需要看你的电脑硬件配置  </p>
<p>整个过程还是蛮耗系统资源的….<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/kernel/04.png" alt="image"><br>如何查看编译进度呢？根据经验，编译完成后整个文件目录大概会占用9-10G的空间，所以，我们可以通过查看编译目录的大小来判断编译进度：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#du -sh</span></div><div class="line">2.6G    .</div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#watch -n 1 "du -sh"</span></div><div class="line">Every 1.0s: du -sh                                                                Mon Sep  4 15:52:45 2017</div><div class="line"></div><div class="line">3.6G    .</div></pre></td></tr></table></figure></p>
<p>因为给虚拟机的配置比较高(主要是消耗CPU，其次是占用内存)，整个过程只花了20分钟的时间就结束了，编译结束后CPU使用率立马就降下去了，但是内存依然居高不下<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/kernel/05.png" alt="image"><br>查看虚拟机内存，发现是<code>buff/cache</code>占用了内存，我们可以强制释放内存<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#free -h</span></div><div class="line">              total        used        free      shared  buff/cache   available</div><div class="line">Mem:            11G        274M        703M        8.5M         10G         11G</div><div class="line">Swap:          2.0G          0B        2.0G</div></pre></td></tr></table></figure></p>
<p>查看编译后的目录大小：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#du -sh</span></div><div class="line">9.8G    .</div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#ls</span></div><div class="line">arch     CREDITS        firmware  ipc      lib          modules.builtin  README    sound       virt</div><div class="line">block    crypto         fs        Kbuild   MAINTAINERS  modules.order    samples   System.map  vmlinux</div><div class="line">certs    Documentation  include   Kconfig  Makefile     Module.symvers   scripts   tools       vmlinux.o</div><div class="line">COPYING  drivers        init      kernel   mm           net              security  usr</div></pre></td></tr></table></figure></p>
<p>总共9.8G的大小，所以编译前一定要预留够10G的空间  </p>
<h5 id="安装模块"><a href="#安装模块" class="headerlink" title="安装模块"></a>安装模块</h5><p>使用<code>make modules_install</code>安装刚才编译好的模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#make modules_install</span></div></pre></td></tr></table></figure></p>
<p>结束后我们可以查看模块安装后新生成的一些目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#ls /lib/modules/</span></div><div class="line">3.10.0-514.el7.x86_64/ 4.12.10-2.0-wbzkernel/</div></pre></td></tr></table></figure></p>
<h5 id="安装内核相关文件"><a href="#安装内核相关文件" class="headerlink" title="安装内核相关文件"></a>安装内核相关文件</h5><p>使用<code>make install</code>命令安装内核相关的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#make install</span></div><div class="line">Makefile:936: <span class="string">"Cannot use CONFIG_STACK_VALIDATION, please install libelf-dev, libelf-devel or elfutils-libelf-devel"</span></div><div class="line">sh ./arch/x86/boot/install.sh 4.12.10-2.0-wbzkernel arch/x86/boot/bzImage \</div><div class="line">        System.map <span class="string">"/boot"</span></div></pre></td></tr></table></figure></p>
<p>提示：启用某些功能需要安装一些软件包，但是安装过程并没有终止，我们可以再安装过程结束后再安装缺少的软件包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#yum install -y libelf-dev libelf-devel elfutils-libelf-devel</span></div></pre></td></tr></table></figure></p>
<p>查看/boot下是否已经生成对应的内核文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#ls /boot/</span></div><div class="line">config-3.10.0-514.el7.x86_64                             symvers-3.10.0-514.el7.x86_64.gz</div><div class="line">grub                                                     System.map</div><div class="line">grub2                                                    System.map-3.10.0-514.el7.x86_64</div><div class="line">initramfs-0-rescue-7f89e611d6c44a58bf1f11373c0319ae.img  System.map-4.12.10-2.0-wbzkernel</div><div class="line">initramfs-3.10.0-514.el7.x86_64.img                      vmlinuz</div><div class="line">initramfs-3.10.0-514.el7.x86_64kdump.img                 vmlinuz-0-rescue-7f89e611d6c44a58bf1f11373c0319ae</div><div class="line">initramfs-4.12.10-2.0-wbzkernel.img                      vmlinuz-3.10.0-514.el7.x86_64</div><div class="line">initrd-plymouth.img                                      vmlinuz-4.12.10-2.0-wbzkernel</div></pre></td></tr></table></figure></p>
<p>可以看到已经生成了对应的新内核文件，接下来我们可以进行重启测试  </p>
<h4 id="重启系统启用新内核"><a href="#重启系统启用新内核" class="headerlink" title="重启系统启用新内核"></a>重启系统启用新内核</h4><p><em>系统启动后，我们可以在启动引导菜单里看到多了我们安装的新内核的选项</em><br><img src="http://ovnpik36u.bkt.clouddn.com/201709/kernel/06.png" alt="image"><br>系统完美的从新内核启动<br><img src="http://ovnpik36u.bkt.clouddn.com/201709/kernel/07.png" alt="image"><br>查看系统启动的时候是否报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~]<span class="comment">#cat /var/log/boot.log </span></div><div class="line">[  OK  ] Started Show Plymouth Boot Screen.</div><div class="line">[  OK  ] Reached target Paths.</div><div class="line">[  OK  ] Reached target Basic System.</div><div class="line">GG[  OK  ] Found device VMware_Virtual_S 5.</div><div class="line">         Starting File System Check on /dev/disk/by-uuid/2b0c8599-2f1f-4f38-94e7-1a9b857a9bb7...</div><div class="line">[  OK  ] Started File System Check on /dev/disk/by-uuid/2b0c8599-2f1f-4f38-94e7-1a9b857a9bb7.</div><div class="line">[  OK  ] Started dracut initqueue hook.</div><div class="line">         Mounting /sysroot...</div><div class="line">[  OK  ] Reached target Remote File Systems (Pre).</div><div class="line">[  OK  ] Reached target Remote File Systems.</div><div class="line">[  OK  ] Mounted /sysroot.</div><div class="line">[  OK  ] Reached target Initrd Root File System.</div><div class="line">         Starting Reload Configuration from the Real Root...</div><div class="line">[  OK  ] Started Reload Configuration from the Real Root.</div><div class="line">[  OK  ] Reached target Initrd File Systems.</div><div class="line">[  OK  ] Reached target Initrd Default Target.</div><div class="line">         Starting dracut pre-pivot and cleanup hook...</div><div class="line">[  OK  ] Started dracut pre-pivot and cleanup hook.</div><div class="line">         Starting Cleaning Up and Shutting Down Daemons...</div><div class="line">         Starting Plymouth switch root service...</div><div class="line">[  OK  ] Stopped target Timers.</div><div class="line">[  OK  ] Stopped Cleaning Up and Shutting Down Daemons.</div><div class="line">[  OK  ] Stopped dracut pre-pivot and cleanup hook.</div><div class="line">         Stopping dracut pre-pivot and cleanup hook...</div><div class="line">[  OK  ] Stopped target Remote File Systems.</div><div class="line">[  OK  ] Stopped target Remote File Systems (Pre).</div><div class="line">[  OK  ] Stopped dracut initqueue hook.</div><div class="line">         Stopping dracut initqueue hook...</div><div class="line">[  OK  ] Stopped target Initrd Default Target.</div><div class="line">[  OK  ] Stopped target Basic System.</div><div class="line">[  OK  ] Stopped target Sockets.</div><div class="line">[  OK  ] Stopped target System Initialization.</div><div class="line">[  OK  ] Stopped udev Coldplug all Devices.</div><div class="line">         Stopping udev Coldplug all Devices...</div><div class="line">[  OK  ] Stopped target Swap.</div><div class="line">         Stopping udev Kernel Device Manager...</div><div class="line">[  OK  ] Stopped target Local File Systems.</div><div class="line">[  OK  ] Stopped Apply Kernel Variables.</div><div class="line">         Stopping Apply Kernel Variables...</div><div class="line">[  OK  ] Stopped target Slices.</div><div class="line">[  OK  ] Stopped target Paths.</div><div class="line">[  OK  ] Stopped udev Kernel Device Manager.</div><div class="line">[  OK  ] Stopped dracut pre-udev hook.</div><div class="line">         Stopping dracut pre-udev hook...</div><div class="line">[  OK  ] Stopped dracut cmdline hook.</div><div class="line">         Stopping dracut cmdline hook...</div><div class="line">[  OK  ] Stopped Create Static Device Nodes <span class="keyword">in</span> /dev.</div><div class="line">         Stopping Create Static Device Nodes <span class="keyword">in</span> /dev...</div><div class="line">[  OK  ] Stopped Create list of required static device nodes <span class="keyword">for</span> the current kernel.</div><div class="line">         Stopping Create list of required static device nodes <span class="keyword">for</span> the current kernel...</div><div class="line">[  OK  ] Closed udev Kernel Socket.</div><div class="line">[  OK  ] Closed udev Control Socket.</div><div class="line">         Starting Cleanup udevd DB...</div><div class="line">[  OK  ] Started Cleanup udevd DB.</div><div class="line">[  OK  ] Reached target Switch Root.</div><div class="line">[  OK  ] Started Plymouth switch root service.</div><div class="line">         Starting Switch Root...</div><div class="line"></div><div class="line">Welcome to CentOS Linux 7 (Core)!</div><div class="line"></div><div class="line">[  OK  ] Stopped Switch Root.</div><div class="line">[  OK  ] Stopped File System Check on Root Device.</div><div class="line">         Stopping File System Check on Root Device...</div><div class="line">[  OK  ] Listening on Delayed Shutdown Socket.</div><div class="line">         Mounting POSIX Message Queue File System...</div><div class="line">[  OK  ] Listening on /dev/initctl Compatibility Named Pipe.</div><div class="line">[  OK  ] Created slice User and Session Slice.</div><div class="line">[  OK  ] Reached target Encrypted Volumes.</div><div class="line">[  OK  ] Stopped Journal Service.</div><div class="line">         Starting Journal Service...</div><div class="line">         Starting Create list of required static device nodes <span class="keyword">for</span> the current kernel...</div><div class="line">         Mounting Debug File System...</div><div class="line">[  OK  ] Listening on udev Kernel Socket.</div><div class="line">[  OK  ] Stopped target Switch Root.</div><div class="line">[  OK  ] Set up automount Arbitrary Executable File Formats File System Automount Point.</div><div class="line">[  OK  ] Listening on udev Control Socket.</div><div class="line">         Starting Apply Kernel Variables...</div><div class="line">[  OK  ] Stopped target Initrd Root File System.</div><div class="line">[  OK  ] Stopped target Initrd File Systems.</div><div class="line">         Starting Remount Root and Kernel File Systems...</div><div class="line">[  OK  ] Reached target Remote File Systems.</div><div class="line">         Mounting Huge Pages File System...</div><div class="line">[  OK  ] Reached target Slices.</div><div class="line">[  OK  ] Created slice system-getty.slice.</div><div class="line">[  OK  ] Started Apply Kernel Variables.</div><div class="line">[  OK  ] Started Create list of required static device nodes <span class="keyword">for</span> the current kernel.</div><div class="line">         Starting Create Static Device Nodes <span class="keyword">in</span> /dev...</div><div class="line">[  OK  ] Mounted Debug File System.</div><div class="line">[  OK  ] Mounted POSIX Message Queue File System.</div><div class="line">[  OK  ] Mounted Huge Pages File System.</div><div class="line">[  OK  ] Started Remount Root and Kernel File Systems.</div><div class="line">         Starting udev Coldplug all Devices...</div><div class="line">         Starting Configure <span class="built_in">read</span>-only root support...</div><div class="line">         Starting Load/Save Random Seed...</div><div class="line">[  OK  ] Started Load/Save Random Seed.</div><div class="line">[  OK  ] Started Journal Service.</div><div class="line">         Starting Flush Journal to Persistent Storage...</div><div class="line">[  OK  ] Started udev Coldplug all Devices.</div><div class="line">[  OK  ] Started Flush Journal to Persistent Storage.</div><div class="line">[  OK  ] Started Configure <span class="built_in">read</span>-only root support.</div><div class="line">[  OK  ] Started Create Static Device Nodes <span class="keyword">in</span> /dev.</div><div class="line">         Starting udev Kernel Device Manager...</div><div class="line">[  OK  ] Reached target Local File Systems (Pre).</div><div class="line">[  OK  ] Started udev Kernel Device Manager.</div><div class="line">GG[  OK  ] Found device VMware_Virtual_S 3.</div><div class="line">         Activating swap /dev/disk/by-uuid/d61fe1ca-a1f2-41c6-a8be-b60ee1e96dac...</div><div class="line">[  OK  ] Activated swap /dev/disk/by-uuid/d61fe1ca-a1f2-41c6-a8be-b60ee1e96dac.</div><div class="line">[  OK  ] Reached target Swap.</div><div class="line">[  OK  ] Found device VMware_Virtual_S 1.</div><div class="line">         Mounting /boot...</div><div class="line">[  OK  ] Found device VMware_Virtual_S 2.</div><div class="line">         Mounting /app...</div><div class="line">[  OK  ] Mounted /app.</div><div class="line">[  OK  ] Mounted /boot.</div><div class="line">[  OK  ] Reached target Local File Systems.</div><div class="line">         Starting Tell Plymouth To Write Out Runtime Data...</div><div class="line">         Starting Import network configuration from initramfs...</div><div class="line">[  OK  ] Started Import network configuration from initramfs.</div><div class="line">         Starting Create Volatile Files and Directories...</div><div class="line">[  OK  ] Started Tell Plymouth To Write Out Runtime Data.</div><div class="line">[  OK  ] Started Create Volatile Files and Directories.</div><div class="line">         Starting Security Auditing Service...</div><div class="line">[  OK  ] Started Security Auditing Service.</div><div class="line">         Starting Update UTMP about System Boot/Shutdown...</div><div class="line">[  OK  ] Started Update UTMP about System Boot/Shutdown.</div><div class="line">[  OK  ] Reached target System Initialization.</div><div class="line">[  OK  ] Reached target Timers.</div><div class="line">[  OK  ] Listening on D-Bus System Message Bus Socket.</div><div class="line">[  OK  ] Reached target Sockets.</div><div class="line">[  OK  ] Reached target Paths.</div><div class="line">[  OK  ] Reached target Basic System.</div><div class="line">         Starting Permit User Sessions...</div><div class="line">[  OK  ] Started D-Bus System Message Bus.</div><div class="line">         Starting D-Bus System Message Bus...</div><div class="line">         Starting Authorization Manager...</div><div class="line">         Starting Dump dmesg to /var/<span class="built_in">log</span>/dmesg...</div><div class="line">[  OK  ] Started ABRT Automated Bug Reporting Tool.</div><div class="line">         Starting ABRT Automated Bug Reporting Tool...</div><div class="line">[  OK  ] Started ABRT kernel <span class="built_in">log</span> watcher.</div><div class="line">         Starting ABRT kernel <span class="built_in">log</span> watcher...</div><div class="line">         Starting Install ABRT coredump hook...</div><div class="line">[  OK  ] Started irqbalance daemon.</div><div class="line">         Starting irqbalance daemon...</div><div class="line">[  OK  ] Started Service <span class="keyword">for</span> virtual machines hosted on VMware.</div><div class="line">         Starting Service <span class="keyword">for</span> virtual machines hosted on VMware...</div><div class="line">         Starting Login Service...</div><div class="line">[  OK  ] Started Permit User Sessions.</div><div class="line">[  OK  ] Started Dump dmesg to /var/<span class="built_in">log</span>/dmesg.</div><div class="line">         Starting Terminate Plymouth Boot Screen...</div><div class="line">         Starting Wait <span class="keyword">for</span> Plymouth Boot Screen to Quit...</div></pre></td></tr></table></figure></p>
<h4 id="后续清理"><a href="#后续清理" class="headerlink" title="后续清理"></a>后续清理</h4><p>编译时生成了将近10G的文件，安装完成之后如果没有特殊用途可以选择清理掉编译生成的文件来释放空间  </p>
<h5 id="清理相关的命令"><a href="#清理相关的命令" class="headerlink" title="清理相关的命令"></a>清理相关的命令</h5><ul>
<li>make clean：清理大多数编译生成的文件，但会保留config文件等  </li>
<li>make mrproper: 清理所有编译生成的文件、 config及某些备份文件  </li>
<li>make distclean： mrproper、 patches以及编辑器备份文件  </li>
</ul>
<h5 id="执行清理操作"><a href="#执行清理操作" class="headerlink" title="执行清理操作"></a>执行清理操作</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#du -sh</span></div><div class="line">9.8G    .</div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#make clean</span></div><div class="line">  CLEAN   .</div><div class="line">  CLEAN   arch/x86/entry/vdso</div><div class="line">  CLEAN   arch/x86/kernel/cpu</div><div class="line">  CLEAN   arch/x86/kernel</div><div class="line">  CLEAN   arch/x86/purgatory</div><div class="line">  CLEAN   arch/x86/realmode/rm</div><div class="line">  CLEAN   arch/x86/lib</div><div class="line">  CLEAN   certs</div><div class="line">  CLEAN   crypto/asymmetric_keys</div><div class="line">  CLEAN   crypto</div><div class="line">  CLEAN   drivers/firmware/efi/libstub</div><div class="line">  CLEAN   drivers/gpu/drm/radeon</div><div class="line">  CLEAN   drivers/scsi/aic7xxx</div><div class="line">  CLEAN   drivers/tty/vt</div><div class="line">  CLEAN   drivers/video/logo</div><div class="line">  CLEAN   firmware</div><div class="line">  CLEAN   kernel/debug/kdb</div><div class="line">  CLEAN   lib/raid6</div><div class="line">  CLEAN   lib</div><div class="line">  CLEAN   security/selinux</div><div class="line">  CLEAN   usr</div><div class="line">  CLEAN   arch/x86/boot/compressed</div><div class="line">  CLEAN   arch/x86/boot</div><div class="line">  CLEAN   arch/x86/tools</div><div class="line">  CLEAN   .tmp_versions</div><div class="line">[root@CentOS7 ~/download/linux-4.12.10]<span class="comment">#du -sh</span></div><div class="line">847M    .</div></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2017/09/04/CentOS7内核编译安装/">CentOS7内核编译安装</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">WangBinZhou</a></p>
        <p><span>发布时间:</span>2017-09-04, 17:33:55</p>
        <p><span>最后更新:</span>2017-09-08, 14:52:25</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2017/09/04/CentOS7内核编译安装/" title="CentOS7内核编译安装">http://blog.wangbinzhou.com/2017/09/04/CentOS7内核编译安装/</a>
            <span class="copy-path" data-clipboard-text="原文: http://blog.wangbinzhou.com/2017/09/04/CentOS7内核编译安装/　　作者: WangBinZhou" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2017/09/08/CentOS7启动流程图-转载/">
                    CentOS7启动流程图--转载
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2017/09/03/CentOS6-9启动系列-启动相关的破坏性实验/">
                    CentOS6.9启动系列--启动相关的破坏性实验
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS系统中内核的组成部分"><span class="toc-number">1.1.</span> <span class="toc-text">CentOS系统中内核的组成部分</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查看与内核相关的文件"><span class="toc-number">1.2.</span> <span class="toc-text">查看与内核相关的文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验环境"><span class="toc-number">2.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#具体操作"><span class="toc-number">3.</span> <span class="toc-text">具体操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#下载内核"><span class="toc-number">3.1.</span> <span class="toc-text">下载内核</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#内核模块管理"><span class="toc-number">4.</span> <span class="toc-text">内核模块管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#内核模块选项的参数说明"><span class="toc-number">4.1.</span> <span class="toc-text">内核模块选项的参数说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#内核模块管理命令"><span class="toc-number">4.2.</span> <span class="toc-text">内核模块管理命令</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编译安装内核"><span class="toc-number">5.</span> <span class="toc-text">编译安装内核</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#设置内核模块参数"><span class="toc-number">5.1.</span> <span class="toc-text">设置内核模块参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#make编译"><span class="toc-number">5.2.</span> <span class="toc-text">make编译</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#安装模块"><span class="toc-number">5.3.</span> <span class="toc-text">安装模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#安装内核相关文件"><span class="toc-number">5.4.</span> <span class="toc-text">安装内核相关文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重启系统启用新内核"><span class="toc-number">6.</span> <span class="toc-text">重启系统启用新内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#后续清理"><span class="toc-number">7.</span> <span class="toc-text">后续清理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#清理相关的命令"><span class="toc-number">7.1.</span> <span class="toc-text">清理相关的命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#执行清理操作"><span class="toc-number">7.2.</span> <span class="toc-text">执行清理操作</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"CentOS7内核编译安装　| WangBinZhou　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2017/09/08/CentOS7启动流程图-转载/" title="上一篇: CentOS7启动流程图--转载">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2017/09/03/CentOS6-9启动系列-启动相关的破坏性实验/" title="下一篇: CentOS6.9启动系列--启动相关的破坏性实验">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/SSH基于密钥的登录认证/">SSH基于密钥的登录认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/13/机器人三定律/">机器人三定律</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/12/Windows10启用Linux子系统/">Windows10启用Linux子系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/08/CentOS7启动流程图-转载/">CentOS7启动流程图--转载</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/04/CentOS7内核编译安装/">CentOS7内核编译安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/CentOS6-9启动系列-启动相关的破坏性实验/">CentOS6.9启动系列--启动相关的破坏性实验</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/03/CentOS6-9启动系列-为Grub设置密码/">CentOS6.9启动系列--为Grub设置密码</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/牛顿第一定律-很有哲理！/">牛顿第一定律--很有哲理！</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/24/Linux常用命令总结-11、Linux计划任务/">Linux常用命令总结-11、Linux计划任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/22/好好敲实验吧，别再瞎折腾了！不做死就不会死！！/">好好敲实验吧，别再瞎折腾了！不做死就不会死！！</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/21/CentOS系列使用Tab命令补全/">CentOS系列使用Tab命令补全</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/CentOS7网卡命名方式详解及修改为传统eth格式/">CentOS7网卡命名方式详解及修改为传统eth格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/10/内网ssh连接速度很慢的解决方案/">内网ssh连接速度很慢的解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/yum仓库搭建和yum源配置/">yum仓库搭建和yum源配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/Linux常用命令总结：10、文件查找之locate和find/">Linux常用命令总结：10、文件查找之locate和find</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/27/使用Squid-Stunnel代理上网/">使用Squid+Stunnel代理上网</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/27/Linux常用命令总结-9、正则表达式/">Linux常用命令总结-9、正则表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-8、vim文本编辑器/">Linux常用命令总结-8、vim文本编辑器</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-7、文本处理工具/">Linux常用命令总结-7、文本处理工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-6、用户组和权限管理/">Linux常用命令总结-6、用户组和权限管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-5、重定向和管道/">Linux常用命令总结-5、重定向和管道</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-4、文件管理类命令/">Linux常用命令总结-4、文件管理类命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-2、文件管理类命令/">Linux常用命令总结-2、文件管理类命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-1、线上查询及帮助命令/">Linux常用命令总结-1、线上查询及帮助命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/25/Linux常用命令总结-目录/">Linux常用命令总结-目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/22/Linux常用命令总结-3、查看命令历史/">Linux常用命令总结-3、查看命令历史</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2017 WangBinZhou
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-106402527-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
             post: ".article-entry a[href], .copyright a[href]", 
            
            
            
            
            
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>